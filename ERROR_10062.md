# üêõ Erreur 10062 (Interaction Expired)

## Qu'est-ce que c'est ?

L'erreur 10062 signifie que Discord a **abandonn√© l'interaction** car le bot n'a pas r√©pondu dans les **3 secondes**.

```
[ERROR] [INTERACTION] Interaction expired (10062)
{
  "commandName": "end",
  "age": 3500,  // > 3000ms = trop lent
  "channelId": "123456789"
}
```

## Pourquoi √ßa arrive ?

### Causes communes :

1. **Discord est lent** - Le serveur Discord met trop de temps √† envoyer l'interaction
2. **Bot surcharg√©** - Trop de commandes en m√™me temps
3. **Node.js lent** - Processus Node.js surcharg√©
4. **R√©seau lent** - Latence r√©seau entre Discord et le bot
5. **V√©rifications lourdes** - Category check ou API calls avant defer

### Le probl√®me sp√©cifique

M√™me si on defer IMM√âDIATEMENT, l'interaction peut d√©j√† √™tre expir√©e si :
- Discord a mis >3s √† l'envoyer au bot
- Le bot a mis >3s √† traiter l'event

## Solutions Impl√©ment√©es

### 1. Continuation apr√®s expiration (v2.0.1+)

La commande `/end` continue maintenant **m√™me si l'interaction expire** :

```javascript
// Tente de defer
const deferSuccess = await checkCategoryAndDefer(interaction);

// Continue QUAND M√äME si √©chec
if (!deferSuccess) {
  logger.warn('Will continue anyway');
}

// Fait le cleanup des channels
await cleanupChannels(...);
```

**R√©sultat** : Les channels sont supprim√©s m√™me si Discord ne r√©pond pas.

### 2. Commande `/force-end`

Commande admin qui **bypass les interactions** compl√®tement :

```
/force-end
/force-end channel-id:123456789
```

- ‚úÖ Fonctionne toujours
- ‚úÖ Peut terminer n'importe quelle partie
- ‚úÖ N√©cessite permissions admin

### 3. Logs d√©taill√©s

Les logs montrent maintenant :
- L'√¢ge de l'interaction (ms)
- Le nom de la commande
- Le user ID et channel ID
- Stack trace si applicable

### 4. Cache optimis√©

`isInGameCategory()` utilise le cache en priorit√© pour √©viter les d√©lais d'API.

## Comment R√©agir

### Si `/end` expire :

**Option 1** : Relance `/end`
```
/end
```
Souvent √ßa marche la deuxi√®me fois.

**Option 2** : Utilise `/force-end` (admin)
```
/force-end
```
Garantit la suppression des channels.

**Option 3** : Utilise `/debug-games` puis `/force-end`
```
/debug-games          # Trouve l'ID du channel
/force-end channel-id:123456789
```

### Si √ßa arrive souvent :

1. **Red√©marre le bot**
   ```bash
   npm start
   ```

2. **V√©rifie la charge CPU**
   - Trop de bots sur la machine ?
   - Node.js surcharg√© ?

3. **V√©rifie la latence r√©seau**
   - Ping Discord
   - Connexion stable ?

4. **R√©duis les v√©rifications**
   - D√©sactive les checks non-essentiels
   - Optimise les fetches Discord

## Pr√©vention

### ‚úÖ Bon Pattern

```javascript
async execute(interaction) {
  // DEFER IMM√âDIATEMENT
  const deferSuccess = await checkCategoryAndDefer(interaction);
  
  // Continue m√™me si √©chec (pour actions critiques)
  if (!deferSuccess) {
    logger.warn('Continuing without reply capability');
  }
  
  // Effectue l'action
  await doCleanup();
  
  // R√©pond SI POSSIBLE
  if (deferSuccess) {
    await interaction.editReply("‚úÖ Done");
  } else {
    logger.info("Action completed but cannot reply");
  }
}
```

### ‚ùå Mauvais Pattern

```javascript
async execute(interaction) {
  // Fait des v√©rifications AVANT defer
  const game = gameManager.games.get(id);
  if (!game) {
    await interaction.reply("No game"); // EXPIRE !
    return;
  }
  
  // Trop tard pour defer
  await interaction.deferReply(); // 10062 !
}
```

## Debug

### Voir l'√¢ge des interactions

Dans les logs :
```json
{
  "age": 3500,  // Millisecondes depuis cr√©ation
  "commandName": "end"
}
```

- **< 1000ms** : Normal, rapide
- **1000-2500ms** : Acceptable mais lent
- **2500-3000ms** : Limite dangereuse
- **> 3000ms** : Expir√©

### Tracer les d√©lais

Ajoute des timers :
```javascript
const timer = logger.startTimer('command-execution');
// ... code ...
timer.end(); // Affiche dur√©e
```

## FAQ

### Q: Pourquoi 3 secondes seulement ?

**R:** Limite impos√©e par Discord. Pas configurableQ: Peut-on rallonger le d√©lai ?

**R:** Non, c'est c√¥t√© Discord.

### Q: Les actions sont-elles perdues ?

**R:** Non ! Depuis v2.0.1, `/end` continue m√™me si expir√©.

### Q: Comment √©viter compl√®tement l'erreur ?

**R:** Impossible de garantir 0 erreur (d√©pend de Discord). Mais :
- Bot sur serveur rapide
- Code optimis√© (defer imm√©diat)
- Fallback en cas d'√©chec

### Q: Les autres commandes ont le probl√®me ?

**R:** Potentiellement oui. On peut appliquer le m√™me pattern de "continuation".

## Ressources

- [INTERACTION_BEST_PRACTICES.md](INTERACTION_BEST_PRACTICES.md)
- [TROUBLESHOOTING.md](TROUBLESHOOTING.md)
- Discord API Docs: https://discord.com/developers/docs/interactions/receiving-and-responding

---

**Version** : 2.0.1  
**Derni√®re mise √† jour** : 2026-02-09
