<%- include('partials/header') %>

<%
  var isAdmin = typeof accessLevel !== 'undefined' && (accessLevel === 'owner' || accessLevel === 'admin');
  var roleEmojis = {
    'Loup-Garou': 'üê∫', 'Loup Blanc': 'üê∫', 'Villageois': 'üë®', 'Voyante': 'üîÆ',
    'Sorci√®re': 'üßô', 'Chasseur': 'üéØ', 'Petite Fille': 'üëß', 'Cupidon': 'üíò',
    'Salvateur': 'üõ°Ô∏è', 'Ancien': 'üë¥', 'Idiot du Village': 'üÉè', 'Voleur': 'üé≠'
  };
  var roleCamps = {
    'Loup-Garou': 'wolf', 'Loup Blanc': 'wolf', 'Villageois': 'village', 'Voyante': 'village',
    'Sorci√®re': 'village', 'Chasseur': 'village', 'Petite Fille': 'village', 'Cupidon': 'village',
    'Salvateur': 'village', 'Ancien': 'village', 'Idiot du Village': 'village', 'Voleur': 'neutral'
  };
  var roleDescKeys = {
    'Loup-Garou': 'role.desc.WEREWOLF', 'Loup Blanc': 'role.desc.WHITE_WOLF',
    'Villageois': 'role.desc.VILLAGER', 'Voyante': 'role.desc.SEER',
    'Sorci√®re': 'role.desc.WITCH', 'Chasseur': 'role.desc.HUNTER',
    'Petite Fille': 'role.desc.PETITE_FILLE', 'Cupidon': 'role.desc.CUPID',
    'Salvateur': 'role.desc.SALVATEUR', 'Ancien': 'role.desc.ANCIEN',
    'Idiot du Village': 'role.desc.IDIOT', 'Voleur': 'role.desc.THIEF'
  };
  var roleDescs = {
    'Loup-Garou': 'D√©vore un villageois chaque nuit', 'Loup Blanc': 'Loup solitaire, d√©vore aussi les loups',
    'Villageois': 'D√©masque les loups par le vote', 'Voyante': 'D√©couvre le r√¥le d\'un joueur chaque nuit',
    'Sorci√®re': 'Potion de vie et potion de mort', 'Chasseur': 'Emporte un joueur en mourant',
    'Petite Fille': 'Espionne les loups la nuit', 'Cupidon': 'Lie deux amoureux au destin commun',
    'Salvateur': 'Prot√®ge un joueur chaque nuit', 'Ancien': 'R√©siste √† la premi√®re attaque des loups',
    'Idiot du Village': 'R√©v√©l√© si vot√©, perd son vote', 'Voleur': '√âchange son r√¥le au d√©but'
  };
  var campLabels = { wolf: 'Loup-Garou', village: 'Village', neutral: 'Neutre' };
  var mandatoryRoles = ['Loup-Garou', 'Villageois'];
  var enabledRoles = (config && config.enabledRoles) || allRoles;
  var classicEnabled = classicRoleNames.filter(function(r) { return enabledRoles.indexOf(r) !== -1 || mandatoryRoles.indexOf(r) !== -1; }).length;
  var premiumEnabled = premiumRoleNames.filter(function(r) { return enabledRoles.indexOf(r) !== -1; }).length;
%>

<!-- Ambient orbs (teal) -->
<div class="gr-ambient">
  <div class="gr-orb gr-orb-1"></div>
  <div class="gr-orb gr-orb-2"></div>
  <div class="gr-orb gr-orb-3"></div>
</div>

<div class="gr-page">

  <!-- ========== HERO ========== -->
  <div class="gr-hero">
    <div class="gr-hero-bg">
      <div class="gr-hero-gradient"></div>
      <div class="gr-hero-dots"></div>
      <div class="gr-hero-scanline"></div>
    </div>
    <div class="gr-hero-inner">
      <div class="gr-hero-left">
        <div class="gr-hero-avatar-wrap">
          <% if (guild && guild.icon) { %>
            <img src="<%= guild.icon %>" alt="" class="gr-hero-avatar">
          <% } else { %>
            <div class="gr-hero-avatar gr-hero-avatar-placeholder">&#128220;</div>
          <% } %>
          <div class="gr-avatar-ring"></div>
          <div class="gr-avatar-ring gr-avatar-ring-lg"></div>
        </div>
        <div class="gr-hero-info">
          <h1 class="gr-hero-title"><span data-i18n="grules.title">R√®gles du jeu</span></h1>
          <p class="gr-hero-subtitle"><%= guild ? guild.name : guildId %></p>
          <div class="gr-hero-tags">
            <span class="gr-hero-tag gr-tag-roles">&#9876;&#65039; <span><span id="gr-hero-roles"><%= classicEnabled + premiumEnabled %></span> <span data-i18n="grules.roles_active">r√¥les actifs</span></span></span>
            <span class="gr-hero-tag gr-tag-players">&#128101; <span><span id="gr-hero-min"><%= config.defaultRules.minPlayers || 5 %></span>‚Äì<span id="gr-hero-max"><%= config.defaultRules.maxPlayers || 10 %></span> <span data-i18n="grules.players_range">joueurs</span></span></span>
            <span class="gr-hero-tag gr-tag-lang"><span id="gr-hero-lang-flag"><%= config.locale === 'fr' ? 'üá´üá∑' : 'üá¨üáß' %></span> <span id="gr-hero-lang-text" data-i18n="grules.current_lang"><%= config.locale === 'fr' ? 'Fran√ßais' : 'English' %></span></span>
            <% if (isPremium) { %>
              <span class="gr-hero-tag gr-tag-premium">&#128081; Premium</span>
            <% } %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== SETTINGS SECTION ========== -->
  <div class="gr-section">
    <div class="gr-section-head">
      <div class="gr-section-icon">&#9881;&#65039;</div>
      <div class="gr-section-meta">
        <h2 data-i18n="grules.settings_title">Param√®tres de partie</h2>
        <p data-i18n="grules.settings_desc">Configuration g√©n√©rale des r√®gles du jeu</p>
      </div>
    </div>
    <div class="gr-settings-grid">

      <!-- Players card -->
      <div class="gr-card">
        <div class="gr-card-head">
          <div class="gr-card-icon gr-ci-teal"><span>&#128101;</span></div>
          <h3 data-i18n="grules.players_title">Joueurs</h3>
        </div>
        <div class="gr-card-body">
          <div class="gr-field">
            <label data-i18n="grules.min_players">Minimum de joueurs</label>
            <div class="gr-field-right">
              <% if (isAdmin) { %>
                <div class="gr-stepper">
                  <button type="button" class="gr-stepper-btn" data-target="rule-min" data-dir="-1">&#8722;</button>
                  <input type="number" id="rule-min" class="gr-stepper-input" min="3" max="6" value="<%= config.defaultRules.minPlayers || 5 %>" readonly>
                  <button type="button" class="gr-stepper-btn" data-target="rule-min" data-dir="1">&#43;</button>
                </div>
              <% } else { %>
                <span class="gr-field-value"><%= config.defaultRules.minPlayers || 5 %></span>
              <% } %>
              <span class="gr-field-hint" data-i18n="grules.min_hint">Entre 3 et 6</span>
            </div>
          </div>
          <div class="gr-divider"></div>
          <div class="gr-field">
            <label data-i18n="grules.max_players">Maximum de joueurs</label>
            <div class="gr-field-right">
              <% if (isAdmin) { %>
                <div class="gr-stepper">
                  <button type="button" class="gr-stepper-btn" data-target="rule-max" data-dir="-1">&#8722;</button>
                  <input type="number" id="rule-max" class="gr-stepper-input" min="5" max="20" value="<%= config.defaultRules.maxPlayers || 10 %>" readonly>
                  <button type="button" class="gr-stepper-btn" data-target="rule-max" data-dir="1">&#43;</button>
                </div>
              <% } else { %>
                <span class="gr-field-value"><%= config.defaultRules.maxPlayers || 10 %></span>
              <% } %>
              <span class="gr-field-hint" data-i18n="grules.max_hint">Entre min et 20</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Win condition card -->
      <div class="gr-card">
        <div class="gr-card-head">
          <div class="gr-card-icon gr-ci-gold"><span>&#127942;</span></div>
          <h3 data-i18n="grules.win_title">Condition de victoire</h3>
        </div>
        <div class="gr-card-body">
          <% if (isAdmin) { %>
            <label class="gr-radio<%= config.wolfWinCondition === 'majority' || !config.wolfWinCondition ? ' active' : '' %>">
              <input type="radio" name="wolfWin" value="majority" <%= config.wolfWinCondition === 'majority' || !config.wolfWinCondition ? 'checked' : '' %>>
              <span class="gr-radio-dot"></span>
              <div class="gr-radio-body">
                <strong data-i18n="grules.majority">Majorit√©</strong>
                <small data-i18n="grules.majority_desc">Loups ‚â• Villageois</small>
              </div>
            </label>
            <label class="gr-radio<%= config.wolfWinCondition === 'elimination' ? ' active' : '' %>">
              <input type="radio" name="wolfWin" value="elimination" <%= config.wolfWinCondition === 'elimination' ? 'checked' : '' %>>
              <span class="gr-radio-dot"></span>
              <div class="gr-radio-body">
                <strong data-i18n="grules.elimination">√âlimination totale</strong>
                <small data-i18n="grules.elimination_desc">Tous les villageois morts</small>
              </div>
            </label>
          <% } else { %>
            <div class="gr-radio active readonly">
              <span class="gr-radio-dot"></span>
              <div class="gr-radio-body">
                <strong><%= config.wolfWinCondition === 'elimination' ? '√âlimination totale' : 'Majorit√©' %></strong>
              </div>
            </div>
          <% } %>
        </div>
      </div>

      <!-- Language card -->
      <div class="gr-card">
        <div class="gr-card-head">
          <div class="gr-card-icon gr-ci-blue"><span>&#127760;</span></div>
          <h3 data-i18n="grules.lang_title">Langue du bot</h3>
        </div>
        <div class="gr-card-body">
          <% if (isAdmin) { %>
            <label class="gr-radio gr-radio-lang<%= config.locale === 'fr' ? ' active' : '' %>">
              <input type="radio" name="locale" value="fr" <%= config.locale === 'fr' ? 'checked' : '' %>>
              <span class="gr-radio-dot"></span>
              <div class="gr-radio-body gr-radio-row">
                <span class="gr-lang-flag">üá´üá∑</span>
                <strong>Fran√ßais</strong>
              </div>
            </label>
            <label class="gr-radio gr-radio-lang<%= config.locale !== 'fr' ? ' active' : '' %>">
              <input type="radio" name="locale" value="en" <%= config.locale !== 'fr' ? 'checked' : '' %>>
              <span class="gr-radio-dot"></span>
              <div class="gr-radio-body gr-radio-row">
                <span class="gr-lang-flag">üá¨üáß</span>
                <strong>English</strong>
              </div>
            </label>
          <% } else { %>
            <div class="gr-radio active readonly">
              <span class="gr-radio-dot"></span>
              <div class="gr-radio-body gr-radio-row">
                <span class="gr-lang-flag"><%= config.locale === 'fr' ? 'üá´üá∑' : 'üá¨üáß' %></span>
                <strong><%= config.locale === 'fr' ? 'Fran√ßais' : 'English' %></strong>
              </div>
            </div>
          <% } %>
        </div>
      </div>

    </div>
  </div>

  <!-- ========== CLASSIC ROLES ========== -->
  <div class="gr-section">
    <div class="gr-section-head">
      <div class="gr-section-icon gr-si-teal">&#9876;&#65039;</div>
      <div class="gr-section-meta">
        <h2 data-i18n="grules.classic_roles">R√¥les Classiques</h2>
        <p data-i18n="grules.classic_roles_desc">R√¥les de base disponibles pour tous les serveurs</p>
      </div>
      <span class="gr-counter"><%= classicEnabled %>/<%= classicRoleNames.length %></span>
    </div>
    <div class="gr-roles-grid">
      <% classicRoleNames.forEach(function(role, i) {
        var isMandatory = mandatoryRoles.indexOf(role) !== -1;
        var isEnabled = enabledRoles.indexOf(role) !== -1 || isMandatory;
        var camp = roleCamps[role] || 'village';
      %>
        <div class="gr-role gr-camp-<%= camp %><%= isEnabled ? ' gr-role-on' : '' %><%= isMandatory ? ' gr-role-mandatory' : '' %>" style="--enter:<%= i %>">
          <div class="gr-role-glow"></div>
          <div class="gr-role-top">
            <div class="gr-role-icon-wrap">
              <span class="gr-role-emoji"><%= roleEmojis[role] || '‚ùì' %></span>
            </div>
            <div class="gr-role-info">
              <span class="gr-role-name"><%= role %></span>
              <span class="gr-role-camp gr-camp-badge-<%= camp %>"><%= campLabels[camp] || 'Village' %></span>
            </div>
            <% if (isAdmin) { %>
              <label class="gr-toggle<%= isMandatory ? ' gr-toggle-locked' : '' %>">
                <input type="checkbox" class="gr-role-toggle" data-role="<%= role %>"
                  <%= isEnabled ? 'checked' : '' %>
                  <%= isMandatory ? 'disabled' : '' %>>
                <span class="gr-toggle-track"></span>
              </label>
            <% } else { %>
              <span class="gr-status-dot <%= isEnabled ? 'on' : 'off' %>"></span>
            <% } %>
          </div>
          <p class="gr-role-desc" data-i18n="<%= roleDescKeys[role] || '' %>"><%= roleDescs[role] || '' %></p>
          <% if (isMandatory) { %>
            <span class="gr-role-badge gr-badge-mandatory" data-i18n="grules.role_mandatory">Obligatoire</span>
          <% } %>
        </div>
      <% }); %>
    </div>
  </div>

  <!-- ========== PREMIUM ROLES ========== -->
  <div class="gr-section gr-section-premium">
    <div class="gr-premium-aura"></div>
    <div class="gr-section-head gr-head-premium">
      <div class="gr-section-icon gr-si-gold">&#9733;</div>
      <div class="gr-section-meta">
        <h2 class="gr-premium-title" data-i18n="grules.premium_roles">R√¥les Premium</h2>
        <p data-i18n="grules.premium_roles_desc">R√¥les exclusifs r√©serv√©s aux membres Premium</p>
      </div>
      <% if (isPremium) { %>
        <span class="gr-premium-status gr-ps-unlocked">
          <% if (premiumTier === 'lifetime') { %>
            &#128081; <span data-i18n="grules.premium_lifetime">Premium Lifetime</span>
          <% } else { %>
            &#128081; <span data-i18n="grules.premium_active">Premium Actif</span>
          <% } %>
        </span>
      <% } else { %>
        <span class="gr-premium-status gr-ps-locked">
          &#128274; <span data-i18n="grules.premium_locked">Premium requis</span>
        </span>
      <% } %>
      <span class="gr-counter gr-counter-premium"><%= premiumEnabled %>/<%= premiumRoleNames.length %></span>
    </div>
    <div class="gr-roles-grid">
      <% premiumRoleNames.forEach(function(role, i) {
        var isEnabled = enabledRoles.indexOf(role) !== -1;
        var camp = roleCamps[role] || 'village';
        var canToggle = isPremium && isAdmin;
      %>
        <div class="gr-role gr-role-premium gr-camp-<%= camp %><%= isEnabled ? ' gr-role-on' : '' %><%= !isPremium ? ' gr-role-locked' : '' %>" style="--enter:<%= i %>">
          <div class="gr-role-glow gr-glow-gold"></div>
          <% if (isPremium) { %>
            <span class="gr-role-badge gr-badge-unlocked">&#10003; <span data-i18n="grules.unlocked">D√©bloqu√©</span></span>
          <% } else { %>
            <span class="gr-role-badge gr-badge-locked">&#128274; Premium</span>
          <% } %>
          <div class="gr-role-top">
            <div class="gr-role-icon-wrap gr-icon-premium">
              <span class="gr-role-emoji"><%= roleEmojis[role] || '‚ùì' %></span>
            </div>
            <div class="gr-role-info">
              <span class="gr-role-name"><%= role %></span>
              <span class="gr-role-camp gr-camp-badge-<%= camp %>"><%= campLabels[camp] || 'Village' %></span>
            </div>
            <% if (canToggle) { %>
              <label class="gr-toggle">
                <input type="checkbox" class="gr-role-toggle" data-role="<%= role %>"
                  <%= isEnabled ? 'checked' : '' %>>
                <span class="gr-toggle-track gr-toggle-gold"></span>
              </label>
            <% } else if (isAdmin && !isPremium) { %>
              <label class="gr-toggle gr-toggle-locked">
                <input type="checkbox" disabled>
                <span class="gr-toggle-track"></span>
                <span class="gr-toggle-lock-icon">&#128274;</span>
              </label>
            <% } else { %>
              <span class="gr-status-dot <%= isEnabled ? 'on' : 'off' %>"></span>
            <% } %>
          </div>
          <p class="gr-role-desc" data-i18n="<%= roleDescKeys[role] || '' %>"><%= roleDescs[role] || '' %></p>
        </div>
      <% }); %>
    </div>
    <% if (!isPremium) { %>
      <div class="gr-premium-cta">
        <div class="gr-premium-cta-glow"></div>
        <div class="gr-premium-cta-icon">&#128081;</div>
        <div class="gr-premium-cta-body">
          <strong data-i18n="grules.premium_cta_title">D√©bloquer les r√¥les Premium</strong>
          <p data-i18n="grules.premium_cta">Passez en Premium pour d√©bloquer tous les r√¥les exclusifs et fonctionnalit√©s avanc√©es.</p>
        </div>
      </div>
    <% } %>
  </div>

  <!-- ========== SETUP STATUS ========== -->
  <div class="gr-section">
    <div class="gr-section-head">
      <div class="gr-section-icon">&#128736;&#65039;</div>
      <div class="gr-section-meta">
        <h2 data-i18n="grules.setup_title">Configuration</h2>
        <p data-i18n="grules.setup_desc">√âtat du setup Discord pour ce serveur</p>
      </div>
    </div>
    <div class="gr-setup-grid">
      <div class="gr-setup-item">
        <span class="gr-setup-dot gr-dot-<%= config.categoryId ? 'ok' : 'warn' %>">
          <%= config.categoryId ? '‚úÖ' : '‚ö†Ô∏è' %>
        </span>
        <div>
          <strong data-i18n="grules.category">Cat√©gorie Discord</strong>
          <small><%= config.categoryId ? 'Configur√©e' : 'Non configur√©e' %></small>
        </div>
      </div>
      <div class="gr-setup-item">
        <span class="gr-setup-dot gr-dot-<%= config.setupComplete ? 'ok' : 'warn' %>">
          <%= config.setupComplete ? '‚úÖ' : '‚ö†Ô∏è' %>
        </span>
        <div>
          <strong data-i18n="grules.setup_status">Statut du setup</strong>
          <small><%= config.setupComplete ? 'Complet' : 'Incomplet ‚Äî utilisez /setup' %></small>
        </div>
      </div>
    </div>
  </div>

  <% if (isAdmin) { %>
  <!-- Sticky Save Bar -->
  <div class="gr-save-bar" id="gr-save-bar">
    <div class="gr-save-inner">
      <span class="gr-save-hint" data-i18n="grules.unsaved">&#9998; Modifications non enregistr√©es</span>
      <div class="gr-save-actions">
        <span class="gr-save-status" id="gr-save-status"></span>
        <button class="gr-save-btn" id="gr-save" data-guild-id="<%= guildId %>">
          &#128190; <span data-i18n="grules.save">Enregistrer</span>
        </button>
      </div>
    </div>
  </div>
  <% } %>

</div>

<% if (isAdmin) { %>
<script>
(function() {
  'use strict';
  var saveBtn = document.getElementById('gr-save');
  var saveBar = document.getElementById('gr-save-bar');
  var statusEl = document.getElementById('gr-save-status');
  if (!saveBtn) return;

  // Move save bar to body so position:fixed works (not broken by ancestor filter/transform)
  if (saveBar && saveBar.parentElement !== document.body) {
    document.body.appendChild(saveBar);
  }

  // --- Snapshot of initial form state ---
  function captureState() {
    var state = {};
    var minEl = document.getElementById('rule-min');
    var maxEl = document.getElementById('rule-max');
    if (minEl) state.min = minEl.value;
    if (maxEl) state.max = maxEl.value;
    var wolfRadio = document.querySelector('input[name="wolfWin"]:checked');
    if (wolfRadio) state.wolfWin = wolfRadio.value;
    var localeRadio = document.querySelector('input[name="locale"]:checked');
    if (localeRadio) state.locale = localeRadio.value;
    var roles = [];
    document.querySelectorAll('.gr-role-toggle').forEach(function(cb) {
      if (cb.checked) roles.push(cb.dataset.role);
    });
    state.roles = roles.join(',');
    return state;
  }

  var initialState = captureState();

  function checkChanges() {
    var current = captureState();
    var changed = current.min !== initialState.min
      || current.max !== initialState.max
      || current.wolfWin !== initialState.wolfWin
      || current.locale !== initialState.locale
      || current.roles !== initialState.roles;
    if (changed) {
      saveBar.classList.add('visible');
    } else {
      saveBar.classList.remove('visible');
    }
    return changed;
  }

  document.querySelectorAll('.gr-radio input[type="radio"]').forEach(function(radio) {
    radio.addEventListener('change', function() {
      var group = radio.closest('.gr-card-body');
      group.querySelectorAll('.gr-radio').forEach(function(opt) { opt.classList.remove('active'); });
      radio.closest('.gr-radio').classList.add('active');
      updateHeroLang();
      checkChanges();
    });
  });

  document.querySelectorAll('.gr-role-toggle').forEach(function(cb) {
    cb.addEventListener('change', function() {
      var card = cb.closest('.gr-role');
      if (card) card.classList.toggle('gr-role-on', cb.checked);
      updateHeroRoles();
      checkChanges();
    });
  });

  /* ‚îÄ‚îÄ Live hero tag updates ‚îÄ‚îÄ */
  function updateHeroPlayers() {
    var minEl = document.getElementById('rule-min');
    var maxEl = document.getElementById('rule-max');
    var heroMin = document.getElementById('gr-hero-min');
    var heroMax = document.getElementById('gr-hero-max');
    if (minEl && heroMin) heroMin.textContent = minEl.value;
    if (maxEl && heroMax) heroMax.textContent = maxEl.value;
  }

  function updateHeroRoles() {
    var count = document.querySelectorAll('.gr-role-toggle:checked').length;
    var el = document.getElementById('gr-hero-roles');
    if (el) el.textContent = count;
  }

  function updateHeroLang() {
    var radio = document.querySelector('input[name="locale"]:checked');
    if (!radio) return;
    var flag = document.getElementById('gr-hero-lang-flag');
    var text = document.getElementById('gr-hero-lang-text');
    if (flag) flag.textContent = radio.value === 'fr' ? 'üá´üá∑' : 'üá¨üáß';
    if (text) text.textContent = radio.value === 'fr' ? 'Fran√ßais' : 'English';
  }

  document.querySelectorAll('.gr-stepper-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var input = document.getElementById(btn.dataset.target);
      if (!input) return;
      var val = parseInt(input.value) || 0;
      var dir = parseInt(btn.dataset.dir) || 0;
      var min = parseInt(input.min) || 0;
      var max = parseInt(input.max) || 99;
      var newVal = Math.max(min, Math.min(max, val + dir));
      if (newVal !== val) { input.value = newVal; }
      updateHeroPlayers();
      checkChanges();
    });
  });

  saveBtn.addEventListener('click', async function() {
    var guildId = saveBtn.dataset.guildId;
    var body = {};

    var minEl = document.getElementById('rule-min');
    var maxEl = document.getElementById('rule-max');
    if (minEl) body.minPlayers = parseInt(minEl.value, 10);
    if (maxEl) body.maxPlayers = parseInt(maxEl.value, 10);

    var wolfRadio = document.querySelector('input[name="wolfWin"]:checked');
    if (wolfRadio) body.wolfWinCondition = wolfRadio.value;
    var localeRadio = document.querySelector('input[name="locale"]:checked');
    if (localeRadio) body.locale = localeRadio.value;

    var roleToggles = document.querySelectorAll('.gr-role-toggle');
    if (roleToggles.length > 0) {
      var enabledRoles = [];
      roleToggles.forEach(function(cb) { if (cb.checked) enabledRoles.push(cb.dataset.role); });
      body.enabledRoles = enabledRoles;
    }

    if (body.minPlayers && (body.minPlayers < 3 || body.minPlayers > 6)) {
      statusEl.textContent = '‚ùå Min doit √™tre entre 3 et 6';
      statusEl.className = 'gr-save-status error'; return;
    }
    if (body.maxPlayers && (body.maxPlayers < (body.minPlayers || 3) || body.maxPlayers > 20)) {
      statusEl.textContent = '‚ùå Max doit √™tre entre min et 20';
      statusEl.className = 'gr-save-status error'; return;
    }

    saveBtn.disabled = true;
    statusEl.textContent = '‚è≥';
    statusEl.className = 'gr-save-status saving';

    try {
      var res = await fetch('/api/config/' + guildId, {
        method: 'PATCH', credentials: 'same-origin',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      if (res.status === 401) { statusEl.textContent = '‚ùå Session expir√©e'; statusEl.className = 'gr-save-status error'; return; }
      var result = await res.json();
      if (result.success) {
        initialState = captureState();
        saveBar.classList.remove('visible');
        statusEl.textContent = '‚úÖ Enregistr√© !';
        statusEl.className = 'gr-save-status success';
        setTimeout(function() { statusEl.textContent = ''; }, 3000);
      } else {
        statusEl.textContent = '‚ùå ' + (result.error || 'Erreur');
        statusEl.className = 'gr-save-status error';
      }
    } catch (err) {
      statusEl.textContent = '‚ùå ' + err.message;
      statusEl.className = 'gr-save-status error';
    } finally { saveBtn.disabled = false; }
  });
})();
</script>
<% } %>

<%- include('partials/footer') %>
