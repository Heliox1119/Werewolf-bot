<%- include('partials/header') %>

<div class="guild-rules-page">

  <% var isAdmin = typeof accessLevel !== 'undefined' && (accessLevel === 'owner' || accessLevel === 'admin'); %>

  <%
    var roleEmojis = {
      'Loup-Garou': 'üê∫', 'Loup Blanc': 'üê∫', 'Villageois': 'üë®', 'Voyante': 'üîÆ',
      'Sorci√®re': 'üßô', 'Chasseur': 'üéØ', 'Petite Fille': 'üëß', 'Cupidon': 'üíò',
      'Salvateur': 'üõ°Ô∏è', 'Ancien': 'üë¥', 'Idiot du Village': 'üÉè', 'Voleur': 'üé≠'
    };
    var roleCamps = {
      'Loup-Garou': 'wolf', 'Loup Blanc': 'wolf', 'Villageois': 'village', 'Voyante': 'village',
      'Sorci√®re': 'village', 'Chasseur': 'village', 'Petite Fille': 'village', 'Cupidon': 'village',
      'Salvateur': 'village', 'Ancien': 'village', 'Idiot du Village': 'village', 'Voleur': 'neutral'
    };
    var roleDescKeys = {
      'Loup-Garou': 'role.desc.WEREWOLF', 'Loup Blanc': 'role.desc.WHITE_WOLF',
      'Villageois': 'role.desc.VILLAGER', 'Voyante': 'role.desc.SEER',
      'Sorci√®re': 'role.desc.WITCH', 'Chasseur': 'role.desc.HUNTER',
      'Petite Fille': 'role.desc.PETITE_FILLE', 'Cupidon': 'role.desc.CUPID',
      'Salvateur': 'role.desc.SALVATEUR', 'Ancien': 'role.desc.ANCIEN',
      'Idiot du Village': 'role.desc.IDIOT', 'Voleur': 'role.desc.THIEF'
    };
    var roleDescs = {
      'Loup-Garou': 'D√©vore un villageois chaque nuit', 'Loup Blanc': 'Loup solitaire, d√©vore aussi les loups',
      'Villageois': 'D√©masque les loups par le vote', 'Voyante': 'D√©couvre le r√¥le d\'un joueur chaque nuit',
      'Sorci√®re': 'Potion de vie et potion de mort', 'Chasseur': 'Emporte un joueur en mourant',
      'Petite Fille': 'Espionne les loups la nuit', 'Cupidon': 'Lie deux amoureux au destin commun',
      'Salvateur': 'Prot√®ge un joueur chaque nuit', 'Ancien': 'R√©siste √† la premi√®re attaque des loups',
      'Idiot du Village': 'R√©v√©l√© si vot√©, perd son vote', 'Voleur': '√âchange son r√¥le au d√©but'
    };
    var campLabels = { wolf: 'Loup-Garou', village: 'Village', neutral: 'Neutre' };
    var campColors = { wolf: 'danger', village: 'success', neutral: 'warning' };
    var mandatoryRoles = ['Loup-Garou', 'Villageois'];
    var enabledRoles = (config && config.enabledRoles) || allRoles;
    var classicEnabled = classicRoleNames.filter(function(r) { return enabledRoles.indexOf(r) !== -1 || mandatoryRoles.indexOf(r) !== -1; }).length;
    var premiumEnabled = premiumRoleNames.filter(function(r) { return enabledRoles.indexOf(r) !== -1; }).length;
  %>

  <!-- Page Banner -->
  <div class="grules-banner">
    <div class="grules-banner-bg"></div>
    <div class="grules-banner-content">
      <% if (guild && guild.icon) { %>
        <img src="<%= guild.icon %>" alt="" class="grules-banner-icon">
      <% } else { %>
        <div class="grules-banner-icon grules-banner-icon-placeholder">&#128220;</div>
      <% } %>
      <div class="grules-banner-info">
        <h1><span data-i18n="grules.title">R√®gles du jeu</span></h1>
        <p class="grules-banner-sub"><%= guild ? guild.name : guildId %></p>
        <div class="grules-banner-stats">
          <span class="grules-banner-stat">
            <span class="grules-banner-stat-value"><%= classicEnabled + premiumEnabled %></span>
            <span data-i18n="grules.roles_active">r√¥les actifs</span>
          </span>
          <span class="grules-banner-stat-sep"></span>
          <span class="grules-banner-stat">
            <span class="grules-banner-stat-value"><%= config.defaultRules.minPlayers || 5 %>‚Äì<%= config.defaultRules.maxPlayers || 10 %></span>
            <span data-i18n="grules.players_range">joueurs</span>
          </span>
          <span class="grules-banner-stat-sep"></span>
          <span class="grules-banner-stat">
            <span class="grules-banner-stat-value"><%= config.locale === 'fr' ? 'üá´üá∑' : 'üá¨üáß' %></span>
            <span data-i18n="grules.current_lang">langue</span>
          </span>
          <% if (isPremium) { %>
            <span class="grules-banner-stat-sep"></span>
            <span class="grules-banner-stat grules-banner-stat-premium">
              <span class="grules-banner-stat-value">&#128081;</span>
              <span>Premium</span>
            </span>
          <% } %>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings Section: 3 cards in a row -->
  <div class="grules-section">
    <div class="grules-section-header">
      <div class="grules-section-icon">&#9881;&#65039;</div>
      <div>
        <h2 data-i18n="grules.settings_title">Param√®tres de partie</h2>
        <p data-i18n="grules.settings_desc">Configuration g√©n√©rale des r√®gles du jeu</p>
      </div>
    </div>
    <div class="grules-settings-grid">

      <!-- Players -->
      <div class="grules-setting-card">
        <div class="grules-setting-icon">&#128101;</div>
        <h3 data-i18n="grules.players_title">Joueurs</h3>
        <div class="grules-setting-fields">
          <div class="grules-setting-field">
            <label data-i18n="grules.min_players">Minimum</label>
            <% if (isAdmin) { %>
              <input type="number" id="rule-min" class="grules-input" min="3" max="6" value="<%= config.defaultRules.minPlayers || 5 %>">
            <% } else { %>
              <span class="grules-setting-value"><%= config.defaultRules.minPlayers || 5 %></span>
            <% } %>
            <span class="grules-setting-hint" data-i18n="grules.min_hint">3 ‚Äì 6</span>
          </div>
          <div class="grules-setting-divider"></div>
          <div class="grules-setting-field">
            <label data-i18n="grules.max_players">Maximum</label>
            <% if (isAdmin) { %>
              <input type="number" id="rule-max" class="grules-input" min="5" max="20" value="<%= config.defaultRules.maxPlayers || 10 %>">
            <% } else { %>
              <span class="grules-setting-value"><%= config.defaultRules.maxPlayers || 10 %></span>
            <% } %>
            <span class="grules-setting-hint" data-i18n="grules.max_hint">min ‚Äì 20</span>
          </div>
        </div>
      </div>

      <!-- Win Condition -->
      <div class="grules-setting-card">
        <div class="grules-setting-icon">&#127942;</div>
        <h3 data-i18n="grules.win_title">Victoire des loups</h3>
        <div class="grules-setting-fields">
          <% if (isAdmin) { %>
            <label class="grules-option<%= config.wolfWinCondition === 'majority' || !config.wolfWinCondition ? ' active' : '' %>">
              <input type="radio" name="wolfWin" value="majority" <%= config.wolfWinCondition === 'majority' || !config.wolfWinCondition ? 'checked' : '' %>>
              <div class="grules-option-content">
                <strong data-i18n="grules.majority">Majorit√©</strong>
                <small data-i18n="grules.majority_desc">Loups ‚â• Villageois</small>
              </div>
            </label>
            <label class="grules-option<%= config.wolfWinCondition === 'elimination' ? ' active' : '' %>">
              <input type="radio" name="wolfWin" value="elimination" <%= config.wolfWinCondition === 'elimination' ? 'checked' : '' %>>
              <div class="grules-option-content">
                <strong data-i18n="grules.elimination">√âlimination totale</strong>
                <small data-i18n="grules.elimination_desc">Tous les villageois morts</small>
              </div>
            </label>
          <% } else { %>
            <div class="grules-option active readonly">
              <div class="grules-option-content">
                <strong><%= config.wolfWinCondition === 'elimination' ? '√âlimination totale' : 'Majorit√©' %></strong>
              </div>
            </div>
          <% } %>
        </div>
      </div>

      <!-- Language -->
      <div class="grules-setting-card">
        <div class="grules-setting-icon">&#127760;</div>
        <h3 data-i18n="grules.lang_title">Langue du bot</h3>
        <div class="grules-setting-fields">
          <% if (isAdmin) { %>
            <label class="grules-option grules-option-lang<%= config.locale === 'fr' ? ' active' : '' %>">
              <input type="radio" name="locale" value="fr" <%= config.locale === 'fr' ? 'checked' : '' %>>
              <div class="grules-option-content">
                <span class="grules-lang-flag">üá´üá∑</span>
                <strong>Fran√ßais</strong>
              </div>
            </label>
            <label class="grules-option grules-option-lang<%= config.locale !== 'fr' ? ' active' : '' %>">
              <input type="radio" name="locale" value="en" <%= config.locale !== 'fr' ? 'checked' : '' %>>
              <div class="grules-option-content">
                <span class="grules-lang-flag">üá¨üáß</span>
                <strong>English</strong>
              </div>
            </label>
          <% } else { %>
            <div class="grules-option active readonly">
              <div class="grules-option-content">
                <span class="grules-lang-flag"><%= config.locale === 'fr' ? 'üá´üá∑' : 'üá¨üáß' %></span>
                <strong><%= config.locale === 'fr' ? 'Fran√ßais' : 'English' %></strong>
              </div>
            </div>
          <% } %>
        </div>
      </div>

    </div>
  </div>

  <!-- Classic Roles Section -->
  <div class="grules-section">
    <div class="grules-section-header">
      <div class="grules-section-icon">&#9876;&#65039;</div>
      <div>
        <h2 data-i18n="grules.classic_roles">R√¥les Classiques</h2>
        <p data-i18n="grules.classic_roles_desc">R√¥les de base disponibles pour tous les serveurs</p>
      </div>
      <span class="grules-section-counter"><%= classicEnabled %>/<%= classicRoleNames.length %></span>
    </div>
    <div class="grules-roles-grid">
      <% classicRoleNames.forEach(function(role) {
        var isMandatory = mandatoryRoles.indexOf(role) !== -1;
        var isEnabled = enabledRoles.indexOf(role) !== -1 || isMandatory;
        var camp = roleCamps[role] || 'village';
      %>
        <div class="grules-role-card camp-<%= camp %><%= isEnabled ? ' enabled' : '' %><%= isMandatory ? ' mandatory' : '' %>">
          <div class="grules-role-card-top">
            <span class="grules-role-emoji"><%= roleEmojis[role] || '‚ùì' %></span>
            <div class="grules-role-info">
              <span class="grules-role-name"><%= role %></span>
              <span class="grules-role-camp-badge camp-<%= camp %>"><%= campLabels[camp] || 'Village' %></span>
            </div>
            <% if (isAdmin) { %>
              <label class="grules-toggle<%= isMandatory ? ' grules-toggle-locked' : '' %>">
                <input type="checkbox" class="grules-role-toggle" data-role="<%= role %>"
                  <%= isEnabled ? 'checked' : '' %>
                  <%= isMandatory ? 'disabled' : '' %>>
                <span class="grules-toggle-slider"></span>
              </label>
            <% } else { %>
              <span class="grules-role-status-dot <%= isEnabled ? 'on' : 'off' %>"></span>
            <% } %>
          </div>
          <p class="grules-role-desc" data-i18n="<%= roleDescKeys[role] || '' %>"><%= roleDescs[role] || '' %></p>
          <% if (isMandatory) { %>
            <span class="grules-role-badge mandatory" data-i18n="grules.role_mandatory">Obligatoire</span>
          <% } %>
        </div>
      <% }); %>
    </div>
  </div>

  <!-- Premium Roles Section -->
  <div class="grules-section grules-section-premium">
    <div class="grules-section-header premium">
      <div class="grules-section-icon premium-icon">&#9733;</div>
      <div>
        <h2 class="grules-premium-title" data-i18n="grules.premium_roles">R√¥les Premium</h2>
        <p data-i18n="grules.premium_roles_desc">R√¥les exclusifs r√©serv√©s aux membres Premium</p>
      </div>
      <% if (isPremium) { %>
        <span class="grules-premium-badge-status unlocked">
          <% if (premiumTier === 'lifetime') { %>
            &#128081; <span data-i18n="grules.premium_lifetime">Premium Lifetime</span>
          <% } else { %>
            &#128081; <span data-i18n="grules.premium_active">Premium Actif</span>
          <% } %>
        </span>
      <% } else { %>
        <span class="grules-premium-badge-status locked">
          &#128274; <span data-i18n="grules.premium_locked">Premium requis</span>
        </span>
      <% } %>
      <span class="grules-section-counter premium-counter"><%= premiumEnabled %>/<%= premiumRoleNames.length %></span>
    </div>
    <div class="grules-roles-grid">
      <% premiumRoleNames.forEach(function(role) {
        var isEnabled = enabledRoles.indexOf(role) !== -1;
        var camp = roleCamps[role] || 'village';
        var canToggle = isPremium && isAdmin;
      %>
        <div class="grules-role-card grules-role-premium camp-<%= camp %><%= isEnabled ? ' enabled' : '' %><%= !isPremium ? ' locked' : '' %>">
          <% if (isPremium) { %>
            <span class="grules-role-badge premium-unlocked">&#10003; <span data-i18n="grules.unlocked">D√©bloqu√©</span></span>
          <% } else { %>
            <span class="grules-role-badge premium-locked">&#128274; Premium</span>
          <% } %>
          <div class="grules-role-card-top">
            <span class="grules-role-emoji"><%= roleEmojis[role] || '‚ùì' %></span>
            <div class="grules-role-info">
              <span class="grules-role-name"><%= role %></span>
              <span class="grules-role-camp-badge camp-<%= camp %>"><%= campLabels[camp] || 'Village' %></span>
            </div>
            <% if (canToggle) { %>
              <label class="grules-toggle">
                <input type="checkbox" class="grules-role-toggle" data-role="<%= role %>"
                  <%= isEnabled ? 'checked' : '' %>>
                <span class="grules-toggle-slider grules-toggle-premium"></span>
              </label>
            <% } else if (isAdmin && !isPremium) { %>
              <label class="grules-toggle grules-toggle-locked">
                <input type="checkbox" disabled>
                <span class="grules-toggle-slider"></span>
                <span class="grules-toggle-lock">&#128274;</span>
              </label>
            <% } else { %>
              <span class="grules-role-status-dot <%= isEnabled ? 'on' : 'off' %>"></span>
            <% } %>
          </div>
          <p class="grules-role-desc" data-i18n="<%= roleDescKeys[role] || '' %>"><%= roleDescs[role] || '' %></p>
        </div>
      <% }); %>
    </div>
    <% if (!isPremium) { %>
      <div class="grules-premium-cta">
        <div class="grules-premium-cta-icon">&#128081;</div>
        <div>
          <strong data-i18n="grules.premium_cta_title">D√©bloquer les r√¥les Premium</strong>
          <p data-i18n="grules.premium_cta">Passez en Premium pour d√©bloquer tous les r√¥les exclusifs et fonctionnalit√©s avanc√©es.</p>
        </div>
      </div>
    <% } %>
  </div>

  <!-- Setup Status -->
  <div class="grules-section">
    <div class="grules-section-header">
      <div class="grules-section-icon">&#128736;&#65039;</div>
      <div>
        <h2 data-i18n="grules.setup_title">Configuration</h2>
        <p data-i18n="grules.setup_desc">√âtat du setup Discord pour ce serveur</p>
      </div>
    </div>
    <div class="grules-setup-grid">
      <div class="grules-setup-item">
        <span class="grules-setup-status grules-status-<%= config.categoryId ? 'ok' : 'warn' %>">
          <%= config.categoryId ? '‚úÖ' : '‚ö†Ô∏è' %>
        </span>
        <div>
          <strong data-i18n="grules.category">Cat√©gorie Discord</strong>
          <small><%= config.categoryId ? 'Configur√©e' : 'Non configur√©e' %></small>
        </div>
      </div>
      <div class="grules-setup-item">
        <span class="grules-setup-status grules-status-<%= config.setupComplete ? 'ok' : 'warn' %>">
          <%= config.setupComplete ? '‚úÖ' : '‚ö†Ô∏è' %>
        </span>
        <div>
          <strong data-i18n="grules.setup_status">Statut du setup</strong>
          <small><%= config.setupComplete ? 'Complet' : 'Incomplet ‚Äî utilisez /setup' %></small>
        </div>
      </div>
    </div>
  </div>

  <% if (isAdmin) { %>
  <!-- Sticky Save Bar -->
  <div class="grules-save-bar" id="grules-save-bar">
    <div class="grules-save-bar-inner">
      <span class="grules-save-hint" data-i18n="grules.unsaved">Modifications non enregistr√©es</span>
      <div class="grules-save-actions">
        <span class="grules-save-status" id="grules-save-status"></span>
        <button class="btn btn-primary grules-save-btn" id="grules-save" data-guild-id="<%= guildId %>">
          &#128190; <span data-i18n="grules.save">Enregistrer</span>
        </button>
      </div>
    </div>
  </div>
  <% } %>
</div>

<% if (isAdmin) { %>
<script>
(function() {
  'use strict';
  var saveBtn = document.getElementById('grules-save');
  var saveBar = document.getElementById('grules-save-bar');
  var statusEl = document.getElementById('grules-save-status');
  if (!saveBtn) return;

  var hasChanges = false;
  function markChanged() {
    if (!hasChanges) {
      hasChanges = true;
      saveBar.classList.add('visible');
    }
  }

  // Radio option visual feedback
  document.querySelectorAll('.grules-option input[type="radio"]').forEach(function(radio) {
    radio.addEventListener('change', function() {
      var group = radio.closest('.grules-setting-fields');
      group.querySelectorAll('.grules-option').forEach(function(opt) { opt.classList.remove('active'); });
      radio.closest('.grules-option').classList.add('active');
      markChanged();
    });
  });

  // Toggle visual feedback
  document.querySelectorAll('.grules-role-toggle').forEach(function(cb) {
    cb.addEventListener('change', function() {
      var card = cb.closest('.grules-role-card');
      if (card) {
        card.classList.toggle('enabled', cb.checked);
      }
      markChanged();
    });
  });

  // Number input changes
  document.querySelectorAll('.grules-input').forEach(function(input) {
    input.addEventListener('change', markChanged);
  });

  saveBtn.addEventListener('click', async function() {
    var guildId = saveBtn.dataset.guildId;
    var body = {};

    var minEl = document.getElementById('rule-min');
    var maxEl = document.getElementById('rule-max');
    if (minEl) body.minPlayers = parseInt(minEl.value, 10);
    if (maxEl) body.maxPlayers = parseInt(maxEl.value, 10);

    var wolfRadio = document.querySelector('input[name="wolfWin"]:checked');
    if (wolfRadio) body.wolfWinCondition = wolfRadio.value;

    var localeRadio = document.querySelector('input[name="locale"]:checked');
    if (localeRadio) body.locale = localeRadio.value;

    var roleToggles = document.querySelectorAll('.grules-role-toggle');
    if (roleToggles.length > 0) {
      var enabledRoles = [];
      roleToggles.forEach(function(cb) {
        if (cb.checked) enabledRoles.push(cb.dataset.role);
      });
      body.enabledRoles = enabledRoles;
    }

    if (body.minPlayers && (body.minPlayers < 3 || body.minPlayers > 6)) {
      statusEl.textContent = '‚ùå Min doit √™tre entre 3 et 6';
      statusEl.className = 'grules-save-status error';
      return;
    }
    if (body.maxPlayers && (body.maxPlayers < (body.minPlayers || 3) || body.maxPlayers > 20)) {
      statusEl.textContent = '‚ùå Max doit √™tre entre min et 20';
      statusEl.className = 'grules-save-status error';
      return;
    }

    saveBtn.disabled = true;
    statusEl.textContent = '‚è≥';
    statusEl.className = 'grules-save-status saving';

    try {
      var res = await fetch('/api/config/' + guildId, {
        method: 'PATCH',
        credentials: 'same-origin',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });

      if (res.status === 401) {
        statusEl.textContent = '‚ùå Session expir√©e';
        statusEl.className = 'grules-save-status error';
        return;
      }

      var result = await res.json();
      if (result.success) {
        hasChanges = false;
        saveBar.classList.remove('visible');
        statusEl.textContent = '‚úÖ Enregistr√© !';
        statusEl.className = 'grules-save-status success';
        setTimeout(function() { statusEl.textContent = ''; }, 3000);
      } else {
        statusEl.textContent = '‚ùå ' + (result.error || 'Erreur');
        statusEl.className = 'grules-save-status error';
      }
    } catch (err) {
      statusEl.textContent = '‚ùå ' + err.message;
      statusEl.className = 'grules-save-status error';
    } finally {
      saveBtn.disabled = false;
    }
  });
})();
</script>
<% } %>

<%- include('partials/footer') %>
