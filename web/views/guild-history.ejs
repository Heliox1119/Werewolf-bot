<%- include('partials/header') %>

<!-- â•â•â• HERO â•â•â• -->
<section class="gh-hero">
  <div class="gh-hero-bg">
    <div class="gh-hero-gradient"></div>
    <div class="gh-hero-dots"></div>
    <div class="gh-hero-scanline"></div>
  </div>
  <div class="gh-hero-inner">
    <div class="gh-hero-left">
      <div class="gh-hero-avatar-wrap">
        <% if (guild && guild.icon) { %>
          <img src="<%= guild.icon %>" alt="<%= guild.name %>" class="gh-hero-avatar">
        <% } else { %>
          <div class="gh-hero-avatar gh-hero-avatar-placeholder">ğŸ“œ</div>
        <% } %>
        <div class="gh-avatar-ring"></div>
        <div class="gh-avatar-ring gh-avatar-ring-lg"></div>
      </div>
      <div class="gh-hero-info">
        <h1 class="gh-hero-title"><%= guild ? guild.name : 'Guild ' + guildId %></h1>
        <p class="gh-hero-subtitle" data-i18n="ghistory.subtitle">Historique &middot; Parties &amp; RÃ©sultats</p>
        <div class="gh-hero-tags">
          <div class="gh-hero-tag gh-tag-games">
            <span>ğŸ“œ</span> <%= history.length %> parties
          </div>
          <% if (guild && guild.memberCount) { %>
            <div class="gh-hero-tag gh-tag-members">
              <span>ğŸ‘¥</span> <%= guild.memberCount %> membres
            </div>
          <% } %>
        </div>
      </div>
    </div>
  </div>
</section>

<% if (history.length === 0) { %>
  <div class="gh-empty">
    <div class="gh-empty-icon">ğŸ“œ</div>
    <p data-i18n="ghistory.empty">Aucune partie terminÃ©e pour le moment.</p>
  </div>
<% } else { %>

  <%
    var totalGames = history.length;
    var villageWins = history.filter(function(h){ return h.winner === 'village'; }).length;
    var wolfWins = history.filter(function(h){ return h.winner === 'wolves'; }).length;
    var loversWins = history.filter(function(h){ return h.winner === 'lovers'; }).length;
    var avgPlayers = totalGames > 0 ? Math.round(history.reduce(function(s, h){ return s + (h.player_count || 0); }, 0) / totalGames) : 0;
    var avgDuration = totalGames > 0 ? Math.round(history.reduce(function(s, h){ return s + (h.duration_seconds || 0); }, 0) / totalGames) : 0;
    var avgMins = Math.floor(avgDuration / 60);
    var avgSecs = avgDuration % 60;
  %>

  <!-- â•â•â• STATS STRIP â•â•â• -->
  <div class="gh-stats" style="animation: panelEnter 0.5s ease-out both; animation-delay: 0.1s;">
    <div class="gh-stat" style="--i:0">
      <div class="gh-stat-icon gh-si-total">ğŸ®</div>
      <div class="gh-stat-data">
        <span class="gh-stat-val"><%= totalGames %></span>
        <span class="gh-stat-label" data-i18n="ghistory.total_games">Parties jouÃ©es</span>
      </div>
    </div>
    <div class="gh-stat" style="--i:1">
      <div class="gh-stat-icon gh-si-village">ğŸ¡</div>
      <div class="gh-stat-data">
        <span class="gh-stat-val"><%= villageWins %></span>
        <span class="gh-stat-label" data-i18n="ghistory.village_wins">Village</span>
      </div>
    </div>
    <div class="gh-stat" style="--i:2">
      <div class="gh-stat-icon gh-si-wolves">ğŸº</div>
      <div class="gh-stat-data">
        <span class="gh-stat-val"><%= wolfWins %></span>
        <span class="gh-stat-label" data-i18n="ghistory.wolf_wins">Loups</span>
      </div>
    </div>
    <div class="gh-stat" style="--i:3">
      <div class="gh-stat-icon gh-si-lovers">ğŸ’•</div>
      <div class="gh-stat-data">
        <span class="gh-stat-val"><%= loversWins %></span>
        <span class="gh-stat-label" data-i18n="ghistory.lovers_wins">Amoureux</span>
      </div>
    </div>
    <div class="gh-stat" style="--i:4">
      <div class="gh-stat-icon gh-si-players">ğŸ‘¥</div>
      <div class="gh-stat-data">
        <span class="gh-stat-val"><%= avgPlayers %></span>
        <span class="gh-stat-label" data-i18n="ghistory.avg_players">Joueurs / partie</span>
      </div>
    </div>
    <div class="gh-stat" style="--i:5">
      <div class="gh-stat-icon gh-si-time">â±ï¸</div>
      <div class="gh-stat-data">
        <span class="gh-stat-val"><%= avgMins %>:<%= avgSecs < 10 ? '0' + avgSecs : avgSecs %></span>
        <span class="gh-stat-label" data-i18n="ghistory.avg_duration">DurÃ©e moy.</span>
      </div>
    </div>
  </div>

  <!-- â•â•â• HISTORY TABLE â•â•â• -->
  <section class="gh-table-panel" style="animation: panelEnter 0.5s ease-out both; animation-delay: 0.25s;">
    <div class="gh-table-header">
      <h2 class="gh-table-title">ğŸ“‹ <span data-i18n="ghistory.recent_games">Parties rÃ©centes</span></h2>
      <span class="gh-table-count"><%= totalGames %> parties</span>
    </div>
    <div class="gh-table-wrap">
      <table class="gh-table">
        <thead>
          <tr>
            <th data-i18n="ghistory.col_date">Date</th>
            <th data-i18n="ghistory.col_winner">Vainqueur</th>
            <th data-i18n="ghistory.col_players">Joueurs</th>
            <th data-i18n="ghistory.col_days">Jours</th>
            <th data-i18n="ghistory.col_duration">DurÃ©e</th>
            <th data-i18n="ghistory.col_details">DÃ©tails</th>
            <% if (accessLevel === 'owner') { %>
              <th class="gh-col-actions"></th>
            <% } %>
          </tr>
        </thead>
        <tbody>
          <% history.forEach(function(h, i) {
            var dur = h.duration_seconds || 0;
            var mins = Math.floor(dur / 60);
            var secs = dur % 60;
            var players = [];
            try { players = JSON.parse(h.players_json || '[]'); } catch(e) {}
            var winnerLabel = h.winner === 'village' ? 'ğŸ¡ Village' : h.winner === 'wolves' ? 'ğŸº Loups-Garous' : h.winner === 'lovers' ? 'ğŸ’• Amoureux' : (h.winner || '?');
            var winnerClass = h.winner === 'village' ? 'gh-w-village' : h.winner === 'wolves' ? 'gh-w-wolves' : h.winner === 'lovers' ? 'gh-w-lovers' : '';
          %>
            <tr class="gh-row" style="animation-delay:<%= 0.3 + i * 0.03 %>s">
              <td class="gh-cell-date">
                <% if (h.ended_at) { %>
                  <span class="gh-date-main"><%= new Date(h.ended_at).toLocaleDateString() %></span>
                  <span class="gh-date-time"><%= new Date(h.ended_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) %></span>
                <% } else { %>
                  â€”
                <% } %>
              </td>
              <td><span class="gh-winner <%= winnerClass %>"><%- winnerLabel %></span></td>
              <td class="gh-cell-num"><%= h.player_count || 0 %></td>
              <td class="gh-cell-num"><%= h.day_count || 0 %></td>
              <td class="gh-cell-num"><%= mins %>:<%= secs < 10 ? '0' + secs : secs %></td>
              <td>
                <button class="gh-detail-btn" data-game-idx="<%= i %>">
                  ğŸ‘ï¸ <span data-i18n="ghistory.btn_details">Voir</span>
                </button>
              </td>
              <% if (accessLevel === 'owner') { %>
                <td class="gh-cell-actions">
                  <button class="gh-delete-btn" data-game-id="<%= h.id %>" title="Supprimer cette partie">
                    ğŸ—‘ï¸ <span>Suppr.</span>
                  </button>
                </td>
              <% } %>
            </tr>
            <tr class="gh-detail-row" id="gh-detail-<%= i %>" style="display:none;">
              <td colspan="<%= accessLevel === 'owner' ? 7 : 6 %>">
                <div class="gh-detail-content">
                  <h4 data-i18n="ghistory.player_list">Liste des joueurs</h4>
                  <div class="gh-player-grid">
                    <% players.forEach(function(p) { %>
                      <div class="gh-player <%= p.alive ? 'gh-survived' : 'gh-died' %>">
                        <span class="gh-player-status"><%- p.alive ? 'â¤ï¸' : 'â˜ ï¸' %></span>
                        <span class="gh-player-name"><%= p.username || p.id %></span>
                        <span class="gh-player-role"><%= p.role || '?' %></span>
                      </div>
                    <% }); %>
                  </div>
                </div>
              </td>
            </tr>
          <% }); %>
        </tbody>
      </table>
    </div>
  </section>

<% } %>

<script>
document.querySelectorAll('.gh-detail-btn').forEach(function(btn) {
  btn.addEventListener('click', function() {
    var idx = this.getAttribute('data-game-idx');
    var row = document.getElementById('gh-detail-' + idx);
    if (row) {
      var isOpen = row.style.display !== 'none';
      row.style.display = isOpen ? 'none' : 'table-row';
      this.classList.toggle('gh-btn-active', !isOpen);
    }
  });
});

/* Owner: delete history entry */
document.querySelectorAll('.gh-delete-btn').forEach(function(btn) {
  btn.addEventListener('click', function() {
    var id = this.getAttribute('data-game-id');
    if (!confirm('Supprimer dÃ©finitivement cette partie de l\'historique ?')) return;
    var row = this.closest('tr');
    var detailRow = row.nextElementSibling;
    fetch('/api/history/' + id, { method: 'DELETE', credentials: 'same-origin' })
      .then(function(r) { return r.json(); })
      .then(function(data) {
        if (data.success) {
          if (detailRow && detailRow.classList.contains('gh-detail-row')) detailRow.remove();
          row.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
          row.style.opacity = '0';
          row.style.transform = 'translateX(20px)';
          setTimeout(function() { row.remove(); }, 300);
        } else {
          alert('Erreur : ' + (data.error || 'Ã‰chec de la suppression'));
        }
      })
      .catch(function() { alert('Erreur rÃ©seau'); });
  });
});
</script>

<%- include('partials/footer') %>
