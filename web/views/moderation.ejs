<%- include('partials/header') %>

<div class="moderation-page">
  <div class="page-header">
    <div>
      <h1>&#128737; Moderation</h1>
      <p class="text-muted">Manage active games on your servers — view roles, control phases, moderate players</p>
    </div>
  </div>

  <% if (games.length === 0) { %>
    <div class="empty-state">
      <span class="empty-icon">&#128737;</span>
      <p>No active games on your servers</p>
      <p class="text-muted">Games you can moderate will appear here in real-time</p>
    </div>
  <% } else { %>
    <!-- Game Selector Tabs -->
    <div class="mod-tabs" id="mod-tabs">
      <% games.forEach(function(g, i) {
        var guildInfo = (typeof guilds !== 'undefined' ? guilds : []).find(function(gl) { return gl.id === g.guildId; });
      %>
        <button class="mod-tab<%= i === 0 ? ' active' : '' %>" data-game="<%= g.gameId %>">
          <span class="game-phase phase-<%= (g.phase || 'lobby').toLowerCase() %>" style="font-size:0.6rem;padding:0.15rem 0.5rem;"><%= g.phase || 'Lobby' %></span>
          <span class="mod-tab-guild">
            <% if (guildInfo && guildInfo.icon) { %>
              <img src="<%= guildInfo.icon %>" alt="" class="mod-tab-guild-img">
            <% } %>
            <span class="mod-tab-guild-name"><%= (guildInfo && guildInfo.name) ? guildInfo.name : g.guildId %></span>
          </span>
          <span class="mod-tab-info"><%= g.players ? g.players.filter(function(p){ return p.alive; }).length : 0 %>/<%= g.players ? g.players.length : 0 %> alive</span>
        </button>
      <% }); %>
    </div>

    <% games.forEach(function(g, i) { %>
      <div class="mod-game-panel<%= i === 0 ? ' active' : '' %>" id="mod-game-<%= g.gameId %>">
        <!-- Top Bar: Phase + Quick Actions -->
        <div class="mod-header">
          <div class="mod-header-info">
            <span class="game-phase phase-<%= (g.phase || 'lobby').toLowerCase() %>"><%= g.phase || 'Lobby' %></span>
            <% if (g.subPhase) { %><span class="game-subphase"><%= g.subPhase %></span><% } %>
            <span class="game-day"><%= g.dayCount ? 'Jour ' + g.dayCount : '' %></span>
            <span class="mod-player-count">&#128101; <%= g.players ? g.players.length : 0 %> joueurs (<%= g.players ? g.players.filter(function(p){ return p.alive; }).length : 0 %> vivants)</span>
          </div>
          <div class="mod-actions">
            <button class="btn btn-sm btn-outline" data-mod-action="skip-phase" data-game-id="<%= g.gameId %>" title="Passer à la phase suivante">
              &#9193; Skip Phase
            </button>
            <button class="btn btn-sm btn-danger" data-mod-action="force-end" data-game-id="<%= g.gameId %>" title="Forcer la fin de la partie">
              &#9724; Force End
            </button>
          </div>
        </div>

        <!-- Players Grid -->
        <div class="mod-content">
          <div class="mod-players-panel">
            <h3 class="panel-title">&#128101; Joueurs</h3>
            <div class="mod-player-list">
              <% if (g.players) { g.players.forEach(function(p) { %>
                <div class="mod-player-card <%= p.alive ? '' : 'dead' %>" data-player-id="<%= p.id %>" data-game-id="<%= g.gameId %>">
                  <div class="mod-player-main">
                    <span class="mod-player-status"><%- p.alive ? '&#10084;&#65039;' : '&#9760;&#65039;' %></span>
                    <div class="mod-player-info">
                      <span class="mod-player-name"><%= p.username %></span>
                      <div class="mod-player-badges">
                        <% if (p.isCaptain) { %><span class="badge badge-captain" title="Capitaine">&#128081;</span><% } %>
                        <% if (p.inLove) { %><span class="badge badge-love" title="Amoureux">&#128149;</span><% } %>
                      </div>
                    </div>
                  </div>
                  <div class="mod-player-meta">
                    <span class="mod-player-role role-tag role-<%= (p.role || '').toLowerCase().replace(/[^a-z]/g, '') %>"><%= p.role || '—' %></span>
                    <% if (p.alive) { %>
                      <button class="btn btn-sm btn-ghost mod-kill-btn" data-mod-action="kill-player" data-game-id="<%= g.gameId %>" data-player-id="<%= p.id %>" title="Éliminer ce joueur">
                        &#9760;
                      </button>
                    <% } %>
                  </div>
                </div>
              <% }); } %>
            </div>
          </div>

          <!-- Action Log -->
          <div class="mod-log-panel">
            <h3 class="panel-title">&#128220; Journal</h3>
            <div class="mod-log" id="mod-log-<%= g.gameId %>">
              <% if (g.actionLog) { g.actionLog.slice(-20).reverse().forEach(function(log) { %>
                <div class="mod-log-entry">
                  <span class="mod-log-time"><%= log.timestamp ? new Date(log.timestamp).toLocaleTimeString() : '' %></span>
                  <span class="mod-log-text"><%= log.action %></span>
                </div>
              <% }); } %>
              <% if (!g.actionLog || g.actionLog.length === 0) { %>
                <p class="text-muted" style="text-align:center;padding:2rem 0;">Aucune action enregistrée</p>
              <% } %>
            </div>

            <!-- Game Info -->
            <div class="mod-game-info">
              <h4 class="panel-subtitle">&#9881; Infos partie</h4>
              <div class="info-grid">
                <div class="info-row"><span class="info-label">Game ID</span><span class="info-value" style="font-size:0.7rem;font-family:monospace;opacity:0.6;"><%= g.gameId %></span></div>
                <div class="info-row"><span class="info-label">Phase</span><span class="info-value"><%= g.phase || 'Lobby' %><%= g.subPhase ? ' / ' + g.subPhase : '' %></span></div>
                <div class="info-row"><span class="info-label">Jour</span><span class="info-value"><%= g.dayCount || 0 %></span></div>
                <div class="info-row"><span class="info-label">Règles</span><span class="info-value"><%= g.rules ? g.rules.minPlayers + '-' + g.rules.maxPlayers + ' joueurs' : '5-10' %></span></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    <% }); %>
  <% } %>
</div>

<!-- Player Modal -->
<div class="modal-overlay" id="player-modal">
  <div class="modal-card">
    <button class="modal-close">&times;</button>
    <div class="modal-header" id="modal-header">
      <div class="modal-player-avatar"><span>&#128100;</span></div>
      <div>
        <h2 id="modal-player-name">Player</h2>
        <div class="modal-badges" id="modal-badges"></div>
      </div>
    </div>
    <div class="modal-body">
      <div class="modal-info-grid" id="modal-info">
        <!-- Filled dynamically -->
      </div>
      <div class="modal-actions" id="modal-actions">
        <!-- Filled dynamically -->
      </div>
    </div>
    <div class="modal-footer">
      <a id="modal-profile-link" href="#" class="btn btn-sm btn-outline">&#128100; Voir profil complet</a>
    </div>
  </div>
</div>

<script src="/static/js/moderation.js"></script>
<script>
// Check API connectivity on page load
(async function() {
  try {
    const res = await fetch('/api/mod/status', { credentials: 'same-origin' });
    const data = await res.json();
    console.log('[MOD] API Status:', data);
    if (!data.authenticated) {
      console.warn('[MOD] NOT AUTHENTICATED — redirecting to login');
      document.body.insertAdjacentHTML('afterbegin',
        '<div style="background:#ef4444;color:white;padding:0.75rem 1.5rem;text-align:center;font-weight:600;position:fixed;top:64px;left:0;right:0;z-index:9999;">' +
        '⚠️ Session expirée — <a href="/auth/discord" style="color:white;text-decoration:underline;">Reconnectez-vous</a> pour utiliser les actions de modération</div>');
    } else {
      console.log('[MOD] Authenticated as:', data.user.username, '— Active games:', data.activeGames, '— IDs:', data.gameIds);
    }
  } catch(e) { console.error('[MOD] Status check failed:', e); }
})();
</script>
<%- include('partials/footer') %>
