<%- include('partials/header') %>

<!-- â•â•â• HERO â•â•â• -->
<section class="gm-hero">
  <div class="gm-hero-bg">
    <div class="gm-hero-gradient"></div>
    <div class="gm-hero-dots"></div>
    <div class="gm-hero-scanline"></div>
  </div>
  <div class="gm-hero-inner">
    <div class="gm-hero-left">
      <div class="gm-hero-avatar-wrap">
        <% if (guild && guild.icon) { %>
          <img src="<%= guild.icon %>" alt="<%= guild.name %>" class="gm-hero-avatar">
        <% } else { %>
          <div class="gm-hero-avatar gm-hero-avatar-placeholder">ğŸ›¡ï¸</div>
        <% } %>
        <div class="gm-avatar-ring"></div>
        <div class="gm-avatar-ring gm-avatar-ring-lg"></div>
      </div>
      <div class="gm-hero-info">
        <h1 class="gm-hero-title"><%= guild ? guild.name : 'Guild ' + guildId %></h1>
        <p class="gm-hero-subtitle" data-i18n="gmod.subtitle">ModÃ©ration &middot; ContrÃ´le des parties</p>
        <div class="gm-hero-tags">
          <div class="gm-hero-tag gm-tag-shield">
            <span>ğŸ›¡ï¸</span> <span data-i18n="gmod.admin_panel">Panneau Admin</span>
          </div>
          <div class="gm-hero-tag gm-tag-games">
            <span>ğŸ®</span> <%= games.length %> <span data-i18n="gmod.active_games">partie<%= games.length !== 1 ? 's' : '' %> active<%= games.length !== 1 ? 's' : '' %></span>
          </div>
          <% if (guild && guild.memberCount) { %>
            <div class="gm-hero-tag gm-tag-members">
              <span>ğŸ‘¥</span> <%= guild.memberCount %> <span data-i18n="goverview.members">membres</span>
            </div>
          <% } %>
        </div>
      </div>
    </div>
  </div>
</section>

<% if (games.length === 0) { %>
  <!-- Empty state -->
  <div class="gm-empty" style="animation: panelEnter 0.5s ease-out both; animation-delay: 0.15s;">
    <div class="gm-empty-visual">
      <span class="gm-empty-icon">ğŸ›¡ï¸</span>
      <div class="gm-empty-glow"></div>
    </div>
    <p class="gm-empty-title" data-i18n="gmod.no_games">Aucune partie en cours sur ce serveur</p>
    <p class="gm-empty-sub" data-i18n="gmod.no_games_hint">Les parties apparaÃ®tront ici en temps rÃ©el</p>
  </div>
<% } else { %>

  <!-- â•â•â• GAME SELECTOR (if >1 game) â•â•â• -->
  <% if (games.length > 1) { %>
  <div class="gm-tabs" id="gm-tabs" style="animation: panelEnter 0.5s ease-out both; animation-delay: 0.1s;">
    <% games.forEach(function(g, i) { %>
      <button class="gm-tab<%= i === 0 ? ' active' : '' %>" data-game="<%= g.gameId %>">
        <span class="game-phase phase-<%= (g.phase || 'lobby').toLowerCase() %>" style="font-size:0.6rem;padding:0.15rem 0.5rem;" data-i18n="<%= g.phase ? 'phase.' + g.phase : 'fb.lobby' %>"><%= g.phase || 'Lobby' %></span>
        <span class="gm-tab-name"<% if (!g.guildName) { %> data-i18n="fb.game"<% } %>><%= g.guildName || 'Partie' %></span>
        <span class="gm-tab-count"><%= g.players ? g.players.filter(function(p){ return p.alive; }).length : 0 %>/<%= g.players ? g.players.length : 0 %></span>
      </button>
    <% }); %>
  </div>
  <% } %>

  <!-- â•â•â• GAME PANELS â•â•â• -->
  <% games.forEach(function(g, i) {
    var alive = g.players ? g.players.filter(function(p){ return p.alive; }).length : 0;
    var dead = g.players ? g.players.filter(function(p){ return !p.alive; }).length : 0;
    var total = g.players ? g.players.length : 0;
  %>
    <div class="gm-game<%= i === 0 ? ' active' : '' %>" id="gm-game-<%= g.gameId %>">

      <!-- â”€â”€ Status bar â”€â”€ -->
      <div class="gm-status-bar" style="animation: panelEnter 0.5s ease-out both; animation-delay: 0.15s;">
        <div class="gm-status-left">
          <span class="game-phase phase-<%= (g.phase || 'lobby').toLowerCase() %>" data-i18n="<%= g.phase ? 'phase.' + g.phase : 'fb.lobby' %>"><%= g.phase || 'Lobby' %></span>
          <% if (g.subPhase) { %><span class="gm-subphase" data-i18n="subphase.<%= g.subPhase %>"><%= g.subPhase %></span><% } %>
          <span class="gm-day"><% if (g.dayCount) { %><span data-i18n="goverview.day_prefix">Jour</span> <%= g.dayCount %><% } %></span>
        </div>
        <div class="gm-status-metrics">
          <div class="gm-status-metric">
            <span class="gm-sm-icon gm-sm-total">ğŸ‘¥</span>
            <span class="gm-sm-val"><%= total %></span>
            <span class="gm-sm-label" data-i18n="gmod.players">joueurs</span>
          </div>
          <div class="gm-status-metric">
            <span class="gm-sm-icon gm-sm-alive">â¤ï¸</span>
            <span class="gm-sm-val"><%= alive %></span>
            <span class="gm-sm-label" data-i18n="gmod.alive">vivants</span>
          </div>
          <div class="gm-status-metric">
            <span class="gm-sm-icon gm-sm-dead">â˜ ï¸</span>
            <span class="gm-sm-val"><%= dead %></span>
            <span class="gm-sm-label" data-i18n="gmod.dead">morts</span>
          </div>
        </div>
        <div class="gm-status-actions">
          <button class="gm-action-btn gm-action-skip" data-mod-action="skip-phase" data-game-id="<%= g.gameId %>" title="Passer Ã  la phase suivante" data-i18n-title="gmod.title_skip_phase">
            â© <span data-i18n="gmod.skip_phase">Passer la phase</span>
          </button>
          <button class="gm-action-btn gm-action-end" data-mod-action="force-end" data-game-id="<%= g.gameId %>" title="Forcer la fin de la partie" data-i18n-title="gmod.title_force_end">
            â¹ï¸ <span data-i18n="gmod.force_end">Forcer la fin</span>
          </button>
        </div>
      </div>

      <!-- â”€â”€ Main Grid â”€â”€ -->
      <div class="gm-grid">
        <!-- Players Panel -->
        <div class="gm-panel gm-panel-players" style="animation: panelEnter 0.6s ease-out both; animation-delay: 0.2s;">
          <div class="gm-panel-header">
            <h3 class="gm-panel-title">ğŸ‘¥ <span data-i18n="gmod.players_list">Joueurs</span></h3>
            <span class="gm-badge-alive"><%= alive %> <span data-i18n="gmod.alive">vivants</span></span>
          </div>
          <div class="gm-player-list">
            <% if (g.players) { g.players.forEach(function(p, pi) { %>
              <div class="gm-player <%= p.alive ? 'gm-p-alive' : 'gm-p-dead' %>" data-player-id="<%= p.id %>" data-game-id="<%= g.gameId %>" style="animation-delay:<%= 0.25 + pi * 0.035 %>s">
                <div class="gm-player-status-dot <%= p.alive ? 'gm-dot-alive' : 'gm-dot-dead' %>"></div>
                <div class="gm-player-info">
                  <span class="gm-player-name"><%= p.username %></span>
                  <div class="gm-player-meta">
                    <span class="gm-player-role"<% if (p.role) { %> data-i18n="role.<%= p.role %>"<% } else { %> data-i18n="fb.no_data"<% } %>><%= p.role || 'â€”' %></span>
                    <% if (p.isCaptain) { %><span class="gm-player-badge gm-badge-captain">ğŸ‘‘</span><% } %>
                    <% if (p.inLove) { %><span class="gm-player-badge gm-badge-love">ğŸ’•</span><% } %>
                  </div>
                </div>
                <div class="gm-player-actions">
                  <% if (p.alive) { %>
                    <button class="gm-kill-btn" data-mod-action="kill-player" data-game-id="<%= g.gameId %>" data-player-id="<%= p.id %>" title="Ã‰liminer" data-i18n-title="gmod.title_eliminate">
                      â˜ ï¸
                    </button>
                  <% } else { %>
                    <span class="gm-eliminated-tag" data-i18n="gmod.eliminated">Ã‰liminÃ©</span>
                  <% } %>
                </div>
              </div>
            <% }); } %>
          </div>
        </div>

        <!-- Right Column -->
        <div class="gm-col-right">
          <!-- Moderation Audit Log -->
          <div class="gm-panel gm-panel-audit" style="animation: panelEnter 0.6s ease-out both; animation-delay: 0.3s;">
            <div class="gm-panel-header">
              <h3 class="gm-panel-title">ğŸ›¡ï¸ <span data-i18n="gmod.audit_title">Historique de modÃ©ration</span></h3>
              <% if (auditLog.length > 0) { %><span class="gm-badge-count"><%= auditLog.length %></span><% } %>
            </div>
            <div class="gm-audit-log" id="gm-audit-log">
              <% if (auditLog.length === 0) { %>
                <div class="gm-log-empty">
                  <span>ğŸ›¡ï¸</span>
                  <p data-i18n="gmod.no_audit">Aucune action de modÃ©ration enregistrÃ©e</p>
                  <p class="text-muted" data-i18n="gmod.no_audit_hint">Les actions d'administration s'afficheront ici de maniÃ¨re permanente</p>
                </div>
              <% } else { %>
                <% auditLog.forEach(function(entry, i) {
                  var icon = entry.action === 'force_end' ? 'â¹ï¸' : entry.action === 'skip_phase' ? 'â©' : entry.action === 'kill_player' ? 'â˜ ï¸' : 'ğŸ“';
                  var details = entry.details || {};
                %>
                  <div class="gm-audit-entry gm-audit-<%= entry.action %>" style="animation-delay:<%= 0.35 + i * 0.04 %>s">
                    <div class="gm-audit-icon"><%= icon %></div>
                    <div class="gm-audit-content">
                      <div class="gm-audit-text">
                        <strong class="gm-audit-mod"><%= entry.moderator_name %></strong>
                        <% if (entry.action === 'force_end') { %>
                          <span data-i18n="gmod.audit_force_end">a forcÃ© la fin de la partie</span>
                          <% if (details.playerCount) { %><span class="gm-audit-detail">(<%= details.playerCount %> <span data-i18n="gmod.players">joueurs</span>)</span><% } %>
                        <% } else if (entry.action === 'skip_phase') { %>
                          <span data-i18n="gmod.audit_skip_phase">a sautÃ© une phase</span>
                          <% if (details.fromPhase) { %><span class="gm-audit-detail">(<%= details.fromPhase %>)</span><% } %>
                        <% } else if (entry.action === 'kill_player') { %>
                          <span data-i18n="gmod.audit_kill_player">a Ã©liminÃ©</span>
                          <% if (details.targetName) { %><strong class="gm-audit-target"><%= details.targetName %></strong><% } %>
                        <% } %>
                      </div>
                      <span class="gm-audit-time pp-date" data-date-format="datetime" data-timestamp="<%= entry.created_at %>"><%= new Date(entry.created_at * 1000).toLocaleString('fr-FR', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' }) %></span>
                    </div>
                  </div>
                <% }); %>
              <% } %>
            </div>
          </div>

          <!-- Game Info -->
          <div class="gm-panel gm-panel-info" style="animation: panelEnter 0.6s ease-out both; animation-delay: 0.4s;">
            <div class="gm-panel-header">
              <h3 class="gm-panel-title">âš™ï¸ <span data-i18n="gmod.game_info">Infos partie</span></h3>
            </div>
            <div class="gm-info-grid">
              <div class="gm-info-row">
                <span class="gm-info-label" data-i18n="gmod.game_id">Game ID</span>
                <span class="gm-info-value gm-info-mono"><%= g.gameId %></span>
              </div>
              <div class="gm-info-row">
                <span class="gm-info-label" data-i18n="gmod.phase">Phase</span>
                <span class="gm-info-value"><span data-i18n="<%= g.phase ? 'phase.' + g.phase : 'fb.lobby' %>"><%= g.phase || 'Lobby' %></span><% if (g.subPhase) { %> / <span data-i18n="subphase.<%= g.subPhase %>"><%= g.subPhase %></span><% } %></span>
              </div>
              <div class="gm-info-row">
                <span class="gm-info-label" data-i18n="gmod.day">Jour</span>
                <span class="gm-info-value"><%= g.dayCount || 0 %></span>
              </div>
              <% if (g.rules) { %>
              <div class="gm-info-row">
                <span class="gm-info-label" data-i18n="gmod.rules">RÃ¨gles</span>
                <span class="gm-info-value"><%= g.rules.minPlayers || 5 %>-<%= g.rules.maxPlayers || 10 %> <span data-i18n="gmod.players">joueurs</span></span>
              </div>
              <% } %>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% }); %>
<% } %>

<!-- Player Modal -->
<div class="modal-overlay" id="player-modal">
  <div class="modal-card modal-card-sm">
    <button class="modal-close">&times;</button>
    <div class="modal-header" id="modal-header">
      <div class="modal-player-avatar"><span>ğŸ‘¤</span></div>
      <div>
        <h2 id="modal-player-name">Player</h2>
        <div class="modal-badges" id="modal-badges"></div>
      </div>
    </div>
    <div class="modal-body">
      <div class="modal-info-grid" id="modal-info"></div>
      <div class="modal-actions" id="modal-actions"></div>
    </div>
    <div class="modal-footer">
      <a id="modal-profile-link" href="#" onclick="return false" class="btn btn-sm btn-primary">ğŸ“ˆ <span data-i18n="gmod.view_profile">Voir profil complet</span></a>
    </div>
  </div>
</div>

<script src="/static/js/moderation.js"></script>
<%- include('partials/footer') %>
