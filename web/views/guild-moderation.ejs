<%- include('partials/header') %>

<div class="guild-mod-page">
  <div class="page-header">
    <% if (guild && guild.icon) { %>
      <img src="<%= guild.icon %>" alt="" class="guild-icon-lg">
    <% } %>
    <div>
      <h1>&#128737; <span data-i18n="gmod.title">Modération</span> — <%= guild ? guild.name : guildId %></h1>
      <p class="text-muted" data-i18n="gmod.subtitle">Gérez les parties actives de ce serveur</p>
    </div>
  </div>

  <% if (games.length === 0) { %>
    <div class="empty-state">
      <span class="empty-icon">&#128737;</span>
      <p data-i18n="gmod.no_games">Aucune partie en cours sur ce serveur</p>
      <p class="text-muted" data-i18n="gmod.no_games_hint">Les parties apparaîtront ici en temps réel</p>
    </div>
  <% } else { %>
    <% games.forEach(function(g, i) { %>
      <div class="gmod-game-card">
        <!-- Game Header -->
        <div class="gmod-game-header">
          <div class="gmod-game-info">
            <span class="game-phase phase-<%= (g.phase || 'lobby').toLowerCase() %>"><%= g.phase || 'Lobby' %></span>
            <% if (g.subPhase) { %><span class="game-subphase"><%= g.subPhase %></span><% } %>
            <span class="game-day"><%= g.dayCount ? 'Jour ' + g.dayCount : '' %></span>
            <span class="gmod-player-count">&#128101; <%= g.players ? g.players.length : 0 %> <span data-i18n="gmod.players">joueurs</span> (<%= g.players ? g.players.filter(function(p){ return p.alive; }).length : 0 %> <span data-i18n="gmod.alive">vivants</span>)</span>
          </div>
          <div class="gmod-actions">
            <button class="btn btn-sm btn-outline" data-mod-action="skip-phase" data-game-id="<%= g.gameId %>" title="Skip Phase">
              &#9193; <span data-i18n="gmod.skip_phase">Passer la phase</span>
            </button>
            <button class="btn btn-sm btn-danger" data-mod-action="force-end" data-game-id="<%= g.gameId %>" title="Force End">
              &#9724; <span data-i18n="gmod.force_end">Forcer la fin</span>
            </button>
          </div>
        </div>

        <!-- Players Grid -->
        <div class="gmod-players">
          <h3 class="panel-title">&#128101; <span data-i18n="gmod.players_list">Joueurs</span></h3>
          <div class="gmod-player-grid">
            <% if (g.players) { g.players.forEach(function(p) { %>
              <div class="gmod-player <%= p.alive ? '' : 'dead' %>" data-player-id="<%= p.id %>" data-game-id="<%= g.gameId %>">
                <div class="gmod-player-left">
                  <span class="gmod-player-status"><%- p.alive ? '&#10084;&#65039;' : '&#9760;&#65039;' %></span>
                  <div>
                    <span class="gmod-player-name"><%= p.username %></span>
                    <span class="gmod-player-role role-tag role-<%= (p.role || '').toLowerCase().replace(/[^a-z]/g, '') %>"><%= p.role || '—' %></span>
                  </div>
                </div>
                <div class="gmod-player-right">
                  <% if (p.isCaptain) { %><span class="badge badge-captain" title="Capitaine">&#128081;</span><% } %>
                  <% if (p.inLove) { %><span class="badge badge-love" title="Amoureux">&#128149;</span><% } %>
                  <% if (p.alive) { %>
                    <button class="btn btn-xs btn-ghost" data-mod-action="kill-player" data-game-id="<%= g.gameId %>" data-player-id="<%= p.id %>" title="Éliminer">&#9760;</button>
                  <% } %>
                </div>
              </div>
            <% }); } %>
          </div>
        </div>

        <!-- Action Log -->
        <div class="gmod-log">
          <h3 class="panel-title">&#128220; <span data-i18n="gmod.log">Journal</span></h3>
          <div class="gmod-log-entries">
            <% if (g.actionLog && g.actionLog.length > 0) { %>
              <% g.actionLog.slice(-15).reverse().forEach(function(log) { %>
                <div class="gmod-log-entry">
                  <span class="gmod-log-time"><%= log.timestamp ? new Date(log.timestamp).toLocaleTimeString() : '' %></span>
                  <span class="gmod-log-text"><%= log.action %></span>
                </div>
              <% }); %>
            <% } else { %>
              <p class="text-muted" style="text-align:center;padding:1rem 0;" data-i18n="gmod.no_logs">Aucunaction enregistrée</p>
            <% } %>
          </div>
        </div>

        <!-- Game Info -->
        <div class="gmod-meta">
          <div class="info-row"><span class="info-label">Game ID</span><span class="info-value" style="font-size:0.7rem;font-family:monospace;opacity:0.6;"><%= g.gameId %></span></div>
          <div class="info-row"><span class="info-label">Phase</span><span class="info-value"><%= g.phase || 'Lobby' %><%= g.subPhase ? ' / ' + g.subPhase : '' %></span></div>
          <div class="info-row"><span class="info-label" data-i18n="gmod.day">Jour</span><span class="info-value"><%= g.dayCount || 0 %></span></div>
        </div>
      </div>
    <% }); %>
  <% } %>
</div>

<!-- Player Modal -->
<div class="modal-overlay" id="player-modal">
  <div class="modal-card">
    <button class="modal-close">&times;</button>
    <div class="modal-header" id="modal-header">
      <div class="modal-player-avatar"><span>&#128100;</span></div>
      <div>
        <h2 id="modal-player-name">Player</h2>
        <div class="modal-badges" id="modal-badges"></div>
      </div>
    </div>
    <div class="modal-body">
      <div class="modal-info-grid" id="modal-info"></div>
      <div class="modal-actions" id="modal-actions"></div>
    </div>
    <div class="modal-footer">
      <a id="modal-profile-link" href="#" class="btn btn-sm btn-outline">&#128100; <span data-i18n="gmod.view_profile">Voir profil</span></a>
    </div>
  </div>
</div>

<script src="/static/js/moderation.js"></script>
<%- include('partials/footer') %>
