<%- include('partials/header') %>
<%
  /* â”€â”€ Helpers â”€â”€ */
  const elo        = player.elo_rating || 1000;
  const eloPeak    = player.elo_peak || elo;
  const gamesPlayed = player.games_played || 0;
  const gamesWon   = player.games_won || 0;
  const winRate    = gamesPlayed > 0 ? Math.round((gamesWon / gamesPlayed) * 100) : 0;
  const tierSlug   = player.tier ? player.tier.nameEn.toLowerCase().replace(/\s+/g, '-') : 'iron';
  const tierName   = player.tier ? player.tier.name : 'Fer';
  const tierEmoji  = player.tier ? player.tier.emoji : 'âš™ï¸';

  /* Achievement names (fr) */
  const achNames = {
    first_win: 'PremiÃ¨re Victoire', veteran: 'VÃ©tÃ©ran', legend: 'LÃ©gende',
    winning_streak_3: 'InarrÃªtable', winning_streak_5: 'Invincible',
    first_blood: 'Premier Sang', alpha_wolf: 'Loup Alpha', serial_killer: 'Tueur en SÃ©rie',
    village_hero: 'HÃ©ros du Village', sherlock: 'Sherlock', guardian_angel: 'Ange Gardien',
    witch_master: 'MaÃ®tre Alchimiste', sharpshooter: "Tireur d'Ã‰lite",
    romeo_juliet: 'RomÃ©o & Juliette', survivor: 'Survivant', immortal: 'Immortel',
    popular: 'Populaire', clown_prince: 'Prince Clown', elder_wisdom: "Sagesse de l'Ancien",
  };

  const achDescs = {
    first_win: 'Remporter votre premiÃ¨re partie',
    veteran: 'Jouer 10 parties', legend: 'Jouer 50 parties',
    winning_streak_3: '3 victoires consÃ©cutives',
    winning_streak_5: '5 victoires consÃ©cutives',
    first_blood: 'PremiÃ¨re Ã©limination en tant que loup',
    alpha_wolf: '10 victoires en tant que loup',
    serial_killer: '25 joueurs Ã©liminÃ©s en tant que loup',
    village_hero: '5 victoires avec le village',
    sherlock: '5 loups trouvÃ©s avec la voyante',
    guardian_angel: '3 joueurs sauvÃ©s avec le salvateur',
    witch_master: '5 joueurs sauvÃ©s avec la sorciÃ¨re',
    sharpshooter: '3 loups tuÃ©s avec le chasseur',
    romeo_juliet: "Victoire en tant qu'amoureux",
    survivor: '5 parties sans mourir', immortal: '10 survies d\'affilÃ©e',
    popular: 'Ã‰lu capitaine 3 fois',
    clown_prince: "Survivre au vote en tant qu'idiot",
    elder_wisdom: "Utiliser la vie supplÃ©mentaire de l'ancien",
  };

  /* Category color map */
  const catColors = {
    victory: '#fbbf24', general: '#a78bfa', wolf: '#ef4444',
    village: '#10b981', special: '#f472b6', social: '#38bdf8',
  };

  const achievements = player.achievements || [];
%>

<!-- â•â•â• HERO BANNER â•â•â• -->
<section class="pp-hero">
  <div class="pp-hero-bg">
    <div class="pp-hero-gradient"></div>
    <div class="pp-hero-dots"></div>
    <div class="pp-hero-scanline"></div>
  </div>
  <div class="pp-hero-inner">
    <!-- Left: Avatar + Identity -->
    <div class="pp-hero-left">
      <div class="pp-avatar-wrap">
        <% if (player.avatarUrl) { %>
          <img src="<%= player.avatarUrl %>" alt="<%= player.username %>" class="pp-avatar-img pp-avatar-<%= tierSlug %>">
        <% } else { %>
          <div class="pp-avatar pp-avatar-<%= tierSlug %>">
            <span class="pp-avatar-letter"><%= (player.username || 'P').charAt(0).toUpperCase() %></span>
          </div>
        <% } %>
        <div class="pp-avatar-ring"></div>
        <div class="pp-avatar-ring pp-avatar-ring-lg"></div>
        <% if (player.rank && player.rank <= 3) { %>
          <span class="pp-rank-crown"><%= player.rank === 1 ? 'ğŸ‘‘' : player.rank === 2 ? 'ğŸ¥ˆ' : 'ğŸ¥‰' %></span>
        <% } %>
      </div>
      <div class="pp-hero-info">
        <h1 class="pp-hero-name"><% if (player.username) { %><%= player.username %><% } else { %><span data-i18n="fb.player">Joueur</span> <%= playerId %><% } %></h1>
        <div class="pp-hero-badges">
          <span class="pp-tier-badge pp-tier-<%= tierSlug %>">
            <span class="pp-tier-emoji"><%= tierEmoji %></span>
            <span class="pp-tier-name" data-i18n="player.tier_<%= tierSlug %>"><%= tierName %></span>
          </span>
          <% if (player.rank) { %>
            <span class="pp-rank-badge"><span data-i18n="player.rank_prefix">Rang</span> #<%= player.rank %></span>
          <% } %>
          <% if (player.achievements && player.achievements.length > 0) { %>
            <span class="pp-ach-count-badge"><%= player.achievements.length %> <span data-i18n="player.achievements_word">succÃ¨s</span></span>
          <% } %>
        </div>
        <div class="pp-hero-sub">
          <span class="pp-sub-item"><span data-i18n="player.member_since">Membre depuis</span> <span class="pp-date" data-timestamp="<%= player.created_at || '' %>" data-date-format="month-year"><%= player.created_at ? new Date(player.created_at * 1000).toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' }) : 'â€”' %></span></span>
        </div>
      </div>
    </div>

    <!-- Right: Key Metrics -->
    <div class="pp-hero-metrics">
      <div class="pp-metric" style="--i:0">
        <div class="pp-metric-icon dm-green">ğŸ®</div>
        <div class="pp-metric-data">
          <span class="pp-metric-val" data-target="<%= gamesPlayed %>">0</span>
          <span class="pp-metric-label" data-i18n="player.games_played">Parties jouÃ©es</span>
        </div>
      </div>
      <div class="pp-metric" style="--i:1">
        <div class="pp-metric-icon dm-blue">ğŸ†</div>
        <div class="pp-metric-data">
          <span class="pp-metric-val" data-target="<%= gamesWon %>">0</span>
          <span class="pp-metric-label" data-i18n="player.wins">Victoires</span>
        </div>
      </div>
      <div class="pp-metric" style="--i:2">
        <div class="pp-metric-icon dm-purple">ğŸ“Š</div>
        <div class="pp-metric-data">
          <span class="pp-metric-val" data-target="<%= elo %>">0</span>
          <span class="pp-metric-label" data-i18n="player.elo_points">Points classement</span>
        </div>
      </div>
      <div class="pp-metric" style="--i:3">
        <div class="pp-metric-icon dm-amber">âš¡</div>
        <div class="pp-metric-data">
          <span class="pp-metric-val pp-metric-pct" data-target="<%= winRate %>">0</span>
          <span class="pp-metric-label" data-i18n="player.win_rate">Taux de victoire</span>
        </div>
      </div>
    </div>
  </div>

  <!-- ELO Progress Bar -->
  <div class="pp-elo-wrap">
    <div class="pp-elo-bar">
      <div class="pp-elo-fill pp-elo-fill-<%= tierSlug %>" style="width:<%= Math.min(100, Math.max(0, ((elo - 100) / 1900) * 100)) %>%"></div>
      <div class="pp-elo-markers">
        <span class="pp-elo-mk" style="left:0%" title="Fer 100" data-i18n-title="player.tier_iron">âš™ï¸</span>
        <span class="pp-elo-mk" style="left:<%= ((800-100)/1900*100).toFixed(1) %>%" title="Bronze 800" data-i18n-title="player.tier_bronze">ğŸ¥‰</span>
        <span class="pp-elo-mk" style="left:<%= ((1000-100)/1900*100).toFixed(1) %>%" title="Argent 1000" data-i18n-title="player.tier_silver">ğŸ¥ˆ</span>
        <span class="pp-elo-mk" style="left:<%= ((1200-100)/1900*100).toFixed(1) %>%" title="Or 1200" data-i18n-title="player.tier_gold">ğŸ¥‡</span>
        <span class="pp-elo-mk" style="left:<%= ((1400-100)/1900*100).toFixed(1) %>%" title="Platine 1400" data-i18n-title="player.tier_platinum">âšœï¸</span>
        <span class="pp-elo-mk" style="left:<%= ((1700-100)/1900*100).toFixed(1) %>%" title="Diamant 1700" data-i18n-title="player.tier_diamond">ğŸ’</span>
        <span class="pp-elo-mk" style="left:100%" title="Alpha 2000" data-i18n-title="player.tier_alpha">ğŸº</span>
      </div>
    </div>
    <div class="pp-elo-info"><span data-i18n="player.elo_pts">Points</span> <strong><%= elo %></strong> Â· <span data-i18n="player.elo_record">Record</span> <strong><%= eloPeak %></strong></div>
  </div>
</section>

<!-- â•â•â• MAIN GRID â•â•â• -->
<div class="pp-grid">
  <!-- â”€â”€ Detailed Stats Panel â”€â”€ -->
  <div class="pp-panel" style="--enter:0">
    <div class="pp-panel-head">
      <div class="pp-panel-title" data-i18n="player.detailed_stats">ğŸ“ˆ Statistiques dÃ©taillÃ©es</div>
    </div>
    <div class="pp-stats-list">
      <div class="pp-stat-row">
        <span class="pp-stat-label" data-i18n="player.stat_peak">Record de points</span>
        <span class="pp-stat-value pp-stat-accent"><%= eloPeak %></span>
      </div>
      <div class="pp-stat-row">
        <span class="pp-stat-label" data-i18n="player.stat_streak">Victoires consÃ©cutives</span>
        <span class="pp-stat-value"><%= player.current_streak || player.win_streak || 0 %></span>
      </div>
      <div class="pp-stat-row">
        <span class="pp-stat-label" data-i18n="player.stat_best_streak">Meilleure sÃ©rie</span>
        <span class="pp-stat-value"><%= player.best_streak || player.best_win_streak || 0 %></span>
      </div>
      <div class="pp-stat-row">
        <span class="pp-stat-label" data-i18n="player.stat_killed_n1">Ã‰liminÃ© nuit 1</span>
        <span class="pp-stat-value"><%= player.killed_night_one || 0 %></span>
      </div>
      <div class="pp-stat-row">
        <span class="pp-stat-label" data-i18n="player.stat_kills">Kills totaux (Loup)</span>
        <span class="pp-stat-value"><%= player.total_kills || player.wolf_kills || 0 %></span>
      </div>
      <div class="pp-stat-row">
        <span class="pp-stat-label" data-i18n="player.stat_survived">Survivances</span>
        <span class="pp-stat-value"><%= player.times_survived || 0 %></span>
      </div>
      <div class="pp-stat-row">
        <span class="pp-stat-label" data-i18n="player.stat_deaths">Ã‰liminations subies</span>
        <span class="pp-stat-value"><%= player.times_killed || 0 %></span>
      </div>
      <% if (player.favorite_role) { %>
      <div class="pp-stat-row">
        <span class="pp-stat-label" data-i18n="player.stat_fav_role">RÃ´le favori</span>
        <span class="pp-stat-value pp-stat-accent"><%= player.favorite_role %></span>
      </div>
      <% } %>
    </div>
  </div>

  <!-- â”€â”€ Role Distribution Panel â”€â”€ -->
  <div class="pp-panel" style="--enter:1">
    <div class="pp-panel-head">
      <div class="pp-panel-title" data-i18n="player.role_distribution">ğŸ­ RÃ©partition des rÃ´les</div>
    </div>
    <%
      const wolfGames    = player.times_werewolf ?? 0;
      const villageGames = player.times_villager ?? 0;
      const seerGames    = player.times_seer ?? 0;
      const witchGames   = player.times_witch ?? 0;
      const roleMax      = Math.max(wolfGames, villageGames, seerGames, witchGames, 1);
    %>
    <div class="pp-role-bars">
      <div class="pp-role-bar-item">
        <div class="pp-role-bar-head">
          <span class="pp-role-bar-icon">ğŸº</span>
          <span class="pp-role-bar-name" data-i18n="player.role_werewolf">Loup-Garou</span>
          <span class="pp-role-bar-count"><%= wolfGames %></span>
        </div>
        <div class="pp-role-bar-track">
          <div class="pp-role-bar-fill pp-bar-wolf" style="width:<%= roleMax > 0 ? (wolfGames / roleMax * 100) : 0 %>%"></div>
        </div>
      </div>
      <div class="pp-role-bar-item">
        <div class="pp-role-bar-head">
          <span class="pp-role-bar-icon">ğŸ‘¤</span>
          <span class="pp-role-bar-name" data-i18n="player.role_villager">Villageois</span>
          <span class="pp-role-bar-count"><%= villageGames %></span>
        </div>
        <div class="pp-role-bar-track">
          <div class="pp-role-bar-fill pp-bar-village" style="width:<%= roleMax > 0 ? (villageGames / roleMax * 100) : 0 %>%"></div>
        </div>
      </div>
      <div class="pp-role-bar-item">
        <div class="pp-role-bar-head">
          <span class="pp-role-bar-icon">ğŸ”®</span>
          <span class="pp-role-bar-name" data-i18n="player.role_seer">Voyante</span>
          <span class="pp-role-bar-count"><%= seerGames %></span>
        </div>
        <div class="pp-role-bar-track">
          <div class="pp-role-bar-fill pp-bar-seer" style="width:<%= roleMax > 0 ? (seerGames / roleMax * 100) : 0 %>%"></div>
        </div>
      </div>
      <div class="pp-role-bar-item">
        <div class="pp-role-bar-head">
          <span class="pp-role-bar-icon">ğŸ§ª</span>
          <span class="pp-role-bar-name" data-i18n="player.role_witch">SorciÃ¨re</span>
          <span class="pp-role-bar-count"><%= witchGames %></span>
        </div>
        <div class="pp-role-bar-track">
          <div class="pp-role-bar-fill pp-bar-witch" style="width:<%= roleMax > 0 ? (witchGames / roleMax * 100) : 0 %>%"></div>
        </div>
      </div>
    </div>

    <!-- Win comparison -->
    <div class="pp-win-compare">
      <div class="pp-win-side pp-win-wolves">
        <span class="pp-win-val"><%= player.wolf_wins || 0 %></span>
        <span class="pp-win-lbl" data-i18n="player.wolf_wins">ğŸº Victoires Loup</span>
      </div>
      <div class="pp-win-vs">VS</div>
      <div class="pp-win-side pp-win-village">
        <span class="pp-win-val"><%= player.village_wins || 0 %></span>
        <span class="pp-win-lbl" data-i18n="player.village_wins">ğŸ›¡ï¸ Victoires Village</span>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â• ACHIEVEMENTS â•â•â• -->
<section class="pp-ach-section">
  <div class="pp-panel pp-panel-wide" style="--enter:2">
    <div class="pp-panel-head">
      <div class="pp-panel-title" data-i18n="player.achievements_title">ğŸ… SuccÃ¨s</div>
      <span class="pp-badge-count"><%= achievements.length %> / <%= Object.keys(typeof allAchievements !== 'undefined' ? allAchievements : {}).length %></span>
    </div>

    <%
      const allAch = typeof allAchievements !== 'undefined' ? allAchievements : {};
      const unlockedSet = new Set(achievements.map(a => a.achievement_id));
      const unlockedMap = {};
      achievements.forEach(a => { unlockedMap[a.achievement_id] = a; });

      /* Build merged list: unlocked first, then locked */
      const achList = [];
      Object.entries(allAch).forEach(function([key, def]) {
        const unlocked = unlockedMap[key];
        if (unlocked) {
          achList.unshift({ ...def, unlocked: true, unlocked_at: unlocked.unlocked_at });
        } else {
          /* Compute progress from player stats */
          let current = 0;
          const stat = def.stat;
          if (stat === 'games_won') current = player.games_won || 0;
          else if (stat === 'games_played') current = player.games_played || 0;
          else if (stat === 'times_survived') current = player.times_survived || 0;
          else if (player[stat] !== undefined) current = player[stat];
          achList.push({ ...def, unlocked: false, current: current });
        }
      });
    %>

    <div class="pp-ach-grid">
      <% achList.forEach(function(a) {
        const color = catColors[a.category] || '#a78bfa';
        const pct = !a.unlocked && a.threshold > 1 ? Math.min(100, Math.round((a.current / a.threshold) * 100)) : 0;
      %>
        <div class="pp-ach-card <%= a.unlocked ? 'pp-ach-unlocked' : 'pp-ach-locked' %>" style="--ach-color:<%= color %>">
          <% if (a.unlocked) { %><div class="pp-ach-card-glow"></div><% } %>
          <div class="pp-ach-emoji <%= a.unlocked ? '' : 'pp-ach-emoji-locked' %>"><%= a.emoji || 'ğŸ…' %><% if (!a.unlocked) { %><span class="pp-ach-lock">ğŸ”’</span><% } %></div>
          <div class="pp-ach-body">
            <span class="pp-ach-name" data-i18n="ach.name.<%= a.id %>"><%= achNames[a.id] || a.id %></span>
            <span class="pp-ach-desc" data-i18n="ach.desc.<%= a.id %>"><%= achDescs[a.id] || '' %></span>
            <% if (a.unlocked) { %>
              <span class="pp-ach-date"><span data-i18n="player.unlocked_on">DÃ©bloquÃ© le</span> <span class="pp-date" data-timestamp="<%= a.unlocked_at || '' %>" data-date-format="full"><%= a.unlocked_at ? new Date(a.unlocked_at * 1000).toLocaleDateString('fr-FR') : '' %></span></span>
            <% } else if (a.threshold > 1) { %>
              <div class="pp-ach-bar-wrap">
                <div class="pp-ach-bar">
                  <div class="pp-ach-bar-fill" style="width:<%= pct %>%"></div>
                </div>
                <span class="pp-ach-bar-text"><%= a.current %>/<%= a.threshold %></span>
              </div>
            <% } else { %>
              <span class="pp-ach-locked-hint" data-i18n="player.locked_hint">ğŸ”’ Non dÃ©bloquÃ©</span>
            <% } %>
          </div>
        </div>
      <% }); %>
    </div>
  </div>
</section>

<script src="/static/js/player.js"></script>
<%- include('partials/footer') %>
