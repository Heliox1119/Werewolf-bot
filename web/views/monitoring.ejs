<%- include('partials/header') %>

<%
  var level = typeof accessLevel !== 'undefined' ? accessLevel : 'public';
  var isOwner = level === 'owner';
  var isAdmin = level === 'owner' || level === 'admin';
  var isMember = level !== 'public';
%>

<div class="monitoring-page">
  <div class="page-header">
    <div>
      <h1 data-i18n="mon.title">&#128202; Monitoring</h1>
      <p class="text-muted" data-i18n="mon.subtitle">Surveillance en temps rÃ©el du bot â€” MÃ©triques systÃ¨me, Discord et jeu</p>
    </div>
    <div class="monitoring-controls">
      <% if (isMember) { %>
        <span class="access-badge access-<%= level %>"><%= level === 'owner' ? 'ðŸ‘‘ Owner' : level === 'admin' ? 'ðŸ›¡ï¸ Admin' : 'ðŸ‘¤ Member' %></span>
      <% } %>
      <span class="monitoring-auto-refresh text-muted" data-i18n="mon.auto_refresh">Actualisation auto toutes les 30s</span>
      <button class="btn btn-sm btn-outline" id="mon-refresh-btn" data-i18n="mon.refresh">Actualiser</button>
    </div>
  </div>

  <!-- Health Overview (visible to ALL) -->
  <section class="hero-stats" id="mon-hero">
    <div class="stat-card stat-health" id="mon-health-card">
      <div class="stat-icon" id="mon-health-icon">&#9889;</div>
      <div class="stat-body">
        <span class="stat-value" id="mon-health-status"><span data-i18n="mon.connecting">Connexion...</span></span>
        <span class="stat-label" data-i18n="mon.health">SantÃ©</span>
      </div>
    </div>
    <div class="stat-card stat-info">
      <div class="stat-icon">&#9200;</div>
      <div class="stat-body">
        <span class="stat-value" id="mon-uptime">â€”</span>
        <span class="stat-label" data-i18n="mon.uptime">Uptime</span>
      </div>
    </div>
    <% if (isAdmin) { %>
    <div class="stat-card stat-warning">
      <div class="stat-icon">&#128190;</div>
      <div class="stat-body">
        <span class="stat-value" id="mon-memory">â€”</span>
        <span class="stat-label" data-i18n="mon.memory">MÃ©moire (RSS)</span>
      </div>
    </div>
    <% } %>
    <div class="stat-card stat-primary">
      <div class="stat-icon">&#128225;</div>
      <div class="stat-body">
        <span class="stat-value" id="mon-latency">â€”</span>
        <span class="stat-label" data-i18n="mon.latency">Latence Discord</span>
      </div>
    </div>
  </section>

  <!-- Detailed Metrics Grid -->
  <div class="monitoring-grid">

    <% if (isOwner) { %>
    <!-- System (OWNER ONLY) -->
    <div class="mon-panel">
      <h3 class="panel-title" data-i18n="mon.system">&#128421; SystÃ¨me</h3>
      <div class="mon-metrics">
        <div class="mon-row"><span class="mon-label" data-i18n="mon.memory">MÃ©moire (RSS)</span><span class="mon-value" id="mon-sys-rss">â€”</span></div>
        <div class="mon-row"><span class="mon-label" data-i18n="mon.heap">Heap V8</span><span class="mon-value" id="mon-sys-heap">â€”</span></div>
        <div class="mon-row"><span class="mon-label" data-i18n="mon.cpu">CPU</span><span class="mon-value" id="mon-sys-cpu">â€”</span></div>
        <div class="mon-row"><span class="mon-label" data-i18n="mon.ram_free">RAM libre</span><span class="mon-value" id="mon-sys-ram-free">â€”</span></div>
        <div class="mon-row"><span class="mon-label" data-i18n="mon.ram_total">RAM totale</span><span class="mon-value" id="mon-sys-ram-total">â€”</span></div>
        <div class="mon-row"><span class="mon-label" data-i18n="mon.process_uptime">Uptime process</span><span class="mon-value" id="mon-sys-uptime">â€”</span></div>
      </div>
      <!-- Memory bar -->
      <div class="mon-bar-container">
        <div class="mon-bar" id="mon-mem-bar" style="width:0%"></div>
      </div>
    </div>
    <% } %>

    <% if (isAdmin) { %>
    <!-- Discord (ADMIN+) -->
    <div class="mon-panel">
      <h3 class="panel-title" data-i18n="mon.discord">&#129302; Discord</h3>
      <div class="mon-metrics">
        <div class="mon-row"><span class="mon-label" data-i18n="mon.guilds">Serveurs</span><span class="mon-value" id="mon-dc-guilds">â€”</span></div>
        <% if (isOwner) { %>
        <div class="mon-row"><span class="mon-label" data-i18n="mon.users_cached">Utilisateurs (cache)</span><span class="mon-value" id="mon-dc-users">â€”</span></div>
        <div class="mon-row"><span class="mon-label" data-i18n="mon.channels">Channels</span><span class="mon-value" id="mon-dc-channels">â€”</span></div>
        <% } %>
        <div class="mon-row"><span class="mon-label" data-i18n="mon.ws_status">Statut WS</span><span class="mon-value" id="mon-dc-ws-status">â€”</span></div>
        <div class="mon-row"><span class="mon-label" data-i18n="mon.ws_latency">Latence WS</span><span class="mon-value" id="mon-dc-latency">â€”</span></div>
      </div>
      <!-- Latency bar -->
      <div class="mon-bar-container">
        <div class="mon-bar mon-bar-latency" id="mon-latency-bar" style="width:0%"></div>
      </div>
    </div>
    <% } %>

    <!-- Game (visible to ALL) -->
    <div class="mon-panel">
      <h3 class="panel-title" data-i18n="mon.game">&#127918; Jeu</h3>
      <div class="mon-metrics">
        <div class="mon-row"><span class="mon-label" data-i18n="mon.active_games">Parties actives</span><span class="mon-value" id="mon-gm-active">â€”</span></div>
        <div class="mon-row"><span class="mon-label" data-i18n="mon.total_players">Joueurs en jeu</span><span class="mon-value" id="mon-gm-players">â€”</span></div>
        <% if (isAdmin) { %>
        <div class="mon-row"><span class="mon-label" data-i18n="mon.games_24h">Parties (24h)</span><span class="mon-value" id="mon-gm-created24">â€”</span></div>
        <div class="mon-row"><span class="mon-label" data-i18n="mon.completed_24h">TerminÃ©es (24h)</span><span class="mon-value" id="mon-gm-completed24">â€”</span></div>
        <% } %>
      </div>
    </div>

    <% if (isOwner) { %>
    <!-- Commands (OWNER ONLY) -->
    <div class="mon-panel">
      <h3 class="panel-title" data-i18n="mon.commands">&#9889; Commandes</h3>
      <div class="mon-metrics">
        <div class="mon-row"><span class="mon-label" data-i18n="mon.cmd_total">Total exÃ©cutÃ©es</span><span class="mon-value" id="mon-cmd-total">â€”</span></div>
        <div class="mon-row"><span class="mon-label" data-i18n="mon.cmd_errors">Erreurs</span><span class="mon-value" id="mon-cmd-errors">â€”</span></div>
        <div class="mon-row"><span class="mon-label" data-i18n="mon.cmd_ratelimited">Rate limited</span><span class="mon-value" id="mon-cmd-rl">â€”</span></div>
        <div class="mon-row"><span class="mon-label" data-i18n="mon.cmd_avg">Temps moyen</span><span class="mon-value" id="mon-cmd-avg">â€”</span></div>
      </div>
    </div>

    <!-- Errors (OWNER ONLY) -->
    <div class="mon-panel">
      <h3 class="panel-title" data-i18n="mon.errors">&#9888; Erreurs</h3>
      <div class="mon-metrics">
        <div class="mon-row"><span class="mon-label" data-i18n="mon.err_total">Total</span><span class="mon-value" id="mon-err-total">â€”</span></div>
        <div class="mon-row"><span class="mon-label" data-i18n="mon.err_critical">Critiques</span><span class="mon-value mon-value-danger" id="mon-err-critical">â€”</span></div>
        <div class="mon-row"><span class="mon-label" data-i18n="mon.err_warnings">Avertissements</span><span class="mon-value mon-value-warning" id="mon-err-warnings">â€”</span></div>
        <div class="mon-row"><span class="mon-label" data-i18n="mon.err_24h">DerniÃ¨res 24h</span><span class="mon-value" id="mon-err-24h">â€”</span></div>
      </div>
    </div>

    <!-- History / mini chart (OWNER ONLY) -->
    <div class="mon-panel mon-panel-wide">
      <h3 class="panel-title" data-i18n="mon.history">&#128200; Historique (24h)</h3>
      <div class="mon-history" id="mon-history">
        <div class="mon-history-chart" id="mon-chart-memory">
          <div class="mon-chart-label" data-i18n="mon.memory">MÃ©moire</div>
          <div class="mon-chart-bars" id="mon-chart-mem-bars"></div>
        </div>
        <div class="mon-history-chart" id="mon-chart-latency">
          <div class="mon-chart-label" data-i18n="mon.latency">Latence</div>
          <div class="mon-chart-bars" id="mon-chart-lat-bars"></div>
        </div>
      </div>
    </div>
    <% } %>

    <% if (!isMember) { %>
    <!-- Login prompt for non-logged-in users -->
    <div class="mon-panel mon-panel-wide mon-panel-restricted">
      <div class="mon-restricted-msg">
        <span class="mon-restricted-icon">&#128274;</span>
        <h3 data-i18n="mon.login_required">Connectez-vous pour voir plus de dÃ©tails</h3>
        <p data-i18n="mon.login_desc">Les mÃ©triques dÃ©taillÃ©es sont rÃ©servÃ©es aux membres connectÃ©s et administrateurs.</p>
        <a href="/auth/discord" class="btn btn-discord">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M20.317 4.3698a19.7913 19.7913 0 00-4.8851-1.5152.0741.0741 0 00-.0785.0371c-.211.3753-.4447.8648-.6083 1.2495-1.8447-.2762-3.68-.2762-5.4868 0-.1636-.3933-.4058-.8742-.6177-1.2495a.077.077 0 00-.0785-.037 19.7363 19.7363 0 00-4.8852 1.515.0699.0699 0 00-.0321.0277C.5334 9.0458-.319 13.5799.0992 18.0578a.0824.0824 0 00.0312.0561c2.0528 1.5076 4.0413 2.4228 5.9929 3.0294a.0777.0777 0 00.0842-.0276c.4616-.6304.8731-1.2952 1.226-1.9942a.076.076 0 00-.0416-.1057c-.6528-.2476-1.2743-.5495-1.8722-.8923a.077.077 0 01-.0076-.1277c.1258-.0943.2517-.1923.3718-.2914a.0743.0743 0 01.0776-.0105c3.9278 1.7933 8.18 1.7933 12.0614 0a.0739.0739 0 01.0785.0095c.1202.099.246.1981.3728.2924a.077.077 0 01-.0066.1276 12.2986 12.2986 0 01-1.873.8914.0766.0766 0 00-.0407.1067c.3604.698.7719 1.3628 1.225 1.9932a.076.076 0 00.0842.0286c1.961-.6067 3.9495-1.5219 6.0023-3.0294a.077.077 0 00.0313-.0552c.5004-5.177-.8382-9.6739-3.5485-13.6604a.061.061 0 00-.0312-.0286z"/></svg>
          <span data-i18n="nav.login">Login</span>
        </a>
      </div>
    </div>
    <% } else if (!isOwner && isMember) { %>
    <!-- Restricted notice for non-owner users -->
    <div class="mon-panel mon-panel-wide mon-panel-restricted">
      <div class="mon-restricted-msg">
        <span class="mon-restricted-icon">&#128274;</span>
        <p data-i18n="mon.restricted_notice">Certaines mÃ©triques avancÃ©es sont rÃ©servÃ©es aux administrateurs du bot.</p>
      </div>
    </div>
    <% } %>

  </div>
</div>

<script>window.__accessLevel = '<%= level %>';</script>
<script src="/static/js/monitoring.js"></script>

<%- include('partials/footer') %>
