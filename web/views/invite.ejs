<%- include('partials/header') %>

<!-- â•â•â• HERO â•â•â• -->
<section class="iv-hero">
  <div class="iv-hero-bg">
    <div class="iv-hero-gradient"></div>
    <div class="iv-hero-dots"></div>
    <div class="iv-hero-scanline"></div>
    <div class="iv-hero-moon"></div>
  </div>
  <div class="iv-hero-inner">
    <div class="iv-hero-badge">ğŸº WEREWOLF BOT</div>
    <h1 class="iv-hero-title">
      <span class="iv-title-line" data-i18n="invite.hero_line1">La nuit tombe sur</span>
      <span class="iv-title-guild"><%= guildName %></span>
    </h1>
    <p class="iv-hero-desc" data-i18n="invite.hero_desc">
      Plongez votre serveur dans l'univers du Loup-Garou. Trahisons, stratÃ©gie, et fous rires garantis.
    </p>
    <div class="iv-hero-cta">
      <a href="<%= inviteUrl %>" target="_blank" rel="noopener" class="iv-btn-invite">
        <svg width="22" height="22" viewBox="0 -28.5 256 256" fill="currentColor"><path d="M216.856 16.597A208.502 208.502 0 00164.042 0c-2.275 4.113-4.933 9.645-6.766 14.046-19.692-2.961-39.203-2.961-58.533 0-1.832-4.4-4.55-9.933-6.846-14.046a207.809 207.809 0 00-52.855 16.638C5.618 67.147-3.443 116.4 1.087 164.956c22.169 16.555 43.653 26.612 64.775 33.193a161.094 161.094 0 0013.96-22.765 136.2 136.2 0 01-21.958-10.632c1.839-1.36 3.637-2.78 5.38-4.252 42.371 19.702 88.344 19.702 130.169 0 1.764 1.472 3.562 2.893 5.38 4.252-6.992 4.2-14.4 7.7-21.998 10.652 3.832 7.533 8.408 14.792 13.981 22.745 21.142-6.58 42.646-16.637 64.815-33.213 5.316-56.288-9.08-105.09-38.056-148.36zM85.474 135.095c-12.645 0-23.015-11.805-23.015-26.18s10.149-26.2 23.015-26.2c12.867 0 23.236 11.823 23.015 26.2.02 14.375-10.148 26.18-23.015 26.18zm85.051 0c-12.645 0-23.014-11.805-23.014-26.18s10.148-26.2 23.014-26.2c12.867 0 23.236 11.823 23.015 26.2 0 14.375-10.148 26.18-23.015 26.18z"/></svg>
        <span data-i18n="invite.btn_invite">Installer sur le serveur</span>
      </a>
      <span class="iv-hero-hint" data-i18n="invite.hint_free">100% gratuit &middot; Aucune carte requise</span>
    </div>
    <% if (guildIcon) { %>
      <div class="iv-hero-guild-preview">
        <div class="iv-guild-avatar-wrap">
          <img src="<%= guildIcon %>" alt="<%= guildName %>" class="iv-guild-avatar">
          <div class="iv-guild-ring"></div>
          <div class="iv-guild-ring iv-guild-ring-lg"></div>
        </div>
        <span class="iv-guild-name"><%= guildName %></span>
      </div>
    <% } %>
  </div>
</section>

<!-- â•â•â• FEATURES SHOWCASE â•â•â• -->
<section class="iv-features">
  <div class="iv-section-head">
    <span class="iv-section-tag">âœ¨ FonctionnalitÃ©s</span>
    <h2 class="iv-section-title" data-i18n="invite.features_title">Tout pour une expÃ©rience parfaite</h2>
    <p class="iv-section-sub" data-i18n="invite.features_sub">Un bot complet, pensÃ© pour le fun et la compÃ©tition.</p>
  </div>
  <div class="iv-features-grid">
    <div class="iv-feat" style="--i:0">
      <div class="iv-feat-icon iv-fi-game">ğŸ®</div>
      <div class="iv-feat-body">
        <h3 data-i18n="invite.feat_game">Partie complÃ¨te</h3>
        <p data-i18n="invite.feat_game_d">Phases jour/nuit automatisÃ©es, votes, actions nocturnes et gestion du capitaine.</p>
      </div>
    </div>
    <div class="iv-feat" style="--i:1">
      <div class="iv-feat-icon iv-fi-roles">ğŸ­</div>
      <div class="iv-feat-body">
        <h3 data-i18n="invite.feat_roles">12+ rÃ´les uniques</h3>
        <p data-i18n="invite.feat_roles_d">Voyante, SorciÃ¨re, Chasseur, Cupidon, Loup Blanc, Voleur, et bien d'autres.</p>
      </div>
    </div>
    <div class="iv-feat" style="--i:2">
      <div class="iv-feat-icon iv-fi-voice">ğŸ”Š</div>
      <div class="iv-feat-body">
        <h3 data-i18n="invite.feat_voice">Gestion vocale</h3>
        <p data-i18n="invite.feat_voice_d">Mute/unmute automatique des joueurs la nuit. Immersion totale garantie.</p>
      </div>
    </div>
    <div class="iv-feat" style="--i:3">
      <div class="iv-feat-icon iv-fi-stats">ğŸ“Š</div>
      <div class="iv-feat-body">
        <h3 data-i18n="invite.feat_stats">Stats & ELO</h3>
        <p data-i18n="invite.feat_stats_d">Classement compÃ©titif, historique, achievements et statistiques dÃ©taillÃ©es.</p>
      </div>
    </div>
    <div class="iv-feat" style="--i:4">
      <div class="iv-feat-icon iv-fi-lang">ğŸŒ</div>
      <div class="iv-feat-body">
        <h3 data-i18n="invite.feat_lang">Multilingue</h3>
        <p data-i18n="invite.feat_lang_d">Support complet FranÃ§ais et Anglais. Changez la langue avec /lang.</p>
      </div>
    </div>
    <div class="iv-feat" style="--i:5">
      <div class="iv-feat-icon iv-fi-dash">ğŸ–¥ï¸</div>
      <div class="iv-feat-body">
        <h3 data-i18n="invite.feat_dash">Dashboard web</h3>
        <p data-i18n="invite.feat_dash_d">Interface web complÃ¨te pour gÃ©rer vos parties, stats et configuration du bot.</p>
      </div>
    </div>
  </div>
</section>

<!-- â•â•â• ROLE CAROUSEL â•â•â• -->
<section class="iv-roles">
  <div class="iv-section-head">
    <span class="iv-section-tag">ğŸ­ Les rÃ´les</span>
    <h2 class="iv-section-title" data-i18n="invite.roles_title">Qui serez-vous cette nuit ?</h2>
  </div>
  <div class="iv-roles-track">
    <div class="iv-roles-slider" id="iv-roles-slider">
      <div class="iv-role-card" style="--i:0">
        <img src="/static/img/roles/loupSimple.webp" alt="Loup-Garou" class="iv-role-img" loading="lazy">
        <span class="iv-role-name">Loup-Garou</span>
        <span class="iv-role-camp iv-camp-wolves">ğŸº Loups</span>
      </div>
      <div class="iv-role-card" style="--i:1">
        <img src="/static/img/roles/voyante.webp" alt="Voyante" class="iv-role-img" loading="lazy">
        <span class="iv-role-name">Voyante</span>
        <span class="iv-role-camp iv-camp-village">ğŸ¡ Village</span>
      </div>
      <div class="iv-role-card" style="--i:2">
        <img src="/static/img/roles/sorciere.png" alt="SorciÃ¨re" class="iv-role-img" loading="lazy">
        <span class="iv-role-name">SorciÃ¨re</span>
        <span class="iv-role-camp iv-camp-village">ğŸ¡ Village</span>
      </div>
      <div class="iv-role-card" style="--i:3">
        <img src="/static/img/roles/chasseur.webp" alt="Chasseur" class="iv-role-img" loading="lazy">
        <span class="iv-role-name">Chasseur</span>
        <span class="iv-role-camp iv-camp-village">ğŸ¡ Village</span>
      </div>
      <div class="iv-role-card" style="--i:4">
        <img src="/static/img/roles/cupidon.webp" alt="Cupidon" class="iv-role-img" loading="lazy">
        <span class="iv-role-name">Cupidon</span>
        <span class="iv-role-camp iv-camp-village">ğŸ¡ Village</span>
      </div>
      <div class="iv-role-card" style="--i:5">
        <img src="/static/img/roles/loupBlanc.webp" alt="Loup Blanc" class="iv-role-img" loading="lazy">
        <span class="iv-role-name">Loup Blanc</span>
        <span class="iv-role-camp iv-camp-wolves">ğŸº Loups</span>
      </div>
      <div class="iv-role-card" style="--i:6">
        <img src="/static/img/roles/salvateur.webp" alt="Salvateur" class="iv-role-img" loading="lazy">
        <span class="iv-role-name">Salvateur</span>
        <span class="iv-role-camp iv-camp-village">ğŸ¡ Village</span>
      </div>
      <div class="iv-role-card" style="--i:7">
        <img src="/static/img/roles/voleur.webp" alt="Voleur" class="iv-role-img" loading="lazy">
        <span class="iv-role-name">Voleur</span>
        <span class="iv-role-camp iv-camp-village">ğŸ¡ Village</span>
      </div>
      <div class="iv-role-card" style="--i:8">
        <img src="/static/img/roles/villageois.webp" alt="Villageois" class="iv-role-img" loading="lazy">
        <span class="iv-role-name">Villageois</span>
        <span class="iv-role-camp iv-camp-village">ğŸ¡ Village</span>
      </div>
      <div class="iv-role-card" style="--i:9">
        <img src="/static/img/roles/petiteFille.webp" alt="Petite Fille" class="iv-role-img" loading="lazy">
        <span class="iv-role-name">Petite Fille</span>
        <span class="iv-role-camp iv-camp-village">ğŸ¡ Village</span>
      </div>
      <div class="iv-role-card" style="--i:10">
        <img src="/static/img/roles/ancien.webp" alt="Ancien" class="iv-role-img" loading="lazy">
        <span class="iv-role-name">Ancien</span>
        <span class="iv-role-camp iv-camp-village">ğŸ¡ Village</span>
      </div>
      <div class="iv-role-card" style="--i:11">
        <img src="/static/img/roles/idiot.webp" alt="Idiot du Village" class="iv-role-img" loading="lazy">
        <span class="iv-role-name">Idiot du Village</span>
        <span class="iv-role-camp iv-camp-village">ğŸ¡ Village</span>
      </div>
    </div>
  </div>
</section>

<!-- â•â•â• CARD DECK DRAW â€” PREMIUM â•â•â• -->
<section class="iv-deck">
  <div class="iv-section-head">
    <span class="iv-section-tag">ğŸƒ DÃ©couverte</span>
    <h2 class="iv-section-title">SÃ©lectionnez une carte</h2>
    <p class="iv-section-sub">DÃ©couvrez les rÃ´les du jeu en piochant dans le deck.</p>
  </div>
  <div class="ivd-stage">
    <div class="ivd-deck-wrap">
      <div class="ivd-deck" id="ivd-deck">
        <div class="ivd-card ivd-c1"></div>
        <div class="ivd-card ivd-c2"></div>
        <div class="ivd-card ivd-c3"></div>
        <div class="ivd-card ivd-c4"></div>
        <div class="ivd-card ivd-c5"></div>
        <div class="ivd-card ivd-ctop"></div>
      </div>
      <div class="ivd-glow" id="ivd-glow"></div>
    </div>
    <button class="ivd-btn" id="ivd-btn" type="button">
      <span class="ivd-btn-icon">ğŸ´</span>
      <span class="ivd-btn-text">SÃ©lectionnez une carte</span>
    </button>
  </div>
</section>

<!-- Card reveal modal -->
<div class="ivd-overlay" id="ivd-overlay">
  <div class="ivd-smoke" id="ivd-smoke"></div>
  <div class="ivd-modal" id="ivd-modal">
    <button class="ivd-modal-close" id="ivd-modal-close" type="button" aria-label="Fermer">&times;</button>
    <div class="ivd-modal-card">
      <img src="" alt="" class="ivd-modal-img" id="ivd-modal-img">
      <div class="ivd-modal-card-glow"></div>
    </div>
    <div class="ivd-modal-info">
      <h3 class="ivd-modal-name" id="ivd-modal-name"></h3>
      <span class="ivd-modal-camp" id="ivd-modal-camp"></span>
      <p class="ivd-modal-desc" id="ivd-modal-desc"></p>
      <code class="ivd-modal-cmd" id="ivd-modal-cmd"></code>
    </div>
    <button class="ivd-btn ivd-btn-redraw" id="ivd-btn-redraw" type="button">
      <span class="ivd-btn-icon">ğŸ´</span>
      <span class="ivd-btn-text">Tirer une nouvelle carte</span>
    </button>
  </div>
</div>

<!-- â•â•â• PERMISSIONS â•â•â• -->
<section class="iv-perms">
  <div class="iv-section-head">
    <span class="iv-section-tag">ğŸ”’ Permissions</span>
    <h2 class="iv-section-title" data-i18n="invite.perms_title">Droits requis</h2>
    <p class="iv-section-sub" data-i18n="invite.perms_sub">Le bot ne demande que les permissions strictement nÃ©cessaires au jeu.</p>
  </div>
  <div class="iv-perms-grid">
    <div class="iv-perm" style="--i:0">
      <span class="iv-perm-check">âœ“</span>
      <div>
        <strong data-i18n="invite.perm_commands">Slash Commands</strong>
        <p data-i18n="invite.perm_commands_desc">Enregistrer et rÃ©pondre aux commandes /</p>
      </div>
    </div>
    <div class="iv-perm" style="--i:1">
      <span class="iv-perm-check">âœ“</span>
      <div>
        <strong data-i18n="invite.perm_messages">Envoyer des messages</strong>
        <p data-i18n="invite.perm_messages_desc">Annonces de jeu et mises Ã  jour</p>
      </div>
    </div>
    <div class="iv-perm" style="--i:2">
      <span class="iv-perm-check">âœ“</span>
      <div>
        <strong data-i18n="invite.perm_manage_channels">GÃ©rer les salons</strong>
        <p data-i18n="invite.perm_manage_channels_desc">CrÃ©er les salons privÃ©s du jeu</p>
      </div>
    </div>
    <div class="iv-perm" style="--i:3">
      <span class="iv-perm-check">âœ“</span>
      <div>
        <strong data-i18n="invite.perm_voice">Rendre muet</strong>
        <p data-i18n="invite.perm_voice_desc">GÃ©rer le vocal pendant les phases de nuit</p>
      </div>
    </div>
    <div class="iv-perm" style="--i:4">
      <span class="iv-perm-check">âœ“</span>
      <div>
        <strong data-i18n="invite.perm_embed">IntÃ©grer des liens</strong>
        <p data-i18n="invite.perm_embed_desc">Embeds riches pour l'interface de jeu</p>
      </div>
    </div>
    <div class="iv-perm" style="--i:5">
      <span class="iv-perm-check">âœ“</span>
      <div>
        <strong data-i18n="invite.perm_roles">GÃ©rer les rÃ´les</strong>
        <p data-i18n="invite.perm_roles_desc">Attribution des rÃ´les et permissions de jeu</p>
      </div>
    </div>
  </div>
</section>

<!-- â•â•â• FINAL CTA â•â•â• -->
<section class="iv-cta">
  <div class="iv-cta-glow"></div>
  <div class="iv-cta-inner">
    <span class="iv-cta-wolf">ğŸº</span>
    <h2 class="iv-cta-title" data-i18n="invite.cta_title">PrÃªt Ã  jouer ?</h2>
    <p class="iv-cta-desc" data-i18n="invite.cta_desc">Installez le bot en un clic et lancez votre premiÃ¨re partie en quelques secondes.</p>
    <a href="<%= inviteUrl %>" target="_blank" rel="noopener" class="iv-btn-invite iv-btn-invite-lg">
      <svg width="22" height="22" viewBox="0 -28.5 256 256" fill="currentColor"><path d="M216.856 16.597A208.502 208.502 0 00164.042 0c-2.275 4.113-4.933 9.645-6.766 14.046-19.692-2.961-39.203-2.961-58.533 0-1.832-4.4-4.55-9.933-6.846-14.046a207.809 207.809 0 00-52.855 16.638C5.618 67.147-3.443 116.4 1.087 164.956c22.169 16.555 43.653 26.612 64.775 33.193a161.094 161.094 0 0013.96-22.765 136.2 136.2 0 01-21.958-10.632c1.839-1.36 3.637-2.78 5.38-4.252 42.371 19.702 88.344 19.702 130.169 0 1.764 1.472 3.562 2.893 5.38 4.252-6.992 4.2-14.4 7.7-21.998 10.652 3.832 7.533 8.408 14.792 13.981 22.745 21.142-6.58 42.646-16.637 64.815-33.213 5.316-56.288-9.08-105.09-38.056-148.36zM85.474 135.095c-12.645 0-23.015-11.805-23.015-26.18s10.149-26.2 23.015-26.2c12.867 0 23.236 11.823 23.015 26.2.02 14.375-10.148 26.18-23.015 26.18zm85.051 0c-12.645 0-23.014-11.805-23.014-26.18s10.148-26.2 23.014-26.2c12.867 0 23.236 11.823 23.015 26.2 0 14.375-10.148 26.18-23.015 26.18z"/></svg>
      <span data-i18n="invite.btn_invite">Installer sur le serveur</span>
    </a>
  </div>
</section>

<a href="/" class="iv-back-link" data-i18n="invite.back">â† Retour au Dashboard</a>

<!-- Role carousel auto-scroll -->
<script>
(function() {
  var slider = document.getElementById('iv-roles-slider');
  if (!slider) return;
  var speed = 0.4;
  var pos = 0;
  var paused = false;
  slider.addEventListener('mouseenter', function() { paused = true; });
  slider.addEventListener('mouseleave', function() { paused = false; });
  function tick() {
    if (!paused) {
      pos += speed;
      if (pos >= slider.scrollWidth / 2) pos = 0;
      slider.style.transform = 'translateX(-' + pos + 'px)';
    }
    requestAnimationFrame(tick);
  }
  // Duplicate cards for infinite scroll
  slider.innerHTML += slider.innerHTML;
  requestAnimationFrame(tick);

  // Scroll-reveal for sections
  var sections = document.querySelectorAll('.iv-features, .iv-roles, .iv-deck, .iv-perms, .iv-cta');
  var obs = new IntersectionObserver(function(entries) {
    entries.forEach(function(e) {
      if (e.isIntersecting) { e.target.classList.add('iv-visible'); obs.unobserve(e.target); }
    });
  }, { threshold: 0.15 });
  sections.forEach(function(s) { obs.observe(s); });
})();

/* â”€â”€ Card Deck Draw â€” Premium cinematic â”€â”€ */
(function() {
  'use strict';

  var ROLES = [
    { name: 'Loup-Garou', camp: 'wolves', campLabel: 'ğŸº Loups', img: 'loupSimple.webp', cmd: '/kill @joueur', desc: 'Chaque nuit, les loups-garous se rÃ©unissent pour dÃ©vorer un villageois. Ils doivent rester discrets pour ne pas Ãªtre dÃ©masquÃ©s.' },
    { name: 'Villageois', camp: 'village', campLabel: 'ğŸ¡ Village', img: 'villageois.webp', cmd: '/vote @joueur', desc: 'Un simple villageois sans pouvoir spÃ©cial. Il doit user de logique et d\'intuition pour dÃ©masquer les loups-garous.' },
    { name: 'Voyante', camp: 'village', campLabel: 'ğŸ¡ Village', img: 'voyante.webp', cmd: '/see @joueur', desc: 'Chaque nuit, la voyante peut sonder l\'Ã¢me d\'un joueur et dÃ©couvrir sa vÃ©ritable identitÃ©.' },
    { name: 'SorciÃ¨re', camp: 'village', campLabel: 'ğŸ¡ Village', img: 'sorciere.png', cmd: '/potion vie|mort @joueur', desc: 'Elle possÃ¨de deux potions : une de guÃ©rison et une d\'empoisonnement, chacune utilisable une seule fois.' },
    { name: 'Chasseur', camp: 'village', campLabel: 'ğŸ¡ Village', img: 'chasseur.webp', cmd: '/shoot @joueur', desc: 'En mourant, le chasseur tire une derniÃ¨re balle et emporte un joueur de son choix dans la tombe.' },
    { name: 'Loup Blanc', camp: 'solo', campLabel: 'âš¡ Solitaire', img: 'loupBlanc.webp', cmd: '/kill @joueur', desc: 'Un loup solitaire qui joue pour lui-mÃªme. Une nuit sur deux, il peut dÃ©vorer un autre loup-garou.' },
    { name: 'Petite Fille', camp: 'village', campLabel: 'ğŸ¡ Village', img: 'petiteFille.webp', cmd: '/listen', desc: 'Curieuse et intrÃ©pide, elle peut espionner le conseil des loups-garous pendant la nuit.' },
    { name: 'Cupidon', camp: 'village', campLabel: 'ğŸ¡ Village', img: 'cupidon.webp', cmd: '/love @j1 @j2', desc: 'Au dÃ©but de la partie, Cupidon dÃ©signe deux amoureux liÃ©s par le destin. Si l\'un meurt, l\'autre le suit.' },
    { name: 'Salvateur', camp: 'village', campLabel: 'ğŸ¡ Village', img: 'salvateur.webp', cmd: '/protect @joueur', desc: 'Chaque nuit, il place un joueur sous sa protection, le rendant invulnÃ©rable Ã  l\'attaque des loups.' },
    { name: 'Ancien', camp: 'village', campLabel: 'ğŸ¡ Village', img: 'ancien.webp', cmd: '/vote @joueur', desc: 'Sa sagesse lui confÃ¨re une rÃ©sistance exceptionnelle : il survit Ã  la premiÃ¨re attaque des loups-garous.' },
    { name: 'Idiot du Village', camp: 'village', campLabel: 'ğŸ¡ Village', img: 'idiot.webp', cmd: '/vote @joueur', desc: 'S\'il est dÃ©signÃ© par le vote du village, il est rÃ©vÃ©lÃ© et graciÃ© mais perd dÃ©finitivement son droit de vote.' },
    { name: 'Voleur', camp: 'village', campLabel: 'ğŸ¡ Village', img: 'voleur.webp', cmd: '/steal @carte', desc: 'Au dÃ©but de la partie, il dÃ©couvre deux cartes et peut en choisir une pour Ã©changer son rÃ´le.' }
  ];

  var CAMP_CSS = { wolves: 'ivd-camp-wolves', village: 'ivd-camp-village', solo: 'ivd-camp-solo' };

  var deck = document.getElementById('ivd-deck');
  var glow = document.getElementById('ivd-glow');
  var btnDraw = document.getElementById('ivd-btn');
  var btnRedraw = document.getElementById('ivd-btn-redraw');
  var overlay = document.getElementById('ivd-overlay');
  var modal = document.getElementById('ivd-modal');
  var btnClose = document.getElementById('ivd-modal-close');
  var imgEl = document.getElementById('ivd-modal-img');
  var nameEl = document.getElementById('ivd-modal-name');
  var campEl = document.getElementById('ivd-modal-camp');
  var descEl = document.getElementById('ivd-modal-desc');
  var cmdEl = document.getElementById('ivd-modal-cmd');

  if (!deck || !btnDraw) return;

  // Move overlay to <body> so position:fixed isn't trapped by
  // .main-content's will-change / filter (which creates a new containing block)
  document.body.appendChild(overlay);

  var busy = false;
  var lastIndex = -1;

  function pickRole() {
    var idx;
    do { idx = Math.floor(Math.random() * ROLES.length); } while (idx === lastIndex && ROLES.length > 1);
    lastIndex = idx;
    return ROLES[idx];
  }

  function closeModal() {
    overlay.classList.remove('ivd-active');
    // Reset deck dealing state
    deck.classList.remove('ivd-dealing');
    // Restore top card visibility
    var top = deck.querySelector('.ivd-ctop');
    if (top) { top.style.opacity = ''; top.style.transform = ''; }
    busy = false;
  }

  function drawCard() {
    if (busy && !overlay.classList.contains('ivd-active')) return;
    busy = true;
    btnDraw.disabled = true;
    if (btnRedraw) btnRedraw.disabled = true;

    // Close modal if open (for redraw)
    var wasOpen = overlay.classList.contains('ivd-active');
    if (wasOpen) {
      overlay.classList.remove('ivd-active');
    }

    var role = pickRole();
    var delay = wasOpen ? 400 : 0;

    setTimeout(function() {
      // Reset deck
      deck.classList.remove('ivd-dealing', 'ivd-shuffling');
      var top = deck.querySelector('.ivd-ctop');
      if (top) { top.style.opacity = ''; top.style.transform = ''; }

      // Phase 1: Glow appears
      glow.style.opacity = '0.7';

      // Phase 2: Shuffle (1.8s)
      deck.classList.add('ivd-shuffling');

      setTimeout(function() {
        deck.classList.remove('ivd-shuffling');

        // Phase 3: Deal â€” top card flies out
        deck.classList.add('ivd-dealing');

        setTimeout(function() {
          // Populate modal
          imgEl.src = '/static/img/roles/' + role.img;
          imgEl.alt = role.name;
          nameEl.textContent = role.name;
          campEl.textContent = role.campLabel;
          campEl.className = 'ivd-modal-camp ' + (CAMP_CSS[role.camp] || '');
          descEl.textContent = role.desc;
          if (role.cmd) {
            cmdEl.textContent = role.cmd;
            cmdEl.style.display = '';
          } else {
            cmdEl.style.display = 'none';
          }

          // Phase 4: Show overlay + modal
          glow.style.opacity = '0';
          overlay.classList.add('ivd-active');

          btnDraw.disabled = false;
          if (btnRedraw) btnRedraw.disabled = false;
          // busy stays true until modal closes (except redraw)
        }, 800);
      }, 1900);
    }, delay);
  }

  btnDraw.addEventListener('click', drawCard);
  if (btnRedraw) btnRedraw.addEventListener('click', drawCard);

  // Close modal
  btnClose.addEventListener('click', closeModal);
  overlay.addEventListener('click', function(e) {
    if (e.target === overlay || e.target.classList.contains('ivd-smoke')) closeModal();
  });
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && overlay.classList.contains('ivd-active')) closeModal();
  });
})();
</script>

<%- include('partials/footer') %>
