<%- include('partials/header') %>
<%
  var globalLeaderboard = typeof globalLeaderboard !== 'undefined' ? globalLeaderboard : [];
  var recentHistory = typeof recentHistory !== 'undefined' ? recentHistory : [];
%>

<!-- â•â•â• HERO COMMAND CENTER â•â•â• -->
<section class="dash-hero">
  <div class="dash-hero-bg">
    <div class="dash-hero-gradient"></div>
    <div class="dash-hero-dots"></div>
    <div class="dash-hero-scanline"></div>
  </div>
  <div class="dash-hero-inner">
    <div class="dash-hero-left">
      <div class="dash-hero-avatar-wrap">
        <img src="/static/img/roles/LG.jpg" alt="Werewolf" class="dash-hero-avatar">
        <div class="dash-avatar-ring"></div>
        <div class="dash-avatar-ring dash-avatar-ring-lg"></div>
      </div>
      <div class="dash-hero-info">
        <h1 class="dash-hero-title" data-i18n-html="dash.title">Werewolf <span>Dashboard</span></h1>
        <p class="dash-hero-subtitle" data-i18n="dash.subtitle">Centre de commandement Â· Surveillance temps rÃ©el</p>
        <div class="dash-hero-status">
          <span class="status-beacon"></span>
          <span class="status-text" data-i18n="dash.system_ok">SystÃ¨me opÃ©rationnel</span>
        </div>
      </div>
    </div>
    <div class="dash-hero-metrics">
      <div class="dash-metric" style="--i:0">
        <div class="dash-metric-icon dm-green">ğŸ®</div>
        <div class="dash-metric-data">
          <span class="dash-metric-val counter" data-target="<%= activeGames %>" id="active-games">0</span>
          <span class="dash-metric-label" data-i18n="dash.active_games">Parties actives</span>
        </div>
      </div>
      <div class="dash-metric" style="--i:1">
        <div class="dash-metric-icon dm-blue">ğŸ‘¥</div>
        <div class="dash-metric-data">
          <span class="dash-metric-val counter" data-target="<%= activePlayers %>" id="active-players">0</span>
          <span class="dash-metric-label" data-i18n="dash.active_players">Joueurs en jeu</span>
        </div>
      </div>
      <div class="dash-metric" style="--i:2">
        <div class="dash-metric-icon dm-purple">ğŸ°</div>
        <div class="dash-metric-data">
          <span class="dash-metric-val counter" data-target="<%= guilds %>">0</span>
          <span class="dash-metric-label" data-i18n="dash.servers">Serveurs</span>
        </div>
      </div>
      <div class="dash-metric" style="--i:3">
        <div class="dash-metric-icon dm-amber">ğŸ“Š</div>
        <div class="dash-metric-data">
          <span class="dash-metric-val counter" data-target="<%= stats.total_games || 0 %>">0</span>
          <span class="dash-metric-label" data-i18n="dash.total_games">Total parties</span>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- â•â•â• MAIN GRID â•â•â• -->
<div class="dashboard-grid">
  <div class="dashboard-main">
    <!-- Live Games Panel -->
    <div class="dash-panel" style="--enter:0">
      <div class="dash-panel-head">
        <div class="dash-panel-title"><span class="pulse-dot"></span> <span data-i18n="dash.live_games">Parties en direct</span></div>
        <span class="badge-count"><%= games.length %></span>
      </div>
      <div class="games-grid" id="games-grid">
        <% if (games.length === 0) { %>
          <div class="empty-state">
            <div class="empty-visual">
              <span class="empty-icon-lg">ğŸŒ™</span>
              <div class="empty-glow-ring"></div>
            </div>
            <p class="empty-title" data-i18n="dash.no_games">Le village dort paisiblement</p>
            <p class="empty-sub text-muted" data-i18n="dash.no_games_hint">Les parties apparaÃ®tront ici en temps rÃ©el</p>
          </div>
        <% } else { %>
          <% games.forEach(function(g) {
            var alive = g.players ? g.players.filter(function(p) { return p.alive; }).length : 0;
            var dead = g.dead ? g.dead.length : 0;
            var total = alive + dead;
            var pct = total > 0 ? Math.round(alive / total * 100) : 100;
          %>
            <a href="/game/<%= g.gameId %>" class="game-card" data-game="<%= g.gameId %>">
              <div class="game-card-header">
                <span class="game-phase phase-<%= (g.phase || 'lobby').toLowerCase() %>" data-i18n="phase.<%= g.phase || 'Lobby' %>"><%= g.phase || 'Lobby' %></span>
                <span class="game-day"><% if (g.dayCount) { %><span data-i18n="goverview.day_prefix">Jour</span> <%= g.dayCount %><% } %></span>
              </div>
              <div class="game-card-body">
                <div class="game-guild"><%= g.guildName || g.guildId %></div>
                <div class="game-players">
                  <span class="alive-count">â¤ï¸ <%= alive %> <span data-i18n="dash.alive_count">vivants</span></span>
                  <span class="dead-count">â˜ ï¸ <%= dead %> <span data-i18n="dash.dead_count">morts</span></span>
                </div>
                <div class="game-hp-bar">
                  <div class="game-hp-fill" style="width: <%= pct %>%"></div>
                </div>
                <% if (g.subPhase) { %>
                  <div class="game-subphase-tag" data-i18n="subphase.<%= g.subPhase %>"><%= g.subPhase %></div>
                <% } %>
              </div>
              <div class="game-card-footer">
                <span class="spectate-btn" data-i18n="dash.watch_live">ğŸ‘ï¸ Regarder en direct</span>
              </div>
            </a>
          <% }); %>
        <% } %>
      </div>
    </div>

    <!-- Card Deck Draw â€” Wide layout -->
    <div class="dash-panel deck-panel deck-panel-wide" style="--enter:1">
      <div class="dash-panel-head">
        <div class="dash-panel-title" data-i18n="dash.draw_role">ğŸƒ Piocher un rÃ´le</div>
      </div>
      <div class="deck-wide-layout">
        <div class="deck-wide-left">
          <div class="deck-area">
            <div class="deck-stack" id="deck-stack">
              <div class="deck-card dc-1"></div>
              <div class="deck-card dc-2"></div>
              <div class="deck-card dc-3"></div>
              <div class="deck-card dc-4"></div>
              <div class="deck-card dc-top"></div>
            </div>
            <div class="drawn-card-zone" id="drawn-card-zone">
              <div class="drawn-card" id="drawn-card">
                <div class="drawn-card-inner" id="drawn-card-inner">
                  <div class="drawn-card-front">
                    <img src="/static/img/roles/loup-garou-dos.png" alt="Dos" class="drawn-card-img">
                  </div>
                  <div class="drawn-card-back" id="drawn-card-back">
                    <img src="" alt="" class="drawn-role-img" id="drawn-role-img">
                  </div>
                </div>
              </div>
            </div>
          </div>
          <button class="btn btn-draw" id="btn-draw" type="button">
            <span class="draw-icon">ğŸ´</span> <span data-i18n="dash.draw_card">Piocher une carte</span>
          </button>
        </div>
        <div class="deck-wide-right" id="drawn-role-info">
          <div class="drawn-role-placeholder" id="drawn-role-placeholder">
            <span class="drawn-role-placeholder-icon">ğŸ´</span>
            <span class="drawn-role-placeholder-text" data-i18n="dash.draw_hint">Piochez une carte pour dÃ©couvrir un rÃ´le</span>
          </div>
          <div class="drawn-role-detail" id="drawn-role-detail">
            <span class="drawn-role-name" id="drawn-role-name"></span>
            <span class="drawn-role-camp" id="drawn-role-camp"></span>
            <p class="drawn-role-desc" id="drawn-role-desc"></p>
            <span class="drawn-role-cmd" id="drawn-role-cmd"></span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Sidebar -->
  <aside class="dashboard-sidebar">
    <!-- Quick Links -->
    <div class="sidebar-panel" style="--enter:2">
      <h3 class="panel-title" data-i18n="dash.quick_access">âš¡ AccÃ¨s rapide</h3>
      <div class="quick-links">
        <a href="/roles" class="quick-link quick-link-featured">
          <div class="ql-featured-glow"></div>
          <div class="ql-featured-particles">
            <span></span><span></span><span></span><span></span><span></span><span></span>
          </div>
          <span class="quick-link-icon ql-featured-icon">ğŸº</span>
          <div class="quick-link-body">
            <span class="quick-link-title" data-i18n="dash.link_roles">RÃ´les</span>
            <span class="ql-featured-badge" data-i18n="dash.link_roles_badge">âœ¨ Nouveau crÃ©ateur de rÃ´les</span>
            <span class="quick-link-desc" data-i18n="dash.link_roles_desc">EncyclopÃ©die & crÃ©ateur personnalisÃ©</span>
          </div>
          <span class="quick-link-arrow">â€º</span>
        </a>
        <a href="https://github.com/Heliox1119/Werewolf-bot" target="_blank" class="quick-link">
          <span class="quick-link-icon">ğŸ’»</span>
          <div class="quick-link-body">
            <span class="quick-link-title">GitHub</span>
            <span class="quick-link-desc" data-i18n="dash.link_github_desc">Code source du bot</span>
          </div>
          <span class="quick-link-arrow">â€º</span>
        </a>
      </div>
    </div>

    <!-- Global Leaderboard -->
    <div class="sidebar-panel" style="--enter:3">
      <h3 class="panel-title" data-i18n="dash.leaderboard">ğŸ† Classement global</h3>
      <% if (globalLeaderboard.length === 0) { %>
        <div class="db-lb-empty text-muted">
          <span class="db-lb-empty-icon">ğŸ†</span>
          <p data-i18n="dash.no_ranked">Aucun joueur classÃ©</p>
        </div>
      <% } else { %>
        <div class="db-lb-list">
          <% globalLeaderboard.forEach(function(p) { %>
            <a href="/player/<%= p.player_id %>" class="db-lb-row" style="--delay:<%= (p.rank - 1) * 0.06 %>s">
              <div class="db-lb-rank rank-<%= p.rank %>">#<%= p.rank %></div>
              <div class="db-lb-info">
                <span class="db-lb-name"><%= p.username || p.player_id %></span>
                <span class="db-lb-tier tier tier-<%= (p.tier || {}).id || 'bronze' %>"><%= (p.tier || {}).emoji || '' %><% if ((p.tier || {}).id) { %> <span data-i18n="tier.<%= (p.tier).id %>"><%= (p.tier || {}).name %></span><% } else { %> <span data-i18n="fb.tier_default">Bronze</span><% } %></span>
              </div>
              <div class="db-lb-pts">
                <span class="db-lb-pts-val"><%= p.elo_rating || 1000 %></span>
                <span class="db-lb-pts-label" data-i18n="gleader.pts">pts</span>
              </div>
            </a>
          <% }); %>
        </div>
      <% } %>
    </div>

    <!-- Recent Completed Games -->
    <div class="sidebar-panel" style="--enter:4">
      <h3 class="panel-title" data-i18n="dash.recent_games">ğŸ“œ DerniÃ¨res parties</h3>
      <% if (recentHistory.length === 0) { %>
        <div class="db-rh-empty text-muted">
          <span class="db-rh-empty-icon">ğŸ“œ</span>
          <p data-i18n="dash.no_history">Aucune partie terminÃ©e</p>
        </div>
      <% } else { %>
        <div class="db-rh-list">
          <% recentHistory.forEach(function(h, i) { %>
            <div class="db-rh-row" style="--delay:<%= i * 0.06 %>s">
              <div class="db-rh-winner">
                <% if (h.winner === 'village') { %>
                  <span class="db-rh-badge db-rh-village">ğŸ¡</span>
                <% } else if (h.winner === 'wolves') { %>
                  <span class="db-rh-badge db-rh-wolves">ğŸº</span>
                <% } else if (h.winner === 'lovers') { %>
                  <span class="db-rh-badge db-rh-lovers">ğŸ’•</span>
                <% } else { %>
                  <span class="db-rh-badge">â“</span>
                <% } %>
              </div>
              <div class="db-rh-info">
                <span class="db-rh-guild"<% if (!h.guild_name) { %> data-i18n="fb.unknown_server"<% } %>><%= h.guild_name || 'Serveur inconnu' %></span>
                <span class="db-rh-meta">
                  ğŸ‘¥ <%= h.player_count || '?' %>
                  Â· ğŸ“… <%= h.day_count || 0 %><span data-i18n="goverview.day_suffix">j</span>
                  <% if (h.duration_seconds) { %>Â· â±ï¸ <%= Math.floor(h.duration_seconds / 60) %><span data-i18n="goverview.min_suffix">min</span><% } %>
                </span>
              </div>
              <div class="db-rh-date">
                <span class="pp-date" data-timestamp-ms="<%= h.ended_at ? new Date(h.ended_at).getTime() : '' %>" data-date-format="day-month"><%= h.ended_at ? new Date(h.ended_at).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' }) : '' %></span>
              </div>
            </div>
          <% }); %>
        </div>
      <% } %>
    </div>

  </aside>
</div>

<script>
  window.__ROLE_DATA__ = <%- JSON.stringify(roleData) %>;
</script>
<script src="/static/js/dashboard.js"></script>
<%- include('partials/footer') %>
