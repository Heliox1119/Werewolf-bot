<%- include('partials/header') %>

<div class="sp-page" data-game-id="<%= gameId %>">

  <!-- ‚ïê‚ïê‚ïê TOP BAR ‚ïê‚ïê‚ïê -->
  <div class="sp-topbar">
    <div class="sp-topbar-left">
      <a href="<%= game.guildId ? '/guild/' + game.guildId : '/' %>" class="sp-back-btn" data-i18n="spectator.back">‚Üê Retour</a>
      <div class="sp-live-indicator">
        <span class="sp-live-dot"></span>
        <span data-i18n="spectator.live">LIVE</span>
      </div>
    </div>
    <div class="sp-topbar-center">
      <h1 class="sp-title"><%= game.guildName || game.guildId %></h1>
    </div>
    <div class="sp-topbar-right">
      <div class="sp-phase-container">
        <span class="sp-phase game-phase phase-<%= (game.phase || 'lobby').toLowerCase() %>" id="game-phase"<% if (!game.phase) { %> data-i18n="fb.lobby"<% } %>><%= game.phase || 'Lobby' %></span>
        <% if (game.subPhase) { %><span class="sp-subphase" id="game-subphase"><%= game.subPhase %></span><% } else { %><span class="sp-subphase" id="game-subphase"></span><% } %>
      </div>
      <span class="sp-day" id="game-day"><% if (game.dayCount) { %><span data-i18n="goverview.day_prefix">Jour</span> <%= game.dayCount %><% } %></span>
      <span class="sp-viewers" id="spectator-count">üëÅ <span>0</span></span>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê MAIN GRID ‚ïê‚ïê‚ïê -->
  <div class="sp-grid">

    <!-- LEFT ‚Äî Players & Graveyard -->
    <div class="sp-col-left">
      <div class="sp-panel sp-panel-players" style="animation: panelEnter 0.5s ease-out both; animation-delay: 0.1s;">
        <div class="sp-panel-header">
          <h3 class="sp-panel-title" data-i18n="spectator.players">‚öîÔ∏è Joueurs</h3>
          <span class="sp-alive-badge" id="alive-count-badge"><span id="alive-count"><%= game.players ? game.players.filter(function(p) { return p.alive; }).length : 0 %></span> <span data-i18n="dash.alive_count">vivants</span></span>
        </div>
        <div class="sp-player-list" id="player-list">
          <% if (game.players) { game.players.forEach(function(p, i) { %>
            <div class="sp-player <%= p.alive ? 'sp-alive' : 'sp-dead' %> clickable-player" data-player-id="<%= p.id %>" data-player-avatar="<%= p.avatar || '' %>" onclick="openSpectatorPlayerModal(this)" style="animation-delay:<%= 0.15 + i * 0.04 %>s">
              <div class="sp-player-avatar-wrap">
                <% if (p.avatar) { %>
                  <img class="sp-player-avatar" src="<%= p.avatar %>" alt="" />
                <% } else { %>
                  <span class="sp-player-avatar sp-player-avatar-default">üë§</span>
                <% } %>
                <% if (p.alive) { %><span class="sp-avatar-status sp-status-alive"></span><% } else { %><span class="sp-avatar-status sp-status-dead"></span><% } %>
              </div>
              <div class="sp-player-info">
                <span class="sp-player-name"><%= p.username || p.id %></span>
                <% if (p.id && p.id.startsWith('fake_')) { %><span class="sp-badge-fake">BOT</span><% } %>
                <div class="sp-player-tags">
                  <% if (!p.alive && p.role) { %><span class="sp-role-tag" data-i18n="role.<%= p.role %>"><%= p.role %></span><% } %>
                  <% if (p.isCaptain) { %><span class="sp-badge-tag">üëë <span data-i18n="spectator.captain">Capitaine</span></span><% } %>
                  <% if (p.inLove) { %><span class="sp-badge-tag sp-badge-love">üíï</span><% } %>
                </div>
              </div>
              <span class="sp-player-chevron">‚Ä∫</span>
            </div>
          <% }); } %>
        </div>

        <% if (game.dead && game.dead.length > 0) { %>
          <div class="sp-graveyard-divider">
            <span>‚ò†Ô∏è Cimeti√®re (<%= game.dead.length %>)</span>
          </div>
          <div class="sp-graveyard" id="graveyard">
            <% game.dead.forEach(function(d, i) { %>
              <div class="sp-grave clickable-player" data-player-id="<%= d.id %>" data-player-avatar="<%= d.avatar || '' %>" onclick="openSpectatorPlayerModal(this)" style="animation-delay:<%= 0.3 + i * 0.04 %>s">
                <% if (d.avatar) { %>
                  <img class="sp-grave-avatar" src="<%= d.avatar %>" alt="" />
                <% } else { %>
                  <span class="sp-grave-avatar sp-grave-avatar-default">‚ò†Ô∏è</span>
                <% } %>
                <span class="sp-grave-name"><%= d.username || d.id %></span>
                <% if (d.id && d.id.startsWith('fake_')) { %><span class="sp-badge-fake">BOT</span><% } %>
                <span class="sp-grave-role"><%= d.role || '?' %></span>
                <span class="sp-player-chevron">‚Ä∫</span>
              </div>
            <% }); %>
          </div>
        <% } %>
      </div>
    </div>

    <!-- CENTER ‚Äî Event Feed -->
    <div class="sp-col-center">
      <div class="sp-panel sp-panel-feed" style="animation: panelEnter 0.5s ease-out both; animation-delay: 0.2s;">
        <div class="sp-panel-header">
          <h3 class="sp-panel-title" data-i18n="spectator.events">üì° √âv√©nements en direct</h3>
          <span class="sp-feed-pulse"></span>
        </div>
        <div class="sp-feed" id="event-feed">
          <div class="sp-event sp-ev-info">
            <span class="sp-ev-time"><%= new Date().toLocaleTimeString() %></span>
            <span class="sp-ev-icon">üì°</span>
            <span class="sp-ev-text" data-i18n="spectator.connected">Connect√© au flux spectateur en temps r√©el</span>
          </div>
          <% if (game.actionLog) { game.actionLog.slice(-10).forEach(function(log) { %>
            <div class="sp-event sp-ev-action">
              <span class="sp-ev-time"><%= log.timestamp ? new Date(log.timestamp).toLocaleTimeString() : '' %></span>
              <span class="sp-ev-icon">üìù</span>
              <span class="sp-ev-text"><%= log.action %></span>
            </div>
          <% }); } %>
        </div>
      </div>

      <!-- Votes (if any) -->
      <% if (game.votes && Object.keys(game.votes).length > 0) { %>
      <div class="sp-panel sp-panel-votes" style="animation: panelEnter 0.5s ease-out both; animation-delay: 0.3s;">
        <div class="sp-panel-header">
          <h3 class="sp-panel-title" data-i18n="spectator.votes">üó≥Ô∏è Votes en cours</h3>
          <span class="sp-vote-count"><%= Object.keys(game.votes).length %> <span data-i18n="spectator.votes_cast">exprim√©s</span></span>
        </div>
        <div class="sp-votes" id="vote-display">
          <%
            var voteCounts = {};
            Object.values(game.votes).forEach(function(target) {
              voteCounts[target] = (voteCounts[target] || 0) + 1;
            });
            var sortedVotes = Object.entries(voteCounts).sort(function(a, b) { return b[1] - a[1]; });
            var maxV = sortedVotes.length > 0 ? sortedVotes[0][1] : 1;
            sortedVotes.forEach(function(entry) {
              var targetId = entry[0];
              var vCount = entry[1];
              var targetPlayer = (game.players || []).find(function(p) { return p.id === targetId; });
              var targetName = targetPlayer ? targetPlayer.username : targetId;
              var targetAvatar = targetPlayer ? targetPlayer.avatar : null;
              var pct = Math.round((vCount / maxV) * 100);
          %>
            <div class="sp-vote-row">
              <div class="sp-vote-target">
                <% if (targetAvatar) { %><img class="sp-vote-avatar" src="<%= targetAvatar %>" alt="" /><% } %>
                <span><%= targetName %></span>
              </div>
              <div class="sp-vote-bar">
                <div class="sp-vote-bar-fill" style="width:<%= pct %>%"></div>
              </div>
              <span class="sp-vote-num"><%= vCount %></span>
            </div>
          <% }); %>
        </div>
      </div>
      <% } %>
    </div>

    <!-- RIGHT ‚Äî Game Info -->
    <div class="sp-col-right">
      <div class="sp-panel sp-panel-info" style="animation: panelEnter 0.5s ease-out both; animation-delay: 0.25s;">
        <div class="sp-panel-header">
          <h3 class="sp-panel-title" data-i18n="spectator.info">üìä Infos</h3>
        </div>
        <div class="sp-info-grid">
          <div class="sp-info-card">
            <span class="sp-info-icon">üéÆ</span>
            <div class="sp-info-data">
              <span class="sp-info-val" id="player-count"><%= game.players ? game.players.length : 0 %></span>
              <span class="sp-info-label" data-i18n="spectator.info_players">Joueurs</span>
            </div>
          </div>
          <div class="sp-info-card">
            <span class="sp-info-icon">üíö</span>
            <div class="sp-info-data">
              <span class="sp-info-val" id="info-alive"><%= game.players ? game.players.filter(function(p) { return p.alive; }).length : 0 %></span>
              <span class="sp-info-label" data-i18n="spectator.info_alive">Vivants</span>
            </div>
          </div>
          <div class="sp-info-card">
            <span class="sp-info-icon">üíÄ</span>
            <div class="sp-info-data">
              <span class="sp-info-val" id="dead-count"><%= game.dead ? game.dead.length : 0 %></span>
              <span class="sp-info-label" data-i18n="spectator.info_dead">Morts</span>
            </div>
          </div>
          <div class="sp-info-card">
            <span class="sp-info-icon">üìÖ</span>
            <div class="sp-info-data">
              <span class="sp-info-val" id="game-started"<% if (!game.startedAt) { %> data-i18n="fb.no_data"<% } %>><%= game.startedAt ? new Date(game.startedAt).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '‚Äî' %></span>
              <span class="sp-info-label" data-i18n="spectator.info_started">D√©marr√©</span>
            </div>
          </div>
        </div>

        <div class="sp-rules-section">
          <div class="sp-rules-title" data-i18n="spectator.win_condition">‚öôÔ∏è Condition de victoire</div>
          <div class="sp-rules-row">
            <span>üê∫ <span data-i18n="spectator.wolves">Loups</span></span>
            <span><%= game.wolfWinCondition === 'majority' ? '' : '' %><span data-i18n="spectator.wc_<%= game.wolfWinCondition || 'majority' %>"><%= game.wolfWinCondition === 'majority' ? 'Majorit√© (loups ‚â• villageois)' : '√âlimination (tuer tous les villageois)' %></span></span>
          </div>
          <div class="sp-rules-row">
            <span>üèòÔ∏è <span data-i18n="spectator.village_label">Village</span></span>
            <span data-i18n="spectator.wc_village">√âliminer tous les loups</span>
          </div>
        </div>

        <div class="sp-gameid-section">
          <span class="sp-gameid-label" data-i18n="spectator.game_id">Game ID</span>
          <span class="sp-gameid-val"><%= gameId %></span>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Player Quick Modal (Spectator) ‚Äî Premium Design -->
<div class="modal-overlay" id="spectator-player-modal" onclick="if(event.target===this)closeSpectatorPlayerModal()">
  <div class="spm-card">
    <button class="spm-close" onclick="closeSpectatorPlayerModal()" aria-label="Fermer" data-i18n-aria-label="ui.close">&times;</button>

    <!-- Hero gradient bg -->
    <div class="spm-hero" id="sp-modal-hero">
      <div class="spm-hero-glow"></div>
      <div class="spm-hero-dots"></div>
      <!-- Avatar -->
      <div class="spm-avatar-wrap">
        <div class="spm-avatar" id="sp-modal-avatar"><span>üë§</span></div>
        <div class="spm-avatar-ring"></div>
        <span class="spm-rank-badge" id="sp-modal-rank" style="display:none"></span>
      </div>
      <!-- Name + tier -->
      <h2 class="spm-name" id="sp-modal-name">Player</h2>
      <div class="spm-tier-row" id="sp-modal-tier" style="display:none"></div>
      <div class="spm-badges" id="sp-modal-badges"></div>
    </div>

    <!-- Stats grid -->
    <div class="spm-stats" id="sp-modal-info">
      <p class="text-muted" style="text-align:center;padding:1.5rem 0" data-i18n="spm.loading">Chargement...</p>
    </div>

    <!-- ELO bar -->
    <div class="spm-elo-wrap" id="sp-modal-elo-wrap" style="display:none">
      <div class="spm-elo-bar">
        <div class="spm-elo-fill" id="sp-modal-elo-fill"></div>
      </div>
      <div class="spm-elo-labels">
        <span class="spm-elo-label" id="sp-modal-elo-val"></span>
        <span class="spm-elo-label spm-elo-tier" id="sp-modal-elo-tier"></span>
      </div>
    </div>

    <!-- Achievements preview -->
    <div class="spm-achievements" id="sp-modal-achs" style="display:none">
      <div class="spm-ach-header">
      <span class="spm-ach-title" data-i18n="spectator.modal_achievements">üèÜ Succ√®s</span>
        <span class="spm-ach-count" id="sp-modal-ach-count"></span>
      </div>
      <div class="spm-ach-list" id="sp-modal-ach-list"></div>
    </div>

    <!-- Footer -->
    <div class="spm-footer">
      <a id="sp-modal-link" href="#" onclick="return false" class="spm-btn-profile">
        <span class="spm-btn-icon">üìà</span>
        <span data-i18n="spectator.view_profile">Voir le profil complet</span>
        <span class="spm-btn-arrow">‚Üí</span>
      </a>
    </div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ Spectator player modal ‚Äî Premium ‚îÄ‚îÄ
(function() {
  var tierColors = {
    iron: { border: 'rgba(107,114,128,0.5)', glow: 'rgba(107,114,128,0.15)', gradient: 'linear-gradient(135deg, rgba(107,114,128,0.2), rgba(75,85,99,0.1))' },
    bronze: { border: 'rgba(217,119,6,0.5)', glow: 'rgba(217,119,6,0.2)', gradient: 'linear-gradient(135deg, rgba(217,119,6,0.15), rgba(180,83,9,0.08))' },
    silver: { border: 'rgba(203,213,225,0.5)', glow: 'rgba(203,213,225,0.2)', gradient: 'linear-gradient(135deg, rgba(203,213,225,0.12), rgba(148,163,184,0.06))' },
    gold: { border: 'rgba(251,191,36,0.5)', glow: 'rgba(251,191,36,0.25)', gradient: 'linear-gradient(135deg, rgba(251,191,36,0.12), rgba(245,158,11,0.06))' },
    platinum: { border: 'rgba(103,232,249,0.5)', glow: 'rgba(103,232,249,0.2)', gradient: 'linear-gradient(135deg, rgba(103,232,249,0.12), rgba(6,182,212,0.06))' },
    diamond: { border: 'rgba(167,139,250,0.5)', glow: 'rgba(167,139,250,0.3)', gradient: 'linear-gradient(135deg, rgba(167,139,250,0.15), rgba(139,92,246,0.08))' },
    'alpha-wolf': { border: 'rgba(251,191,36,0.5)', glow: 'rgba(251,191,36,0.35)', gradient: 'linear-gradient(135deg, rgba(251,191,36,0.15), rgba(239,68,68,0.1))' }
  };

  function getTierSlug(tierNameEn) {
    if (!tierNameEn) return 'iron';
    return tierNameEn.toLowerCase().replace(/\s+/g, '-');
  }

  window.openSpectatorPlayerModal = async function(el) {
    var playerId = el.dataset.playerId;
    var playerAvatar = el.dataset.playerAvatar;
    var nameEl = el.querySelector('.sp-player-name') || el.querySelector('.sp-grave-name');
    var name = nameEl ? nameEl.textContent : playerId;
    var modal = document.getElementById('spectator-player-modal');

    // Reset
    document.getElementById('sp-modal-name').textContent = name;
    document.getElementById('sp-modal-link').href = '/player/' + playerId;
    document.getElementById('sp-modal-badges').innerHTML = '';
    document.getElementById('sp-modal-info').innerHTML = '<p class="text-muted" style="text-align:center;padding:1.5rem 0">' + webI18n.t('spm.loading') + '</p>';
    document.getElementById('sp-modal-tier').style.display = 'none';
    document.getElementById('sp-modal-rank').style.display = 'none';
    document.getElementById('sp-modal-elo-wrap').style.display = 'none';
    document.getElementById('sp-modal-achs').style.display = 'none';
    document.getElementById('sp-modal-hero').style.background = '';

    // Avatar
    var avatarContainer = document.getElementById('sp-modal-avatar');
    if (playerAvatar) {
      avatarContainer.innerHTML = '<img class="spm-avatar-img" src="' + playerAvatar + '" alt="" />';
    } else {
      var letter = (name || 'P').charAt(0).toUpperCase();
      avatarContainer.innerHTML = '<span class="spm-avatar-letter">' + letter + '</span>';
    }

    modal.classList.add('open');
    document.body.style.overflow = 'hidden';

    // Fake player: show label + hide profile link, no API call
    var isFake = playerId && playerId.startsWith('fake_');
    document.getElementById('sp-modal-link').style.display = isFake ? 'none' : '';
    if (isFake) {
      document.getElementById('sp-modal-info').innerHTML =
        '<div class="spm-fake-notice">' +
          '<span class="spm-fake-icon">ü§ñ</span>' +
          '<span class="spm-fake-text">' + webI18n.t('spm.fake_player') + '</span>' +
          '<span class="spm-fake-sub">' + webI18n.t('spm.fake_player_desc') + '</span>' +
        '</div>';
      return;
    }

    try {
      var res = await fetch('/api/players/' + playerId);
      var result = await res.json();
      if (result.success && result.data) {
        var d = result.data;
        var slug = d.tier ? getTierSlug(d.tier.nameEn) : 'iron';
        var tc = tierColors[slug] || tierColors.iron;

        // Hero gradient per tier
        document.getElementById('sp-modal-hero').style.background = tc.gradient;

        // Avatar glow
        avatarContainer.style.borderColor = tc.border;
        avatarContainer.style.boxShadow = '0 0 24px ' + tc.glow + ', 0 4px 20px rgba(0,0,0,0.4)';

        // Tier badge
        if (d.tier) {
          var tierEl = document.getElementById('sp-modal-tier');
          tierEl.innerHTML = '<span class="spm-tier-chip"><span class="spm-tier-emoji">' + (d.tier.emoji || '') + '</span> ' + (d.tier.name || '') + '</span>';
          tierEl.style.display = '';
        }

        // Rank
        if (d.rank && d.rank <= 10) {
          var rankEl = document.getElementById('sp-modal-rank');
          rankEl.textContent = '#' + d.rank;
          rankEl.style.display = '';
        }

        // Stats grid
        var wr = d.winrate || 0;
        var wrColor = wr >= 60 ? 'var(--color-success)' : wr >= 40 ? 'var(--phase-jour)' : 'var(--color-danger)';
        document.getElementById('sp-modal-info').innerHTML =
          '<div class="spm-stat">' +
            '<span class="spm-stat-val" style="color:var(--color-info)">' + (d.games_played || 0) + '</span>' +
            '<span class="spm-stat-label">' + webI18n.t('spm.stat_games') + '</span>' +
          '</div>' +
          '<div class="spm-stat">' +
            '<span class="spm-stat-val" style="color:var(--color-success)">' + (d.games_won || 0) + '</span>' +
            '<span class="spm-stat-label">' + webI18n.t('spm.stat_wins') + '</span>' +
          '</div>' +
          '<div class="spm-stat">' +
            '<span class="spm-stat-val" style="color:' + wrColor + '">' + wr + '%</span>' +
            '<span class="spm-stat-label">' + webI18n.t('spm.stat_winrate') + '</span>' +
          '</div>' +
          (d.elo ? '<div class="spm-stat"><span class="spm-stat-val" style="color:var(--accent-secondary)">' + d.elo + '</span><span class="spm-stat-label">' + webI18n.t('spm.stat_points') + '</span></div>' : '');

        // ELO bar
        if (d.elo) {
          var eloWrap = document.getElementById('sp-modal-elo-wrap');
          var eloFill = document.getElementById('sp-modal-elo-fill');
          var pct = Math.min(100, Math.max(0, ((d.elo - 100) / 1900) * 100));
          eloFill.style.width = '0%';
          eloFill.className = 'spm-elo-fill spm-elo-fill-' + slug;
          document.getElementById('sp-modal-elo-val').textContent = 'ELO ' + d.elo;
          document.getElementById('sp-modal-elo-tier').textContent = (d.tier ? d.tier.emoji + ' ' + d.tier.name : '');
          eloWrap.style.display = '';
          requestAnimationFrame(function() {
            requestAnimationFrame(function() {
              eloFill.style.width = pct + '%';
            });
          });
        }

        // Achievements
        if (d.achievements && d.achievements.length > 0) {
          var achDiv = document.getElementById('sp-modal-achs');
          document.getElementById('sp-modal-ach-count').textContent = d.achievements.length;
          var achHtml = '';
          var achNames = {
            first_win: webI18n.t('ach.first_win'), veteran: webI18n.t('ach.veteran'), legend: webI18n.t('ach.legend'),
            winning_streak_3: webI18n.t('ach.winning_streak_3'), winning_streak_5: webI18n.t('ach.winning_streak_5'),
            first_blood: webI18n.t('ach.first_blood'), alpha_wolf: webI18n.t('ach.alpha_wolf'), serial_killer: webI18n.t('ach.serial_killer'),
            village_hero: webI18n.t('ach.village_hero'), sherlock: webI18n.t('ach.sherlock'), guardian_angel: webI18n.t('ach.guardian_angel'),
            witch_master: webI18n.t('ach.witch_master'), sharpshooter: webI18n.t('ach.sharpshooter'),
            romeo_juliet: webI18n.t('ach.romeo_juliet'), survivor: webI18n.t('ach.survivor'), immortal: webI18n.t('ach.immortal'),
            popular: webI18n.t('ach.popular'), clown_prince: webI18n.t('ach.clown_prince'), elder_wisdom: webI18n.t('ach.elder_wisdom')
          };
          d.achievements.slice(0, 6).forEach(function(a) {
            achHtml += '<div class="spm-ach-chip" title="' + (achNames[a.id] || a.id) + '">' + (a.emoji || 'üèÖ') + '</div>';
          });
          if (d.achievements.length > 6) {
            achHtml += '<div class="spm-ach-chip spm-ach-more">+' + (d.achievements.length - 6) + '</div>';
          }
          document.getElementById('sp-modal-ach-list').innerHTML = achHtml;
          achDiv.style.display = '';
        }
      } else {
        document.getElementById('sp-modal-info').innerHTML = '<p class="text-muted" style="text-align:center;padding:1rem 0">' + webI18n.t('spm.no_stats') + '</p>';
      }
    } catch(e) {
      document.getElementById('sp-modal-info').innerHTML = '<p class="text-muted" style="text-align:center;padding:1rem 0">' + webI18n.t('spm.load_error') + '</p>';
    }
  };

  window.closeSpectatorPlayerModal = function() {
    document.getElementById('spectator-player-modal').classList.remove('open');
    document.body.style.overflow = '';
  };
  document.addEventListener('keydown', function(e) { if (e.key === 'Escape') closeSpectatorPlayerModal(); });
})();
</script>

<script src="/static/js/spectator.js"></script>
<%- include('partials/footer') %>
