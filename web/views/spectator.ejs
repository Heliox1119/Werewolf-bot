<%- include('partials/header') %>

<div class="sp-page" data-game-id="<%= gameId %>">

  <!-- Ambient orbs (red/crimson live feel) -->
  <div class="sp-ambient" aria-hidden="true">
    <div class="sp-orb sp-orb-1"></div>
    <div class="sp-orb sp-orb-2"></div>
    <div class="sp-orb sp-orb-3"></div>
  </div>

  <!-- â•â•â• TOP BAR â•â•â• -->
  <div class="sp-topbar">
    <div class="sp-topbar-left">
      <a href="<%= game.guildId ? '/guild/' + game.guildId : '/' %>" class="sp-back-btn">â† Retour</a>
      <div class="sp-live-indicator">
        <span class="sp-live-dot"></span>
        <span>LIVE</span>
      </div>
    </div>
    <div class="sp-topbar-center">
      <h1 class="sp-title"><%= game.guildName || game.guildId %></h1>
    </div>
    <div class="sp-topbar-right">
      <div class="sp-phase-container">
        <span class="sp-phase game-phase phase-<%= (game.phase || 'lobby').toLowerCase() %>" id="game-phase"><%= game.phase || 'Lobby' %></span>
        <% if (game.subPhase) { %><span class="sp-subphase" id="game-subphase"><%= game.subPhase %></span><% } else { %><span class="sp-subphase" id="game-subphase"></span><% } %>
      </div>
      <span class="sp-day" id="game-day"><%= game.dayCount ? 'Jour ' + game.dayCount : '' %></span>
      <span class="sp-viewers" id="spectator-count">ğŸ‘ <span>0</span></span>
    </div>
  </div>

  <!-- â•â•â• MAIN GRID â•â•â• -->
  <div class="sp-grid">

    <!-- LEFT â€” Players & Graveyard -->
    <div class="sp-col-left">
      <div class="sp-panel sp-panel-players" style="animation: panelEnter 0.5s ease-out both; animation-delay: 0.1s;">
        <div class="sp-panel-header">
          <h3 class="sp-panel-title">âš”ï¸ Joueurs</h3>
          <span class="sp-alive-badge" id="alive-count-badge"><span id="alive-count"><%= game.players ? game.players.filter(function(p) { return p.alive; }).length : 0 %></span> vivants</span>
        </div>
        <div class="sp-player-list" id="player-list">
          <% if (game.players) { game.players.forEach(function(p, i) { %>
            <div class="sp-player <%= p.alive ? 'sp-alive' : 'sp-dead' %> clickable-player" data-player-id="<%= p.id %>" data-player-avatar="<%= p.avatar || '' %>" onclick="openSpectatorPlayerModal(this)" style="animation-delay:<%= 0.15 + i * 0.04 %>s">
              <div class="sp-player-avatar-wrap">
                <% if (p.avatar) { %>
                  <img class="sp-player-avatar" src="<%= p.avatar %>" alt="" />
                <% } else { %>
                  <span class="sp-player-avatar sp-player-avatar-default">ğŸ‘¤</span>
                <% } %>
                <% if (p.alive) { %><span class="sp-avatar-status sp-status-alive"></span><% } else { %><span class="sp-avatar-status sp-status-dead"></span><% } %>
              </div>
              <div class="sp-player-info">
                <span class="sp-player-name"><%= p.username || p.id %></span>
                <div class="sp-player-tags">
                  <% if (!p.alive && p.role) { %><span class="sp-role-tag"><%= p.role %></span><% } %>
                  <% if (p.isCaptain) { %><span class="sp-badge-tag">ğŸ‘‘ Capitaine</span><% } %>
                  <% if (p.inLove) { %><span class="sp-badge-tag sp-badge-love">ğŸ’•</span><% } %>
                </div>
              </div>
              <span class="sp-player-chevron">â€º</span>
            </div>
          <% }); } %>
        </div>

        <% if (game.dead && game.dead.length > 0) { %>
          <div class="sp-graveyard-divider">
            <span>â˜ ï¸ CimetiÃ¨re (<%= game.dead.length %>)</span>
          </div>
          <div class="sp-graveyard" id="graveyard">
            <% game.dead.forEach(function(d, i) { %>
              <div class="sp-grave clickable-player" data-player-id="<%= d.id %>" data-player-avatar="<%= d.avatar || '' %>" onclick="openSpectatorPlayerModal(this)" style="animation-delay:<%= 0.3 + i * 0.04 %>s">
                <% if (d.avatar) { %>
                  <img class="sp-grave-avatar" src="<%= d.avatar %>" alt="" />
                <% } else { %>
                  <span class="sp-grave-avatar sp-grave-avatar-default">â˜ ï¸</span>
                <% } %>
                <span class="sp-grave-name"><%= d.username || d.id %></span>
                <span class="sp-grave-role"><%= d.role || '?' %></span>
                <span class="sp-player-chevron">â€º</span>
              </div>
            <% }); %>
          </div>
        <% } %>
      </div>
    </div>

    <!-- CENTER â€” Event Feed -->
    <div class="sp-col-center">
      <div class="sp-panel sp-panel-feed" style="animation: panelEnter 0.5s ease-out both; animation-delay: 0.2s;">
        <div class="sp-panel-header">
          <h3 class="sp-panel-title">ğŸ“¡ Ã‰vÃ©nements en direct</h3>
          <span class="sp-feed-pulse"></span>
        </div>
        <div class="sp-feed" id="event-feed">
          <div class="sp-event sp-ev-info">
            <span class="sp-ev-time"><%= new Date().toLocaleTimeString() %></span>
            <span class="sp-ev-icon">ğŸ“¡</span>
            <span class="sp-ev-text">ConnectÃ© au flux spectateur en temps rÃ©el</span>
          </div>
          <% if (game.actionLog) { game.actionLog.slice(-10).forEach(function(log) { %>
            <div class="sp-event sp-ev-action">
              <span class="sp-ev-time"><%= log.timestamp ? new Date(log.timestamp).toLocaleTimeString() : '' %></span>
              <span class="sp-ev-icon">ğŸ“</span>
              <span class="sp-ev-text"><%= log.action %></span>
            </div>
          <% }); } %>
        </div>
      </div>

      <!-- Votes (if any) -->
      <% if (game.votes && Object.keys(game.votes).length > 0) { %>
      <div class="sp-panel sp-panel-votes" style="animation: panelEnter 0.5s ease-out both; animation-delay: 0.3s;">
        <div class="sp-panel-header">
          <h3 class="sp-panel-title">ğŸ—³ï¸ Votes en cours</h3>
          <span class="sp-vote-count"><%= Object.keys(game.votes).length %> exprimÃ©s</span>
        </div>
        <div class="sp-votes" id="vote-display">
          <%
            var voteCounts = {};
            Object.values(game.votes).forEach(function(target) {
              voteCounts[target] = (voteCounts[target] || 0) + 1;
            });
            var sortedVotes = Object.entries(voteCounts).sort(function(a, b) { return b[1] - a[1]; });
            var maxV = sortedVotes.length > 0 ? sortedVotes[0][1] : 1;
            sortedVotes.forEach(function(entry) {
              var targetId = entry[0];
              var vCount = entry[1];
              var targetPlayer = (game.players || []).find(function(p) { return p.id === targetId; });
              var targetName = targetPlayer ? targetPlayer.username : targetId;
              var targetAvatar = targetPlayer ? targetPlayer.avatar : null;
              var pct = Math.round((vCount / maxV) * 100);
          %>
            <div class="sp-vote-row">
              <div class="sp-vote-target">
                <% if (targetAvatar) { %><img class="sp-vote-avatar" src="<%= targetAvatar %>" alt="" /><% } %>
                <span><%= targetName %></span>
              </div>
              <div class="sp-vote-bar">
                <div class="sp-vote-bar-fill" style="width:<%= pct %>%"></div>
              </div>
              <span class="sp-vote-num"><%= vCount %></span>
            </div>
          <% }); %>
        </div>
      </div>
      <% } %>
    </div>

    <!-- RIGHT â€” Game Info -->
    <div class="sp-col-right">
      <div class="sp-panel sp-panel-info" style="animation: panelEnter 0.5s ease-out both; animation-delay: 0.25s;">
        <div class="sp-panel-header">
          <h3 class="sp-panel-title">ğŸ“Š Infos</h3>
        </div>
        <div class="sp-info-grid">
          <div class="sp-info-card">
            <span class="sp-info-icon">ğŸ®</span>
            <div class="sp-info-data">
              <span class="sp-info-val"><%= game.players ? game.players.length : 0 %></span>
              <span class="sp-info-label">Joueurs</span>
            </div>
          </div>
          <div class="sp-info-card">
            <span class="sp-info-icon">ğŸ’š</span>
            <div class="sp-info-data">
              <span class="sp-info-val" id="info-alive"><%= game.players ? game.players.filter(function(p) { return p.alive; }).length : 0 %></span>
              <span class="sp-info-label">Vivants</span>
            </div>
          </div>
          <div class="sp-info-card">
            <span class="sp-info-icon">ğŸ’€</span>
            <div class="sp-info-data">
              <span class="sp-info-val"><%= game.dead ? game.dead.length : 0 %></span>
              <span class="sp-info-label">Morts</span>
            </div>
          </div>
          <div class="sp-info-card">
            <span class="sp-info-icon">ğŸ“…</span>
            <div class="sp-info-data">
              <span class="sp-info-val" id="game-started"><%= game.startedAt ? new Date(game.startedAt).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : 'â€”' %></span>
              <span class="sp-info-label">DÃ©marrÃ©</span>
            </div>
          </div>
        </div>

        <% if (game.rules) { %>
        <div class="sp-rules-section">
          <div class="sp-rules-title">âš™ï¸ RÃ¨gles</div>
          <div class="sp-rules-row">
            <span>Joueurs</span>
            <span><%= game.rules.minPlayers %>â€“<%= game.rules.maxPlayers %></span>
          </div>
        </div>
        <% } %>

        <div class="sp-gameid-section">
          <span class="sp-gameid-label">Game ID</span>
          <span class="sp-gameid-val"><%= gameId %></span>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Player Quick Modal (Spectator) -->
<div class="modal-overlay" id="spectator-player-modal" onclick="if(event.target===this)closeSpectatorPlayerModal()">
  <div class="modal-card modal-card-sm">
    <button class="modal-close" onclick="closeSpectatorPlayerModal()">&times;</button>
    <div class="modal-header" id="sp-modal-header">
      <div class="modal-player-avatar" id="sp-modal-avatar"><span>ğŸ‘¤</span></div>
      <div>
        <h2 id="sp-modal-name">Player</h2>
        <div id="sp-modal-badges"></div>
      </div>
    </div>
    <div class="modal-body">
      <div class="modal-info-grid" id="sp-modal-info">
        <p class="text-muted" style="text-align:center">Chargement...</p>
      </div>
    </div>
    <div class="modal-footer">
      <a id="sp-modal-link" href="#" class="btn btn-sm btn-primary">ğŸ“ˆ Voir le profil complet</a>
    </div>
  </div>
</div>

<script>
// Spectator player modal
window.openSpectatorPlayerModal = async function(el) {
  var playerId = el.dataset.playerId;
  var playerAvatar = el.dataset.playerAvatar;
  var nameEl = el.querySelector('.sp-player-name') || el.querySelector('.sp-grave-name');
  var name = nameEl ? nameEl.textContent : playerId;
  var modal = document.getElementById('spectator-player-modal');
  
  document.getElementById('sp-modal-name').textContent = name;
  document.getElementById('sp-modal-link').href = '/player/' + playerId;
  document.getElementById('sp-modal-badges').innerHTML = '';
  document.getElementById('sp-modal-info').innerHTML = '<p class="text-muted" style="text-align:center">Chargement...</p>';
  
  var avatarContainer = document.getElementById('sp-modal-avatar');
  if (playerAvatar) {
    avatarContainer.innerHTML = '<img class="modal-avatar-img" src="' + playerAvatar + '" alt="" />';
  } else {
    avatarContainer.innerHTML = '<span>ğŸ‘¤</span>';
  }
  
  modal.classList.add('open');
  document.body.style.overflow = 'hidden';

  try {
    var res = await fetch('/api/players/' + playerId);
    var result = await res.json();
    if (result.success && result.data) {
      var d = result.data;
      document.getElementById('sp-modal-info').innerHTML =
        '<div class="modal-info-row"><span class="info-label">Parties</span><span class="info-value">' + (d.games_played || 0) + '</span></div>' +
        '<div class="modal-info-row"><span class="info-label">Victoires</span><span class="info-value">' + (d.games_won || 0) + '</span></div>' +
        '<div class="modal-info-row"><span class="info-label">Win rate</span><span class="info-value">' + (d.winrate || 0) + '%</span></div>' +
        (d.elo ? '<div class="modal-info-row"><span class="info-label">ELO</span><span class="info-value">' + d.elo + '</span></div>' : '') +
        (d.tier ? '<div class="modal-info-row"><span class="info-label">Rang</span><span class="info-value">' + (d.tier.emoji || '') + ' ' + (d.tier.name || '') + '</span></div>' : '');
    } else {
      document.getElementById('sp-modal-info').innerHTML = '<p class="text-muted" style="text-align:center">Aucune statistique disponible</p>';
    }
  } catch(e) {
    document.getElementById('sp-modal-info').innerHTML = '<p class="text-muted" style="text-align:center">Impossible de charger les stats</p>';
  }
};
window.closeSpectatorPlayerModal = function() {
  document.getElementById('spectator-player-modal').classList.remove('open');
  document.body.style.overflow = '';
};
document.addEventListener('keydown', function(e) { if (e.key === 'Escape') closeSpectatorPlayerModal(); });
</script>

<script src="/static/js/spectator.js"></script>
<%- include('partials/footer') %>
