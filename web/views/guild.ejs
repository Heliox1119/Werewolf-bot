<%- include('partials/header') %>

<!-- â•â•â• GUILD HERO â•â•â• -->
<section class="go-hero">
  <div class="go-hero-bg">
    <div class="go-hero-gradient"></div>
    <div class="go-hero-dots"></div>
    <div class="go-hero-scanline"></div>
  </div>
  <div class="go-hero-inner">
    <div class="go-hero-left">
      <div class="go-hero-avatar-wrap">
        <% if (guild && guild.icon) { %>
          <img src="<%= guild.icon %>" alt="<%= guild.name %>" class="go-hero-avatar">
        <% } else { %>
          <div class="go-hero-avatar go-hero-avatar-placeholder">ğŸ°</div>
        <% } %>
        <div class="go-avatar-ring"></div>
        <div class="go-avatar-ring go-avatar-ring-lg"></div>
      </div>
      <div class="go-hero-info">
        <h1 class="go-hero-title"><%= guild ? guild.name : 'Guild ' + guildId %></h1>
        <p class="go-hero-subtitle">Vue d'ensemble Â· Statistiques & ActivitÃ©</p>
        <div class="go-hero-tags">
          <% if (guild && guild.memberCount) { %>
            <div class="go-hero-tag go-tag-members">
              <span>ğŸ‘¥</span> <%= guild.memberCount %> membres
            </div>
          <% } %>
          <div class="go-hero-tag go-tag-games">
            <span>ğŸ®</span> <%= guildStats.totalGames %> parties jouÃ©es
          </div>
          <% if (guildStats.activeGames > 0) { %>
            <div class="go-hero-tag go-tag-live">
              <span class="status-beacon"></span> <%= guildStats.activeGames %> en cours
            </div>
          <% } %>
        </div>
      </div>
    </div>
    <div class="go-hero-metrics">
      <div class="go-metric" style="--i:0">
        <div class="go-metric-icon gm-purple">ğŸ†</div>
        <div class="go-metric-data">
          <span class="go-metric-val counter" data-target="<%= guildStats.totalGames %>">0</span>
          <span class="go-metric-label">Total parties</span>
        </div>
      </div>
      <div class="go-metric" style="--i:1">
        <div class="go-metric-icon gm-green">ğŸ¡</div>
        <div class="go-metric-data">
          <span class="go-metric-val counter" data-target="<%= guildStats.villageWins %>">0</span>
          <span class="go-metric-label">Victoires Village</span>
        </div>
      </div>
      <div class="go-metric" style="--i:2">
        <div class="go-metric-icon gm-red">ğŸº</div>
        <div class="go-metric-data">
          <span class="go-metric-val counter" data-target="<%= guildStats.wolfWins %>">0</span>
          <span class="go-metric-label">Victoires Loups</span>
        </div>
      </div>
      <div class="go-metric" style="--i:3">
        <div class="go-metric-icon gm-pink">ğŸ’•</div>
        <div class="go-metric-data">
          <span class="go-metric-val counter" data-target="<%= guildStats.loversWins %>">0</span>
          <span class="go-metric-label">Victoires Amoureux</span>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- â•â•â• SECONDARY STATS BAR â•â•â• -->
<div class="go-stats-bar">
  <div class="go-stat-chip">
    <span class="go-stat-chip-icon">ğŸ‘¥</span>
    <div class="go-stat-chip-data">
      <span class="go-stat-chip-val counter" data-target="<%= guildStats.avgPlayers %>">0</span>
      <span class="go-stat-chip-label">Joueurs / partie</span>
    </div>
  </div>
  <div class="go-stat-chip">
    <span class="go-stat-chip-icon">â±ï¸</span>
    <div class="go-stat-chip-data">
      <% var avgMin = Math.floor(guildStats.avgDuration / 60); %>
      <span class="go-stat-chip-val counter" data-target="<%= avgMin %>">0</span>
      <span class="go-stat-chip-label">min en moyenne</span>
    </div>
  </div>
  <div class="go-stat-chip">
    <span class="go-stat-chip-icon">ğŸ“Š</span>
    <div class="go-stat-chip-data">
      <%
        var total = guildStats.villageWins + guildStats.wolfWins + guildStats.loversWins;
        var winRate = total > 0 ? Math.round(guildStats.villageWins / total * 100) : 0;
      %>
      <span class="go-stat-chip-val"><%= winRate %><small>%</small></span>
      <span class="go-stat-chip-label">Taux village</span>
    </div>
  </div>
  <% if (guildStats.totalGames > 0) { %>
  <div class="go-stat-chip">
    <span class="go-stat-chip-icon">ğŸ“ˆ</span>
    <div class="go-stat-chip-data">
      <span class="go-stat-chip-val"><%= Math.round(guildStats.wolfWins / (total || 1) * 100) %><small>%</small></span>
      <span class="go-stat-chip-label">Taux loups</span>
    </div>
  </div>
  <% } %>
</div>

<!-- â•â•â• WIN DISTRIBUTION BAR â•â•â• -->
<% if (guildStats.totalGames > 0) { %>
<div class="go-winbar-panel" style="--enter:0">
  <div class="go-winbar-head">
    <span class="go-winbar-title">ğŸ RÃ©partition des victoires</span>
  </div>
  <div class="go-winbar">
    <%
      var vPct = total > 0 ? (guildStats.villageWins / total * 100).toFixed(1) : 0;
      var wPct = total > 0 ? (guildStats.wolfWins / total * 100).toFixed(1) : 0;
      var lPct = total > 0 ? (guildStats.loversWins / total * 100).toFixed(1) : 0;
    %>
    <div class="go-winbar-seg go-winbar-village" style="width:<%= vPct %>%" title="Village <%= vPct %>%">
      <span>ğŸ¡ <%= vPct %>%</span>
    </div>
    <div class="go-winbar-seg go-winbar-wolves" style="width:<%= wPct %>%" title="Loups <%= wPct %>%">
      <span>ğŸº <%= wPct %>%</span>
    </div>
    <% if (parseFloat(lPct) > 0) { %>
    <div class="go-winbar-seg go-winbar-lovers" style="width:<%= lPct %>%" title="Amoureux <%= lPct %>%">
      <span>ğŸ’• <%= lPct %>%</span>
    </div>
    <% } %>
  </div>
  <div class="go-winbar-legend">
    <span class="go-legend-item"><span class="go-legend-dot go-legend-village"></span> Village</span>
    <span class="go-legend-item"><span class="go-legend-dot go-legend-wolves"></span> Loups-Garous</span>
    <span class="go-legend-item"><span class="go-legend-dot go-legend-lovers"></span> Amoureux</span>
  </div>
</div>
<% } %>

<!-- â•â•â• MAIN GRID â•â•â• -->
<div class="go-grid">
  <div class="go-main">

    <!-- Live Games Panel -->
    <div class="dash-panel go-panel" style="--enter:0">
      <div class="dash-panel-head">
        <div class="dash-panel-title"><span class="pulse-dot"></span> Parties en cours</div>
        <span class="badge-count"><%= games.length %></span>
      </div>
      <div class="games-grid">
        <% if (games.length === 0) { %>
          <div class="empty-state">
            <div class="empty-visual">
              <span class="empty-icon-lg">ğŸŒ™</span>
              <div class="empty-glow-ring"></div>
            </div>
            <p class="empty-title">Le village dort paisiblement</p>
            <p class="empty-sub text-muted">Les parties apparaÃ®tront ici en temps rÃ©el</p>
          </div>
        <% } else { games.forEach(function(g) {
            var alive = g.players ? g.players.filter(function(p) { return p.alive; }).length : 0;
            var dead = g.dead ? g.dead.length : (g.players ? g.players.filter(function(p) { return !p.alive; }).length : 0);
            var gtotal = alive + dead;
            var pct = gtotal > 0 ? Math.round(alive / gtotal * 100) : 100;
        %>
          <a href="/game/<%= g.gameId %>" class="game-card" data-game="<%= g.gameId %>">
            <div class="game-card-header">
              <span class="game-phase phase-<%= (g.phase || 'lobby').toLowerCase() %>"><%= g.phase || 'Lobby' %></span>
              <span class="game-day"><%= g.dayCount ? 'Jour ' + g.dayCount : '' %></span>
            </div>
            <div class="game-card-body">
              <div class="game-players">
                <span class="alive-count">â¤ï¸ <%= alive %> vivants</span>
                <span class="dead-count">â˜ ï¸ <%= dead %> morts</span>
              </div>
              <div class="game-hp-bar">
                <div class="game-hp-fill" style="width: <%= pct %>%"></div>
              </div>
              <% if (g.players && g.players.length > 0) { %>
                <div class="game-card-player-list">
                  <% g.players.slice(0, 6).forEach(function(p) { %>
                    <span class="game-mini-player <%= p.alive ? '' : 'dead' %>" title="<%= p.username %>"><%= p.username %></span>
                  <% }); %>
                  <% if (g.players.length > 6) { %>
                    <span class="game-mini-more">+<%= g.players.length - 6 %></span>
                  <% } %>
                </div>
              <% } %>
              <% if (g.subPhase) { %>
                <div class="game-subphase-tag"><%= g.subPhase %></div>
              <% } %>
            </div>
            <div class="game-card-footer">
              <span class="spectate-btn">ğŸ‘ï¸ Regarder en direct</span>
            </div>
          </a>
        <% }); } %>
      </div>
    </div>

    <!-- Top Players Panel -->
    <div class="dash-panel go-panel" style="--enter:1">
      <div class="dash-panel-head">
        <div class="dash-panel-title">ğŸ† Meilleurs joueurs</div>
        <a href="/guild/<%= guildId %>/leaderboard" class="go-see-all">Voir tout â†’</a>
      </div>
      <% if (leaderboard.length === 0) { %>
        <div class="empty-state">
          <div class="empty-visual">
            <span class="empty-icon-lg">ğŸ†</span>
            <div class="empty-glow-ring"></div>
          </div>
          <p class="empty-title">Aucun joueur classÃ©</p>
          <p class="empty-sub text-muted">Les classements apparaÃ®tront aprÃ¨s la premiÃ¨re partie</p>
        </div>
      <% } else { %>
        <div class="go-leaderboard">
          <% leaderboard.forEach(function(p, i) { %>
            <a href="/player/<%= p.player_id %>" class="go-player-row" style="--delay:<%= i * 0.06 %>s">
              <div class="go-player-rank rank-<%= p.rank %>">#<%= p.rank %></div>
              <div class="go-player-info">
                <span class="go-player-name"><%= p.username || p.player_id %></span>
                <span class="go-player-tier tier tier-<%= (p.tier || {}).id || 'bronze' %>"><%= (p.tier || {}).emoji || '' %> <%= (p.tier || {}).name || 'Bronze' %></span>
              </div>
              <div class="go-player-elo">
                <span class="go-player-elo-val"><%= p.elo_rating || 1000 %></span>
                <span class="go-player-elo-label">Points</span>
              </div>
              <div class="go-player-record">
                <span class="go-player-wins"><%= p.games_won || 0 %> <small>victoires</small></span>
                <span class="go-player-total"><%= p.games_played || 0 %> <small>parties</small></span>
              </div>
              <span class="go-player-arrow">â€º</span>
            </a>
          <% }); %>
        </div>
      <% } %>
    </div>

    <!-- Recent Games Panel -->
    <div class="dash-panel go-panel" style="--enter:2">
      <div class="dash-panel-head">
        <div class="dash-panel-title">ğŸ“œ Parties rÃ©centes</div>
        <a href="/guild/<%= guildId %>/history" class="go-see-all">Voir tout â†’</a>
      </div>
      <% if (history.length === 0) { %>
        <div class="empty-state">
          <div class="empty-visual">
            <span class="empty-icon-lg">ğŸ“œ</span>
            <div class="empty-glow-ring"></div>
          </div>
          <p class="empty-title">Aucune partie terminÃ©e</p>
          <p class="empty-sub text-muted">L'historique s'affichera ici</p>
        </div>
      <% } else { %>
        <div class="go-history">
          <% history.forEach(function(h, i) { %>
            <div class="go-history-row" style="--delay:<%= i * 0.06 %>s">
              <div class="go-history-winner">
                <% if (h.winner === 'village') { %>
                  <span class="go-winner-badge go-winner-village">ğŸ¡ Village</span>
                <% } else if (h.winner === 'wolves') { %>
                  <span class="go-winner-badge go-winner-wolves">ğŸº Loups</span>
                <% } else if (h.winner === 'lovers') { %>
                  <span class="go-winner-badge go-winner-lovers">ğŸ’• Amoureux</span>
                <% } else { %>
                  <span class="go-winner-badge"><%= h.winner || '?' %></span>
                <% } %>
              </div>
              <div class="go-history-stats">
                <span class="go-history-stat">ğŸ‘¥ <%= h.player_count || '?' %></span>
                <span class="go-history-stat">ğŸ“… <%= h.day_count || 0 %>j</span>
                <% if (h.duration_seconds) { %>
                  <span class="go-history-stat">â±ï¸ <%= Math.floor(h.duration_seconds / 60) %>min</span>
                <% } %>
              </div>
              <div class="go-history-date">
                <%= h.ended_at ? new Date(h.ended_at).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short', year: 'numeric' }) : '' %>
              </div>
            </div>
          <% }); %>
        </div>
      <% } %>
    </div>
  </div>

  <!-- Sidebar -->
  <aside class="go-sidebar">
    <!-- Quick Navigation -->
    <div class="sidebar-panel go-panel" style="--enter:1">
      <h3 class="panel-title">âš¡ Navigation</h3>
      <div class="go-nav-links">
        <a href="/guild/<%= guildId %>/leaderboard" class="go-nav-link">
          <span class="go-nav-link-icon" style="background:rgba(245,158,11,0.12)">ğŸ†</span>
          <div class="go-nav-link-body">
            <span class="go-nav-link-title">Classement</span>
            <span class="go-nav-link-desc">Classement complet et points</span>
          </div>
          <span class="go-nav-link-arrow">â€º</span>
        </a>
        <a href="/guild/<%= guildId %>/history" class="go-nav-link">
          <span class="go-nav-link-icon" style="background:rgba(59,130,246,0.12)">ğŸ“œ</span>
          <div class="go-nav-link-body">
            <span class="go-nav-link-title">Historique</span>
            <span class="go-nav-link-desc">Toutes les parties jouÃ©es</span>
          </div>
          <span class="go-nav-link-arrow">â€º</span>
        </a>
        <a href="/guild/<%= guildId %>/rules" class="go-nav-link">
          <span class="go-nav-link-icon" style="background:rgba(139,92,246,0.12)">âš™ï¸</span>
          <div class="go-nav-link-body">
            <span class="go-nav-link-title">RÃ¨gles du jeu</span>
            <span class="go-nav-link-desc">RÃ´les et paramÃ¨tres</span>
          </div>
          <span class="go-nav-link-arrow">â€º</span>
        </a>
        <a href="/guild/<%= guildId %>/moderation" class="go-nav-link">
          <span class="go-nav-link-icon" style="background:rgba(239,68,68,0.12)">ğŸ›¡ï¸</span>
          <div class="go-nav-link-body">
            <span class="go-nav-link-title">ModÃ©ration</span>
            <span class="go-nav-link-desc">GÃ©rer les parties en cours</span>
          </div>
          <span class="go-nav-link-arrow">â€º</span>
        </a>
      </div>
    </div>

    <!-- Server Info -->
    <div class="sidebar-panel go-panel" style="--enter:2">
      <h3 class="panel-title">ğŸ”® Informations</h3>
      <div class="go-info-grid">
        <div class="go-info-row">
          <span class="go-info-label">Parties totales</span>
          <span class="go-info-value"><%= guildStats.totalGames %></span>
        </div>
        <div class="go-info-row">
          <span class="go-info-label">En cours</span>
          <span class="go-info-value go-info-live"><%= guildStats.activeGames %></span>
        </div>
        <div class="go-info-row">
          <span class="go-info-label">Joueurs moyens</span>
          <span class="go-info-value"><%= guildStats.avgPlayers %></span>
        </div>
        <div class="go-info-row">
          <span class="go-info-label">DurÃ©e moyenne</span>
          <span class="go-info-value"><%= avgMin %> min</span>
        </div>
        <% if (guild && guild.memberCount) { %>
        <div class="go-info-row">
          <span class="go-info-label">Membres</span>
          <span class="go-info-value"><%= guild.memberCount %></span>
        </div>
        <% } %>
      </div>
    </div>
  </aside>
</div>

<script>
// Counter animation for guild overview
(function() {
  const counters = document.querySelectorAll('.go-hero .counter, .go-stats-bar .counter');
  if (!counters.length) return;
  function easeOutExpo(t) { return t === 1 ? 1 : 1 - Math.pow(2, -10 * t); }
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (!entry.isIntersecting) return;
      const el = entry.target;
      observer.unobserve(el);
      const target = parseInt(el.dataset.target, 10) || 0;
      if (target === 0) { el.textContent = '0'; return; }
      const duration = 1800;
      const start = performance.now();
      function tick(now) {
        const t = Math.min((now - start) / duration, 1);
        el.textContent = Math.round(easeOutExpo(t) * target).toLocaleString('fr-FR');
        if (t < 1) requestAnimationFrame(tick);
      }
      requestAnimationFrame(tick);
    });
  }, { threshold: 0.3 });
  counters.forEach(c => observer.observe(c));
})();
</script>

<%- include('partials/footer') %>
